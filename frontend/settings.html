/**
 * File: settings.html
 * Location: frontend/settings.html
 * Purpose: StockPilot Settings page with eBay integration and database management
 * Author: StockPilot Development Team
 * Last Modified: July 16, 2025
 */

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPilot - Settings</title>
    <style>
        /* Research-Based Slate Theme for Settings */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            min-height: 100vh;
        }

        /* Main Container with Integrated Navigation */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(45, 55, 72, 0.15);
            overflow: hidden;
        }

        /* Navigation Tabs - Integrated into container */
        .nav-tabs-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px 0;
            position: relative;
        }

        .nav-tabs-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #2D3748;
            z-index: 1;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 2px;
            background: transparent;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .nav-tab {
            background: linear-gradient(135deg, #F5F7FA, #E2E8F0);
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #2D3748;
            font-weight: 500;
            font-size: 13px;
            border-radius: 12px 12px 0 0;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;script
        }

        .nav-tab:hover {
            text-decoration: none;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(45, 55, 72, 0.2);
        }

        .nav-tab.active {
            transform: translateY(0);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .nav-tab.home {
            background: linear-gradient(135deg, #8E9AAE, #718096);
            color: white;
        }

        .nav-tab.purchases {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .nav-tab.inventory {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
        }

        .nav-tab.consumables {
            background: linear-gradient(135deg, #A67C5A, #8B6F3F);
            color: white;
        }

        .nav-tab.log-sale {
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
        }

        .nav-tab.sales {
            background: linear-gradient(135deg, #8B7EC8, #7B6CB8);
            color: white;
        }

        .nav-tab.email-import {
            background: linear-gradient(135deg, #5D6AAF, #4A5A9E);
            color: white;
        }

        .nav-tab.reports {
            background: linear-gradient(135deg, #667EEA, #5A67D8);
            color: white;
        }

        .nav-tab.settings {
            background: linear-gradient(135deg, #2D3748, #1A202C);
            color: white;
        }

        /* Content Area */
        .content-area {
            padding: 30px;
            background: #F8FAFC;
        }

        .header {
            text-align: center;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px 10px 30px;
        }

        .header h1 {
            color: #2D3748;
            margin-bottom: 5px;
            font-size: 1.8em;
        }

        .header p {
            margin: 0;
            font-size: 0.9em;
            color: #8E9AAE;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(45, 55, 72, 0.08);
        }

        .settings-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f7fafc;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .settings-tab:hover {
            background: #e2e8f0;
        }

        .settings-tab.active {
            background: #2D3748;
            color: white;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Connection Status */
        .connection-status {
            background: #E3F2FD;
            color: #1565C0;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #BBDEFB;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .connection-status.online {
            background: #E8F5E8;
            color: #2E7D32;
            border-color: #C8E6C9;
        }

        .connection-status.offline {
            background: #FFF3E0;
            color: #EF6C00;
            border-color: #FFCC80;
        }

        .connection-badge {
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .connection-badge.online {
            background: #059669;
        }

        .connection-badge.offline {
            background: #dc2626;
        }

        .connection-badge.testing {
            background: #f59e0b;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(45, 55, 72, 0.08);
            margin-bottom: 20px;
        }

        .settings-section-header {
            background: #2D3748;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-section-content {
            padding: 25px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2D3748;
            font-size: 0.95em;
        }

        .setting-group input, .setting-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            background: #FFFFFF;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .setting-group input:focus, .setting-group select:focus {
            outline: none;
            border-color: #2D3748;
            box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.1);
        }

        /* eBay Integration Styles */
        .ebay-status {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ebay-status.connected {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border-color: #16a34a;
            color: #166534;
        }

        .ebay-status.disconnected {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            border-color: #dc2626;
            color: #991b1b;
        }

        .ebay-status.testing {
            background: linear-gradient(135deg, #fefce8, #fef3c7);
            border-color: #ca8a04;
            color: #92400e;
        }

        .ebay-sync-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 0.9em;
            color: #0369a1;
        }

        /* Database Management Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .table-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
        }

        .table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-item:last-child {
            border-bottom: none;
        }

        .table-info {
            flex: 1;
        }

        .table-name {
            font-weight: 600;
            color: #2d3748;
        }

        .table-rows {
            font-size: 12px;
            color: #718096;
        }

        /* Button Styles */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #E2E8F0;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-preview:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .theme-option {
            padding: 15px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .theme-option:hover {
            border-color: #2D3748;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 55, 72, 0.2);
        }

        .theme-option.active {
            border-color: #2D3748;
            background: rgba(45, 55, 72, 0.1);
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 4px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
        }

        .theme-name {
            font-size: 0.85em;
            font-weight: 500;
            color: #2D3748;
        }

        .btn-save {
            background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-save:hover {
            background: linear-gradient(135deg, #1A202C 0%, #0F1419 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 55, 72, 0.3);
        }

        .btn-reset {
            background: #E2E8F0;
            color: #2D3748;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .btn-reset:hover {
            background: #CBD5E0;
            transform: translateY(-1px);
        }

        .success {
            background: #E8F5E8;
            color: #2E7D32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #C8E6C9;
        }

        .info {
            background: #E3F2FD;
            color: #1565C0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #BBDEFB;
        }

        .error {
            background: #FFEBEE;
            color: #C62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #FFCDD2;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2D3748;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            margin: 0;
            color: #2d3748;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8E9AAE;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-tabs-container {
                padding: 10px 15px 0;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .nav-tab {
                font-size: 11px;
                padding: 10px 12px;
                min-width: 70px;
            }

            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .settings-tabs {
                flex-direction: column;
            }
        }
    </style>
    <!-- Load StockPilot API first -->
    <script src="js/stockpilot-api.js"></script>
	<script src="js/ebay-fix.js"></script>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="header">
            <h1>&#128295; StockPilot Settings</h1>
            <p>Configure your system preferences and manage your database</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab home">
                    &#127968; Home
                </a>
                <a href="view-purchases.html" class="nav-tab purchases">
                    &#128722; Purchases
                </a>
                <a href="view-inventory.html" class="nav-tab inventory">
                    &#128230; Inventory
                </a>
                <a href="view-consumables.html" class="nav-tab consumables">
                    &#129520; Consumables
                </a>
                <a href="log-sale.html" class="nav-tab log-sale">
                    &#128176; Log Sale
                </a>
                <a href="view-sales.html" class="nav-tab sales">
                    &#128200; View Sales
                </a>
                <a href="email-import.html" class="nav-tab email-import">
                    &#128231; Email Import
                </a>
                <a href="reports.html" class="nav-tab reports">
                    &#128201; Reports
                </a>
                <a href="settings.html" class="nav-tab settings active">
                    &#128295; Settings
                </a>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Connection Status -->
            <div id="connectionStatus" class="connection-status">
                <span>🔄</span> Checking system status...
            </div>

            <div id="messageArea"></div>

            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="general">⚙️ General</button>
                <button class="settings-tab" data-tab="database">🗄️ Database</button>
                <button class="settings-tab" data-tab="backup">💾 Backup</button>
            </div>

            <!-- General Settings Tab -->
            <div id="general-tab" class="settings-tab-content active">
                <div class="settings-grid">
                    <!-- Currency & Regional Settings -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            💰 Currency & Regional
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label for="currency">Primary Currency</label>
                                <select id="currency" class="form-control">
                                    <option value="GBP">£ British Pound (GBP)</option>
                                    <option value="USD">$ US Dollar (USD)</option>
                                    <option value="EUR">€ Euro (EUR)</option>
                                    <option value="CAD">C$ Canadian Dollar (CAD)</option>
                                    <option value="AUD">A$ Australian Dollar (AUD)</option>
                                    <option value="JPY">¥ Japanese Yen (JPY)</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label for="dateFormat">Date Format</label>
                                <select id="dateFormat">
                                    <option value="DD/MM/YYYY">DD/MM/YYYY (UK)</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label for="timezone">Timezone</label>
                                <select id="timezone">
                                    <option value="Europe/London">London (GMT/BST)</option>
                                    <option value="America/New_York">New York (EST/EDT)</option>
                                    <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                                    <option value="Europe/Berlin">Berlin (CET/CEST)</option>
                                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                                    <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- eBay Integration Settings -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            🏪 eBay Integration
                            <span id="ebayConnectionStatus" class="connection-badge offline">Offline</span>
                        </div>
                        <div class="settings-section-content">
                            <div class="info" style="margin-bottom: 20px;">
                                <strong>Quick Setup:</strong><br>
                                1. Get your API credentials from <a href="https://developer.ebay.com" target="_blank">eBay Developer Portal</a><br>
                                2. Configure credentials below<br>
                                3. Test connection and authenticate<br>
                                4. Your purchases will auto-refresh when you visit the Purchases tab
                            </div>

                            <div id="ebayConnectionInfo" class="ebay-status disconnected">
                                <div>
                                    <strong>Connection Status:</strong> Not configured<br>
                                    <small>Configure your eBay API credentials to get started</small>
                                </div>
                                <div>🔌</div>
                            </div>

                            <div class="setting-group">
                                <label for="ebayClientId">eBay Client ID (App ID)</label>
                                <input type="text" id="ebayClientId" placeholder="Enter your eBay App ID from Developer Portal">
                            </div>

                            <div class="setting-group">
                                <label for="ebayClientSecret">eBay Client Secret</label>
                                <input type="password" id="ebayClientSecret" placeholder="Enter your eBay Client Secret">
                            </div>

                            <div class="setting-group">
                                <label for="ebayRuName">eBay RuName (Redirect URL)</label>
                                <input type="text" id="ebayRuName" placeholder="Your registered redirect URL" value="https://a55c-2a00-23ee-1068-6817-7c85-68b1-aea7-72f6.ngrok-free.app/ebay/callback">
                            </div>

                            <div class="setting-group">
                                <label for="ebayEnvironment">Environment</label>
                                <select id="ebayEnvironment">
                                    <option value="sandbox">Sandbox (Testing)</option>
                                    <option value="production">Production (Live)</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label>Auto-refresh Purchase Data</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ebayAutoRefresh" checked>
                                    <span class="slider"></span>
                                </label>
                                <small style="color: #64748b; display: block; margin-top: 4px;">
                                    Automatically fetch latest eBay purchases when viewing Purchases tab
                                </small>
                            </div>

                            <div class="ebay-sync-info" id="ebaySyncInfo" style="display: none;">
                                Last sync: <span id="ebayLastSync">Never</span><br>
                                Purchases found: <span id="ebayPurchaseCount">0</span>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-primary" id="testEbayBtn">
                                    🔌 Test Connection
                                </button>
                                <button class="btn btn-success" id="authenticateEbayBtn">
                                    🔐 Authenticate with eBay
                                </button>
                                <button class="btn btn-warning" id="syncEbayBtn">
                                    🔄 Sync Data Now
                                </button>
                                <button class="btn btn-danger btn-small" id="clearEbayAuthBtn">
                                    🗑️ Clear Auth
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Theme & Colors -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            🎨 Theme & Colors
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label>Select Theme</label>
                                <div class="theme-grid">
                                    <div class="theme-option active" data-theme="default">
                                        <div class="theme-preview" style="--theme-primary: #4A90E2; --theme-secondary: #357ABD;"></div>
                                        <div class="theme-name">Blue</div>
                                    </div>
                                    <div class="theme-option" data-theme="green">
                                        <div class="theme-preview" style="--theme-primary: #48BB78; --theme-secondary: #38A169;"></div>
                                        <div class="theme-name">Green</div>
                                    </div>
                                    <div class="theme-option" data-theme="purple">
                                        <div class="theme-preview" style="--theme-primary: #8B7EC8; --theme-secondary: #7B6CB8;"></div>
                                        <div class="theme-name">Purple</div>
                                    </div>
                                    <div class="theme-option" data-theme="orange">
                                        <div class="theme-preview" style="--theme-primary: #ED8936; --theme-secondary: #DD7808;"></div>
                                        <div class="theme-name">Orange</div>
                                    </div>
                                    <div class="theme-option" data-theme="dark">
                                        <div class="theme-preview" style="--theme-primary: #2D3748; --theme-secondary: #1A202C;"></div>
                                        <div class="theme-name">Dark</div>
                                    </div>
                                    <div class="theme-option" data-theme="teal">
                                        <div class="theme-preview" style="--theme-primary: #17a2b8; --theme-secondary: #138496;"></div>
                                        <div class="theme-name">Teal</div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label for="customPrimary">Custom Primary Color</label>
                                <input type="color" id="customPrimary" value="#4A90E2">
                                <span class="color-preview" id="primaryPreview" style="background: #4A90E2;"></span>
                            </div>

                            <div class="setting-group">
                                <label for="customSecondary">Custom Secondary Color</label>
                                <input type="color" id="customSecondary" value="#357ABD">
                                <span class="color-preview" id="secondaryPreview" style="background: #357ABD;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Display & Behavior -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            ⚙️ Display & Behavior
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label for="itemsPerPage">Items Per Page</label>
                                <select id="itemsPerPage">
                                    <option value="25">25 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                    <option value="all">Show all</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label for="defaultSort">Default Sorting</label>
                                <select id="defaultSort">
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                    <option value="date_desc">Newest First</option>
                                    <option value="date_asc">Oldest First</option>
                                    <option value="value_desc">Highest Value</option>
                                    <option value="value_asc">Lowest Value</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label>Auto-refresh Data</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoRefresh" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <label>Compact View</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compactView">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Business Settings -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            🏢 Business Settings
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label for="businessName">Business Name</label>
                                <input type="text" id="businessName" placeholder="Your Business Name">
                            </div>

                            <div class="setting-group">
                                <label for="defaultPlatformFee">Default Platform Fee (%)</label>
                                <input type="number" id="defaultPlatformFee" value="10" min="0" max="100" step="0.1">
                            </div>

                            <div class="setting-group">
                                <label for="defaultMarkup">Default Markup (%)</label>
                                <input type="number" id="defaultMarkup" value="50" min="0" max="1000" step="1">
                            </div>

                            <div class="setting-group">
                                <label for="lowStockThreshold">Low Stock Alert Threshold</label>
                                <input type="number" id="lowStockThreshold" value="5" min="0" step="1">
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            🔔 Notifications
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label>Email Notifications</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <label>Low Stock Alerts</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="lowStockAlerts" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <label>Sale Notifications</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="saleNotifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <label for="notificationEmail">Notification Email</label>
                                <input type="email" id="notificationEmail" placeholder="your-email@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- Data & Privacy -->
                    <div class="settings-section">
                        <div class="settings-section-header">
                            🔒 Data & Privacy
                        </div>
                        <div class="settings-section-content">
                            <div class="setting-group">
                                <label>Auto-backup to Cloud</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoBackup" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <label for="backupFrequency">Backup Frequency</label>
                                <select id="backupFrequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <div class="setting-group">
                                <label for="dataRetention">Data Retention (months)</label>
                                <input type="number" id="dataRetention" value="24" min="1" max="120" step="1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn-save" id="saveSettingsBtn">💾 Save Settings</button>
                    <button class="btn-reset" id="resetSettingsBtn">🔄 Reset to Defaults</button>
                </div>
            </div>

            <!-- Database Management Tab -->
            <div id="database-tab" class="settings-tab-content">
                <!-- Database Statistics -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        📊 Database Statistics
                    </div>
                    <div class="settings-section-content">
                        <div id="db-stats" class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-tables">-</div>
                                <div class="stat-label">Total Tables</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="total-rows">-</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="db-size">-</div>
                                <div class="stat-label">Database Size</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="refreshStatsBtn">🔄 Refresh Stats</button>
                    </div>
                </div>

                <!-- Table Management -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        📋 Table Management
                    </div>
                    <div class="settings-section-content">
                        <div id="table-list" class="table-list">
                            <div class="table-item">
                                <div class="table-info">
                                    <div class="table-name">Loading tables...</div>
                                    <div class="table-rows">Please wait...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Operations -->
                <div class="settings-section">
                    <div class="settings-section-header">
                        ⚠️ Dangerous Operations
                    </div>
                    <div class="settings-section-content">
                        <p style="color: #e53e3e; margin-bottom: 20px;">
                            <strong>Warning:</strong> These operations cannot be undone. Please ensure you have a backup before proceeding.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <button class="btn btn-warning" id="resetSequencesBtn">🔄 Reset ID Sequences</button>
                            <button class="btn btn-danger" id="clearDatabaseBtn">🗑️ Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup Tab -->
            <div id="backup-tab" class="settings-tab-content">
                <div class="settings-section">
                    <div class="settings-section-header">
                        💾 Create Backup
                    </div>
                    <div class="settings-section-content">
                        <p>Create a summary of your current database state.</p>
                        <button class="btn btn-primary" id="createBackupBtn">📦 Create Backup Summary</button>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-section-header">
                        🔧 Manual Backup Instructions
                    </div>
                    <div class="settings-section-content">
                        <p>For full database backups, use these PostgreSQL commands:</p>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                            # Full backup<br>
                            pg_dump -h localhost -U postgres stockpilot > backup_$(date +%Y%m%d).sql<br><br>
                            # Restore from backup<br>
                            psql -h localhost -U postgres stockpilot < backup_20250624.sql
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="clearDatabaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">⚠️ Clear All Database Data</h3>
                <span class="close" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #e53e3e; margin-bottom: 20px;">
                    <strong>This action will permanently delete all data from your database!</strong>
                </p>
                <p>This includes:</p>
                <ul style="margin: 15px 0;">
                    <li>All inventory items</li>
                    <li>All purchase records</li>
                    <li>All sales data</li>
                    <li>All consumables</li>
                    <li>All reports and analytics</li>
                </ul>
                <p style="margin-bottom: 20px;">
                    To confirm, please type <strong>"CLEAR ALL DATA"</strong> below:
                </p>
                <div class="setting-group">
                    <input type="text" id="confirmationText" placeholder="Type: CLEAR ALL DATA" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" id="cancelClearBtn">Cancel</button>
                    <button class="btn btn-danger" id="confirmClearBtn">🗑️ Clear Database</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Settings Page JavaScript
         * Uses StockPilot API for backend communication
         */

        let settingsAPIAvailable = false;
        let databaseAPIAvailable = false;

        // Setup event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded');
            console.log('🔍 Checking for stockpilotAPI:', typeof stockpilotAPI);
            
            // Delay event listener setup to ensure all elements are available
            setTimeout(function() {
                console.log('🔧 Setting up event listeners...');
                setupEventListeners();
                
                // Load initial data
                loadSystemStatus();
                loadSettingsData();
                loadDatabaseStats();
            }, 500); // Increased delay to ensure API is loaded
        });

        // Also try to setup after window load as backup
        window.addEventListener('load', function() {
            console.log('🌐 Window loaded');
            
            // Setup event listeners again as backup
            setTimeout(function() {
                console.log('🔧 Backup event listener setup...');
                setupEventListeners();
            }, 100);
        });

        // Setup event listeners for buttons
        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Check if stockpilotAPI is available
            if (typeof stockpilotAPI === 'undefined') {
                console.error('❌ stockpilotAPI is not available. Cannot setup event listeners.');
                return;
            }
            
            console.log('✅ stockpilotAPI is available');
            
            // Find all buttons and log them
            const allButtons = document.querySelectorAll('button');
            console.log('🔍 Found', allButtons.length, 'buttons on the page');
            
            // eBay Integration buttons
            const testEbayBtn = document.getElementById('testEbayBtn');
            const authenticateEbayBtn = document.getElementById('authenticateEbayBtn');
            const syncEbayBtn = document.getElementById('syncEbayBtn');
            const clearEbayAuthBtn = document.getElementById('clearEbayAuthBtn');
            
            console.log('🔍 Button check:');
            console.log('  testEbayBtn:', testEbayBtn ? 'Found' : 'Not found');
            console.log('  authenticateEbayBtn:', authenticateEbayBtn ? 'Found' : 'Not found');
            console.log('  syncEbayBtn:', syncEbayBtn ? 'Found' : 'Not found');
            console.log('  clearEbayAuthBtn:', clearEbayAuthBtn ? 'Found' : 'Not found');
            
            // Add event listeners with detailed logging
            if (testEbayBtn) {
                testEbayBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔌 Test Connection button clicked!');
                    testEbayConnection();
                });
                console.log('✅ Added event listener to Test Connection button');
            }
            
            if (authenticateEbayBtn) {
                authenticateEbayBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔐 Authenticate button clicked!');
                    authenticateEbay();
                });
                console.log('✅ Added event listener to Authenticate button');
            }
            
            if (syncEbayBtn) {
                syncEbayBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔄 Sync Data button clicked!');
                    syncEbayData();
                });
                console.log('✅ Added event listener to Sync Data button');
            }
            
            if (clearEbayAuthBtn) {
                clearEbayAuthBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🗑️ Clear Auth button clicked!');
                    clearEbayAuth();
                });
                console.log('✅ Added event listener to Clear Auth button');
            }
            
            // Settings buttons
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            const clearDatabaseBtn = document.getElementById('clearDatabaseBtn');
            
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('💾 Save Settings button clicked!');
                    saveSettings();
                });
                console.log('✅ Added event listener to Save Settings button');
            }
            
            if (refreshStatsBtn) {
                refreshStatsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔄 Refresh Stats button clicked!');
                    loadDatabaseStats();
                });
                console.log('✅ Added event listener to Refresh Stats button');
            }
            
            if (clearDatabaseBtn) {
                clearDatabaseBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🗑️ Clear Database button clicked!');
                    showClearDatabaseModal();
                });
                console.log('✅ Added event listener to Clear Database button');
            }
            
            // Tab navigation
            const tabButtons = document.querySelectorAll('[data-tab]');
            console.log('🔍 Found', tabButtons.length, 'tab buttons');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    console.log('📋 Tab clicked:', tabName);
                    showSettingsTab(tabName);
                });
            });
            
            console.log('✅ Event listeners setup complete');
        }

        // Load system status
        function loadSystemStatus() {
            console.log('🔍 Loading system status...');
            
            // Check if API is available
            if (typeof stockpilotAPI !== 'undefined') {
                console.log('✅ StockPilot API loaded successfully');
                checkAPIs();
            } else {
                console.error('❌ StockPilot API not loaded - Check if js/stockpilot-api.js exists');
                showMessage('StockPilot API not available - check console for details', 'error');
            }
        }

        // Load settings data
        function loadSettingsData() {
            console.log('📊 Loading settings data...');
            loadSettings();
            checkEbayStatus();
        }

        async function checkAPIs() {
            try {
                // Check localStorage for settings
                const testSettings = localStorage.getItem('stockpilot_settings');
                settingsAPIAvailable = true;
                
                // Check database API
                const response = await stockpilotAPI.getDatabaseStats();
                if (response.success) {
                    databaseAPIAvailable = true;
                }
                
                updateConnectionStatus(true);
                console.log('✅ APIs available - Settings:', settingsAPIAvailable, 'Database:', databaseAPIAvailable);
            } catch (error) {
                updateConnectionStatus(false);
                console.log('⚠️ API check failed:', error.message);
            }
        }

        function updateConnectionStatus(online) {
            const statusEl = document.getElementById('connectionStatus');
            if (online && databaseAPIAvailable) {
                statusEl.className = 'connection-status online';
                statusEl.innerHTML = '<span>✅</span> System ready - All features available';
            } else if (online && settingsAPIAvailable) {
                statusEl.className = 'connection-status offline';
                statusEl.innerHTML = '<span>⚠️</span> Database API unavailable - Settings only';
            } else {
                statusEl.className = 'connection-status offline';
                statusEl.innerHTML = '<span>❌</span> System issues detected';
            }
        }

        // eBay Integration Functions
        async function checkEbayStatus() {
            try {
                const response = await stockpilotAPI.testEbayConnection();
                
                if (response.success) {
                    updateEbayStatus('connected', 'eBay API connected and working');
                } else {
                    updateEbayStatus('disconnected', 'eBay API configured but not authenticated');
                }
            } catch (error) {
                updateEbayStatus('disconnected', 'eBay API not configured or unavailable');
                console.log('eBay status check:', error.message);
            }
        }

        function updateEbayStatus(status, message) {
            const statusBadge = document.getElementById('ebayConnectionStatus');
            const statusInfo = document.getElementById('ebayConnectionInfo');
            
            statusBadge.className = `connection-badge ${status}`;
            statusBadge.textContent = status === 'connected' ? 'Online' : 
                                     status === 'testing' ? 'Testing' : 'Offline';
            
            statusInfo.className = `ebay-status ${status}`;
            statusInfo.innerHTML = `
                <div>
                    <strong>Connection Status:</strong> ${message}<br>
                    <small>Last checked: ${new Date().toLocaleTimeString()}</small>
                </div>
                <div>${status === 'connected' ? '🟢' : status === 'testing' ? '🟡' : '🔴'}</div>
            `;
        }

        function saveEbaySettings() {
            const ebaySettings = {
                clientId: document.getElementById('ebayClientId').value,
                clientSecret: document.getElementById('ebayClientSecret').value,
                ruName: document.getElementById('ebayRuName').value,
                environment: document.getElementById('ebayEnvironment').value,
                autoRefresh: document.getElementById('ebayAutoRefresh').checked
            };
            
            localStorage.setItem('stockpilot_ebay_settings', JSON.stringify(ebaySettings));
            console.log('💾 eBay settings saved');
        }

        function loadEbaySettings() {
            try {
                const ebaySettings = JSON.parse(localStorage.getItem('stockpilot_ebay_settings') || '{}');
                
                if (ebaySettings.clientId) document.getElementById('ebayClientId').value = ebaySettings.clientId;
                if (ebaySettings.clientSecret) document.getElementById('ebayClientSecret').value = ebaySettings.clientSecret;
                if (ebaySettings.ruName) document.getElementById('ebayRuName').value = ebaySettings.ruName;
                if (ebaySettings.environment) document.getElementById('ebayEnvironment').value = ebaySettings.environment;
                if (ebaySettings.autoRefresh !== undefined) document.getElementById('ebayAutoRefresh').checked = ebaySettings.autoRefresh;
            } catch (error) {
                console.log('No eBay settings to load');
            }
        }

        async function testEbayConnection() {
            console.log('🔌 testEbayConnection called');
            updateEbayStatus('testing', 'Testing eBay API connection...');
            
            try {
                // Save current settings first
                saveEbaySettings();
                
                // Check if API is available
                if (typeof stockpilotAPI === 'undefined') {
                    throw new Error('StockPilot API not loaded');
                }
                
                console.log('📡 Calling stockpilotAPI.testEbayConnection()');
                const response = await stockpilotAPI.testEbayConnection();
                console.log('📡 Response:', response);
                
                if (response.success) {
                    updateEbayStatus('connected', 'eBay API test successful - Ready for authentication');
                    showMessage('✅ eBay connection test successful!', 'success');
                } else {
                    updateEbayStatus('disconnected', `eBay API test failed: ${response.message}`);
                    showMessage(`❌ eBay connection test failed: ${response.message}`, 'error');
                }
            } catch (error) {
                console.error('❌ Test error:', error);
                updateEbayStatus('disconnected', `Connection test error: ${error.message}`);
                showMessage(`❌ Connection test error: ${error.message}`, 'error');
            }
        }

        async function authenticateEbay() {
            try {
                saveEbaySettings();
                showMessage('🔐 Starting eBay authentication...', 'info');
                
                const response = await stockpilotAPI.startEbayOAuth();
                
                if (response.success && response.authUrl) {
                    // Open eBay auth in new window
                    window.open(response.authUrl, 'ebayAuth', 'width=600,height=700');
                    
                    // Check for completion
                    const checkAuth = setInterval(async () => {
                        try {
                            const statusResponse = await stockpilotAPI.getEbayProfile();
                            if (statusResponse.success) {
                                clearInterval(checkAuth);
                                updateEbayStatus('connected', 'eBay authentication successful');
                                showMessage('✅ eBay authentication successful!', 'success');
                                syncEbayData();
                            }
                        } catch (e) {
                            // Still waiting for auth
                        }
                    }, 3000);
                    
                    // Stop checking after 5 minutes
                    setTimeout(() => clearInterval(checkAuth), 300000);
                } else {
                    showMessage('❌ Failed to start eBay authentication', 'error');
                }
            } catch (error) {
                showMessage(`❌ Authentication error: ${error.message}`, 'error');
            }
        }

        async function syncEbayData() {
            try {
                showMessage('🔄 Syncing eBay purchase data...', 'info');
                
                const response = await stockpilotAPI.syncEbayData();
                
                if (response.success) {
                    const syncInfo = document.getElementById('ebaySyncInfo');
                    syncInfo.style.display = 'block';
                    document.getElementById('ebayLastSync').textContent = new Date().toLocaleString();
                    document.getElementById('ebayPurchaseCount').textContent = response.sync?.ordersProcessed || 0;
                    
                    showMessage(`✅ eBay sync completed - Found ${response.sync?.ordersProcessed || 0} purchases`, 'success');
                } else {
                    showMessage(`❌ eBay sync failed: ${response.message}`, 'error');
                }
            } catch (error) {
                showMessage(`❌ Sync error: ${error.message}`, 'error');
            }
        }

        async function clearEbayAuth() {
            if (confirm('Clear eBay authentication? You will need to re-authenticate.')) {
                try {
                    await stockpilotAPI.clearEbayAuth();
                    localStorage.removeItem('stockpilot_ebay_auth');
                    updateEbayStatus('disconnected', 'eBay authentication cleared');
                    document.getElementById('ebaySyncInfo').style.display = 'none';
                    showMessage('🗑️ eBay authentication cleared', 'info');
                } catch (error) {
                    showMessage(`❌ Error clearing auth: ${error.message}`, 'error');
                }
            }
        }

        // Tab Management
        function showSettingsTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.settings-tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all nav buttons
            const navTabs = document.querySelectorAll('.settings-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked nav button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'database') {
                loadDatabaseStats();
            }
        }

        // Alert Management
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageArea.innerHTML = '';
                }, 3000);
            }
        }

        // Database Statistics
        async function loadDatabaseStats() {
            if (!databaseAPIAvailable) {
                showMessage('Database API not available', 'error');
                return;
            }

            try {
                const response = await stockpilotAPI.getDatabaseStats();
                
                if (response.success) {
                    document.getElementById('total-tables').textContent = response.data.tableList.length;
                    
                    const totalRows = response.data.tableList.reduce((sum, table) => sum + table.rows, 0);
                    document.getElementById('total-rows').textContent = totalRows.toLocaleString();
                    document.getElementById('db-size').textContent = response.data.databaseSize;
                    
                    updateTableList(response.data.tableList);
                    console.log('✅ Database stats loaded successfully');
                } else {
                    showMessage('Failed to load database statistics: ' + response.message, 'error');
                }
            } catch (error) {
                console.error('Error loading database stats:', error);
                showMessage('Error loading database statistics: ' + error.message, 'error');
            }
        }

        function updateTableList(tableList) {
            const tableListEl = document.getElementById('table-list');
            tableListEl.innerHTML = '';
            
            if (!tableList || tableList.length === 0) {
                tableListEl.innerHTML = `
                    <div class="table-item">
                        <div class="table-info">
                            <div class="table-name">No tables found</div>
                            <div class="table-rows">Check database connection</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            tableList.forEach(table => {
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                tableItem.innerHTML = `
                    <div class="table-info">
                        <div class="table-name">${table.name}</div>
                        <div class="table-rows">${table.rows.toLocaleString()} rows</div>
                    </div>
                    <button class="btn btn-danger btn-small" data-table="${table.name}">
                        🗑️ Clear
                    </button>
                `;
                
                // Add event listener for clear button
                const clearBtn = tableItem.querySelector('.btn-danger');
                clearBtn.addEventListener('click', function() {
                    const tableName = this.getAttribute('data-table');
                    clearTable(tableName);
                });
                
                tableListEl.appendChild(tableItem);
            });
        }

        // Clear specific table
        async function clearTable(tableName) {
            if (!confirm(`Are you sure you want to clear all data from the "${tableName}" table? This cannot be undone.`)) {
                return;
            }

            try {
                const response = await stockpilotAPI.clearTable(tableName);
                
                if (response.success) {
                    showMessage(response.message, 'success');
                    loadDatabaseStats();
                } else {
                    showMessage(response.message, 'error');
                }
            } catch (error) {
                console.error('Error clearing table:', error);
                showMessage('Error clearing table', 'error');
            }
        }

        // Reset sequences
        async function resetSequences() {
            if (!confirm('Are you sure you want to reset all ID sequences? This will restart auto-increment counters.')) {
                return;
            }

            try {
                const response = await fetch('/api/settings/database/reset-sequences', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting sequences:', error);
                showMessage('Error resetting sequences', 'error');
            }
        }

        // Clear database modal
        function showClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').style.display = 'block';
            document.getElementById('confirmationText').value = '';
        }

        function closeClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').style.display = 'none';
        }

        // Clear all database
        async function clearAllDatabase() {
            const confirmationText = document.getElementById('confirmationText').value;
            
            if (confirmationText !== 'CLEAR ALL DATA') {
                showMessage('Please type "CLEAR ALL DATA" to confirm', 'error');
                return;
            }

            try {
                const response = await fetch('/api/settings/database/clear-all', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeClearDatabaseModal();
                    loadDatabaseStats();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error clearing database:', error);
                showMessage('Error clearing database', 'error');
            }
        }

        // Create backup
        async function createBackup() {
            try {
                const response = await fetch('/api/settings/database/backup', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage(`${data.message}. Backup ID: ${data.backup_id}`, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                showMessage('Error creating backup', 'error');
            }
        }

        // Settings Management
        function loadSettings() {
            try {
                if (!settingsAPIAvailable) {
                    showMessage('⚠️ Settings storage not available - using defaults', 'info');
                    return;
                }

                const settings = JSON.parse(localStorage.getItem('stockpilot_settings') || '{}');
                
                // Load each setting if it exists
                Object.keys(settings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key];
                        } else {
                            element.value = settings[key];
                        }
                    }
                });

                // Update theme selection
                if (settings.selectedTheme) {
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.remove('active');
                        if (option.dataset.theme === settings.selectedTheme) {
                            option.classList.add('active');
                        }
                    });
                }

                // Update color previews
                if (settings.customPrimary) {
                    document.getElementById('primaryPreview').style.background = settings.customPrimary;
                }
                if (settings.customSecondary) {
                    document.getElementById('secondaryPreview').style.background = settings.customSecondary;
                }

                // Load eBay settings
                loadEbaySettings();

                // Apply settings immediately
                applySettings(settings);

            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('ℹ️ Using default settings', 'info');
            }
        }

        function saveSettings() {
            try {
                if (!settingsAPIAvailable) {
                    showMessage('❌ Cannot save settings - storage not available', 'error');
                    return;
                }

                const settings = {};
                
                // Collect all form values
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.id && !input.id.includes('Preview') && !input.id.includes('confirmationText') && !input.id.includes('ebay')) {
                        if (input.type === 'checkbox') {
                            settings[input.id] = input.checked;
                        } else {
                            settings[input.id] = input.value;
                        }
                    }
                });

                // Get selected theme
                const activeTheme = document.querySelector('.theme-option.active');
                if (activeTheme) {
                    settings.selectedTheme = activeTheme.dataset.theme;
                }

                // Save to localStorage
                localStorage.setItem('stockpilot_settings', JSON.stringify(settings));
                
                // Save eBay settings separately
                saveEbaySettings();
                
                // Apply settings immediately
                applySettings(settings);
                
                showMessage('✅ Settings saved successfully!', 'success');
                
                // Also save to other storage keys for backward compatibility
                if (settings.currency) {
                    localStorage.setItem('stockpilot_currency', settings.currency);
                }
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('❌ Error saving settings', 'error');
            }
        }

        function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to defaults?')) {
                return;
            }

            try {
                if (settingsAPIAvailable) {
                    localStorage.removeItem('stockpilot_settings');
                    localStorage.removeItem('stockpilot_currency');
                    localStorage.removeItem('stockpilot_ebay_settings');
                }
                
                showMessage('🔄 Settings reset to defaults', 'info');
                
                // Reload the page to apply defaults
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error resetting settings:', error);
                showMessage('❌ Error resetting settings', 'error');
            }
        }

        function applySettings(settings) {
            try {
                // Apply currency symbol globally
                if (settings.currency) {
                    localStorage.setItem('stockpilot_currency', settings.currency);
                }

                // Apply theme colors
                if (settings.customPrimary || settings.customSecondary) {
                    const style = document.createElement('style');
                    style.id = 'dynamic-theme-styles';
                    style.textContent = `
                        :root {
                            --primary-color: ${settings.customPrimary || '#4A90E2'};
                            --secondary-color: ${settings.customSecondary || '#357ABD'};
                        }
                    `;
                    
                    // Remove existing dynamic styles
                    const existingStyle = document.getElementById('dynamic-theme-styles');
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    
                    document.head.appendChild(style);
                }

                // Apply other visual settings
                if (settings.compactView) {
                    document.body.classList.add('compact-view');
                } else {
                    document.body.classList.remove('compact-view');
                }

                // Apply auto-refresh setting
                if (settings.autoRefresh !== undefined) {
                    localStorage.setItem('stockpilot_autoRefresh', settings.autoRefresh.toString());
                }

                // Apply items per page setting
                if (settings.itemsPerPage) {
                    localStorage.setItem('stockpilot_itemsPerPage', settings.itemsPerPage);
                }

                // Apply default sort setting
                if (settings.defaultSort) {
                    localStorage.setItem('stockpilot_defaultSort', settings.defaultSort);
                }

            } catch (error) {
                console.error('Error applying settings:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('clearDatabaseModal');
            if (event.target === modal) {
                closeClearDatabaseModal();
            }
        };

        // Currency helper function for other pages
        function getCurrencySymbol() {
            const settings = JSON.parse(localStorage.getItem('stockpilot_settings') || '{}');
            const currencySymbols = {
                'GBP': '£',
                'USD': ',
                'EUR': '€',
                'CAD': 'C,
                'AUD': 'A,
                'JPY': '¥'
            };
            return currencySymbols[settings.currency] || '£';
        }

        // Dynamic data initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing dynamic data loading...');
            
            try {
                // Initialize performance monitoring
                const startTime = performance.now();
                
                // Performance metrics
                const loadTime = performance.now() - startTime;
                console.log('✅ Dynamic data initialization completed in ' + loadTime.toFixed(2) + 'ms');
                
                // Trigger custom event for other scripts
                document.dispatchEvent(new CustomEvent('stockpilotDataLoaded', {
                    detail: { loadTime: loadTime }
                }));
                
            } catch (error) {
                console.error('❌ Dynamic data initialization failed:', error);
            }
        });

        // Helper function to refresh all dynamic data
        async function refreshDynamicData() {
            console.log('🔄 Refreshing dynamic data...');
            
            // Clear API cache if available
            if (window.stockpilotAPI && window.stockpilotAPI.clearCache) {
                window.stockpilotAPI.clearCache();
            }
            
            // Reload page to refresh everything
            location.reload();
        }

        // Add refresh button for development (remove in production)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.addEventListener('DOMContentLoaded', function() {
                const refreshBtn = document.createElement('button');
                refreshBtn.textContent = '🔄 Refresh Data';
                refreshBtn.style.position = 'fixed';
                refreshBtn.style.top = '10px';
                refreshBtn.style.right = '10px';
                refreshBtn.style.zIndex = '9999';
                refreshBtn.style.background = '#007bff';
                refreshBtn.style.color = 'white';
                refreshBtn.style.border = 'none';
                refreshBtn.style.padding = '5px 10px';
                refreshBtn.style.borderRadius = '3px';
                refreshBtn.style.fontSize = '12px';
                refreshBtn.title = 'Refresh dynamic data (dev mode)';
                refreshBtn.onclick = refreshDynamicData;
                document.body.appendChild(refreshBtn);
            });
        }
    </script>
</body>
</html>