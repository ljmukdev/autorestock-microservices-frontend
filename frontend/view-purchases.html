<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://stockpilot-ebay-oauth-production.up.railway.app">
  <title>StockPilot - Purchase Management & Staging</title>
  <style>
    /* Original page styling */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:15px; background:linear-gradient(135deg,#1a365d 0%,#2c5282 100%); min-height:100vh; }
    .container { max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 20px 40px rgba(26,54,93,0.15); overflow:hidden; }
    .header { display:flex; align-items:center; margin-bottom:0; background:rgba(255,255,255,0.95); padding:30px 25px 24px 25px; position:relative; }
    .header-logo { height:80px; position:absolute; left:25px; }
    .header-text { flex:1; text-align:center; }
    .header h1 { color:#1a365d; margin:0; font-size:1.8em; }
    .header p { margin:0; font-size:0.9em; color:#1a365d; }

    .nav-tabs-container { background:rgba(255,255,255,0.95); padding:12px 25px 0; position:relative; }
    .nav-tabs-container::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background:#1a365d; z-index:1; }
    .nav-tabs { display:flex; gap:2px; background:transparent; padding:0; margin:0; list-style:none; flex-wrap:nowrap; overflow-x:auto; }
    .nav-tab { background:linear-gradient(135deg,#F5F7FA,#E2E8F0); border:none; padding:10px 8px; cursor:pointer; transition:all .3s ease; text-decoration:none; color:#2D3748; font-weight:500; font-size:11px; border-radius:12px 12px 0 0; position:relative; text-align:center; display:flex; align-items:center; justify-content:center; gap:3px; flex:1; min-width:0; white-space:nowrap; }
    .nav-tab:hover { text-decoration:none; color:white; transform:translateY(-2px); box-shadow:0 6px 15px rgba(26,54,93,.2); }
    .nav-tab.active { transform:translateY(0); box-shadow:0 0 0 3px rgba(255,255,255,.8); }
    .nav-tab.home { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; }
    .nav-tab.purchases { background:linear-gradient(135deg,#67B292,#5A9B7F); color:white; }
    .nav-tab.inventory { background:linear-gradient(135deg,#3182CE,#2C5282); color:white; }
    .nav-tab.consumables { background:linear-gradient(135deg,#38A169,#2F855A); color:white; }
    .nav-tab.log-sale { background:linear-gradient(135deg,#48BB78,#38A169); color:white; }
    .nav-tab.sales { background:linear-gradient(135deg,#805AD5,#6B46C1); color:white; }
    .nav-tab.email-import { background:linear-gradient(135deg,#3182CE,#2B6CB0); color:white; }
    .nav-tab.reports { background:linear-gradient(135deg,#667EEA,#5A67D8); color:white; }
    .nav-tab.settings { background:linear-gradient(135deg,#2D3748,#1A202C); color:white; }

    .content-area { padding:8px 25px 25px 25px; background:#F8FAFC; }

    .status-bar-enhanced { background:white; color:#1a365d; padding:16px 20px; border-radius:12px; margin:5px 0; border:2px solid #1a365d; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px; box-shadow:0 2px 8px rgba(26,54,93,.1); }
    .status-item { display:flex; align-items:center; gap:8px; font-size:13px; font-weight:500; }
    .status-badge { background:rgba(26,54,93,.1); color:#1a365d; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600; margin-left:4px; }

    .recent-activity { background:white; border-radius:12px; padding:14px; margin:5px 0; border:1px solid #e5e7eb; box-shadow:0 2px 10px rgba(26,54,93,.08); overflow:visible; }
    .purchase-card { display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #f3f4f6; transition:all .2s ease; border-radius:6px; margin:2px 0; position:relative; }
    .purchase-card:last-child { border-bottom:none; }
    .purchase-card:hover { background:rgba(26,54,93,.05); }
    .purchase-icon { width:40px; height:40px; border-radius:50%; background:rgba(26,54,93,.1); display:flex; align-items:center; justify-content:center; margin-right:15px; font-size:16px; color:#1a365d; border:2px solid #1a365d; }
    .purchase-text { flex:1; font-size:13px; color:#1a365d; font-weight:500; cursor:pointer; padding:6px 10px; border-radius:6px; transition:all .2s ease; }
    .purchase-text:hover { background:rgba(26,54,93,.1); transform:translateX(2px); }
    .purchase-amount { font-weight:700; color:#1a365d; font-size:14px; margin-right:15px; }
    .staging-controls { display:flex; gap:8px; margin-left:auto; }
    .staging-btn { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; border:none; border-radius:20px; padding:6px 12px; font-size:10px; cursor:pointer; transition:all .2s ease; font-weight:600; text-transform:uppercase; }
    .staging-btn:hover { transform:scale(1.05); box-shadow:0 2px 8px rgba(26,54,93,.3); }
    .staging-btn.stage { background:linear-gradient(135deg,#67B292,#5A9B7F); }
    .staging-btn.split { background:linear-gradient(135deg,#3182CE,#2C5282); }
    .staging-btn.inventory { background:linear-gradient(135deg,#48BB78,#38A169); }

    .status { padding:12px 16px; border-radius:8px; margin:12px 0; font-weight:500; display:flex; align-items:center; gap:8px; font-size:.9rem; animation:slideIn .3s ease-out; }
    @keyframes slideIn { from { opacity:0; transform: translateX(-20px); } to { opacity:1; transform: translateX(0); } }
    .status.success { background:rgba(26,54,93,.1); color:#1a365d; border:1px solid rgba(26,54,93,.2); }
    .status.error { background:rgba(239,68,68,.1); color:#dc2626; border:1px solid rgba(239,68,68,.2); }
    .status.info { background:rgba(59,130,246,.1); color:#2563eb; border:1px solid rgba(59,130,246,.2); }

    .loading-spinner { width:20px; height:20px; border:3px solid #f3f4f6; border-top:3px solid #1a365d; border-radius:50%; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .error-message { text-align:center; padding:40px 20px; color:#dc2626; background:rgba(239,68,68,.1); border-radius:12px; margin:20px 0; }
    .retry-btn { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:15px; transition:all .3s ease; }
    .retry-btn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(26,54,93,.3); }

    @media (max-width: 768px) {
      .status-bar-enhanced { flex-direction:column; gap:10px; }
      .purchase-card { flex-wrap:wrap; gap:10px; }
      .staging-controls { width:100%; justify-content:center; }
    }

    /* ===== Modal (CSP-safe) ‚Äî responsive ===== */
    body.no-scroll { overflow: hidden; }
    .mp-hidden { display: none !important; }
    .mp-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
    .mp-modal { width: clamp(320px, 96vw, 980px); max-height: min(90vh, 1000px); background: #fff; border-radius: 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); border: 2px solid #1a365d; display: flex; flex-direction: column; overflow: hidden; animation: mpPop .2s ease-out; }
    @keyframes mpPop { from { transform: scale(.98); opacity: .6 } to { transform: scale(1); opacity: 1 } }
    .mp-header { display:flex; align-items:center; justify-content:space-between; padding: 16px 18px 10px 18px; position: sticky; top: 0; z-index: 1; background: #fff; border-bottom: 1px solid #edf2f7; }
    .mp-header h3 { color:#1a365d; margin:0; }
    .mp-close { background: transparent; border: 0; font-size: 18px; cursor: pointer; color:#1a365d; }
    .mp-content { flex: 1 1 auto; overflow: auto; -webkit-overflow-scrolling: touch; padding: 12px 18px; }
    .mp-form label { display:flex; flex-direction:column; gap:6px; font-size:12px; color:#1a365d; font-weight:600; }
    .mp-form input, .mp-form select, .mp-form textarea { border:1px solid #cbd5e1; border-radius:8px; padding:8px 10px; font-size:16px; }
    .mp-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; }
    .mp-span-2 { grid-column: 1 / -1; }
    .mp-actions { display:flex; justify-content:flex-end; gap:10px; padding: 10px 18px 16px 18px; position: sticky; bottom: 0; z-index: 1; background: linear-gradient(#fff, #fff); border-top: 1px solid #edf2f7; }
    .mp-btn { background: linear-gradient(135deg,#1a365d,#2c5282); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .mp-btn[disabled] { opacity:.65; cursor:not-allowed; }
    .mp-btn-ghost { background:#eef2f7; color:#1a365d; }
    .mp-alert { padding:10px 12px; border-radius:8px; margin-bottom:8px; font-weight:600; }
    .mp-alert-error { background: rgba(239,68,68,.08); color:#b91c1c; border:1px solid rgba(239,68,68,.3); }
    @media (max-width: 480px), (max-height: 560px) { .mp-backdrop { align-items: stretch; padding: 0; } .mp-modal { width: 100vw; max-height: 100vh; border-radius: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="images/stockpilot-logo.png" alt="StockPilot Logo" class="header-logo">
      <div class="header-text">
        <h1>üõí Purchase Management & Staging</h1>
        <p>View, manage, and stage your purchases for inventory processing</p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs-container">
      <div class="nav-tabs">
        <a href="index.html" class="nav-tab home">üè† Home</a>
        <a href="view-purchases.html" class="nav-tab purchases active">üõí Purchases</a>
        <a href="view-inventory.html" class="nav-tab inventory">üì¶ Inventory</a>
        <a href="view-consumables.html" class="nav-tab consumables">üß∞ Consumables</a>
        <a href="log-sale.html" class="nav-tab log-sale">üí∞ Log Sale</a>
        <a href="view-sales.html" class="nav-tab sales">üìä View Sales</a>
        <a href="email-import.html" class="nav-tab email-import">üìß Email Import</a>
        <a href="reports.html" class="nav-tab reports">üìà Reports</a>
        <a href="settings.html" class="nav-tab settings">‚öôÔ∏è Settings</a>
      </div>
    </div>

    <div class="content-area">
      <!-- Enhanced Status Bar -->
      <div class="status-bar-enhanced" id="status-bar">
        <div class="status-item">
          <span>üí∞</span>
          <span>Total Investment: <strong id="status-total-investment">Loading...</strong></span>
          <span class="status-badge" id="monthly-change">calculating...</span>
        </div>
        <div class="status-item">
          <span>üõí</span>
          <span><strong id="status-purchase-count">0</strong> purchases</span>
          <span class="status-badge" id="source-breakdown">loading...</span>
        </div>
        <div class="status-item">
          <span>üìä</span>
          <span>Average: <strong id="status-avg-purchase">¬£0.00</strong></span>
        </div>
        <div class="status-item">
          <span>üîÑ</span>
          <span>Last sync: <span id="last-sync">now</span></span>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="statusMessage"></div>

      <!-- Purchase History Section -->
      <div class="recent-activity">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0; color:#1a365d; font-size:18px; display:flex; align-items:center; gap:8px;">
            üìä Purchase History & Staging
            <span id="purchaseHistoryCount" class="status-badge">Loading...</span>
          </h3>
          <div style="display:flex; gap:8px;">
            <button id="btn-add-purchase" class="retry-btn" style="padding:6px 12px; font-size:.8rem;">‚ûï Add Purchase</button>
            <button id="btn-ebay-sync" class="retry-btn" style="padding:6px 12px; font-size:.8rem; background: #0064d2; color: white;">üõí Sync eBay</button>
            <button id="btn-refresh" class="retry-btn" style="padding:6px 12px; font-size:.8rem;">üîÑ Refresh</button>
          </div>
        </div>

        <div id="purchaseHistoryContent">
          <div class="loading-spinner"></div>
          <p style="text-align:center; color:#1a365d; margin-top:10px;">Loading your purchase history...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- CSP-safe Modal -->
  <div id="mp-backdrop" class="mp-backdrop mp-hidden" role="dialog" aria-modal="true" aria-labelledby="mp-title">
    <div class="mp-modal">
      <div class="mp-header">
        <h3 id="mp-title">‚ûï Add Purchase (Manual)</h3>
        <button id="mp-close" class="mp-close" aria-label="Close">‚úñ</button>
      </div>

      <div class="mp-content">
        <div id="mp-error" class="mp-alert mp-alert-error mp-hidden"></div>

        <form id="mp-form" class="mp-form">
          <div class="mp-grid">
            <label>Identifier<input name="identifier" placeholder="Will auto-generate‚Ä¶"></label>

            <!-- Category select with 'Add new‚Ä¶' -->
            <label>Category
              <select name="category" data-label="category"></select>
            </label>

            <!-- Brand select with 'Add new‚Ä¶' -->
            <label>Brand
              <select name="brand" data-label="brand"></select>
            </label>

            <label>Model<input name="model"></label>
            <label>Generation<input name="generation"></label>

            <!-- Source select with 'Add new‚Ä¶' -->
            <label>Source
              <select name="source" data-label="source"></select>
            </label>

            <label>Seller Username<input name="seller_username" placeholder="(Vinted/eBay)"></label>
            <label>Order ID<input name="order_id"></label>
            <label>Date of Purchase<input type="date" name="dateOfPurchase" required></label>
            <label>Price Paid (¬£)<input type="number" step="0.01" name="price_paid"></label>
            <label>Shipping (¬£)<input type="number" step="0.01" name="shipping_cost"></label>
            <label>Fees (¬£)<input type="number" step="0.01" name="fees"></label>
            <label>Tracking Ref<input name="tracking_ref"></label>

            <!-- Shipping provider select with 'Add new‚Ä¶' -->
            <label>Shipping Provider
              <select name="shipping_provider" data-label="shipping provider"></select>
            </label>

            <label>Status
              <select name="status">
                <option>Purchased</option>
                <option>Marked as despatched</option>
                <option>Delivered</option>
                <option>Verified</option>
                <option>Feedback left</option>
                <option>Returned</option>
              </select>
            </label>

            <label id="mp-return-wrapper" class="mp-span-2 mp-hidden">Return Reason<input name="return_reason"></label>
            <label>Parts Total<input type="number" min="0" name="parts_total"></label>
            <label class="mp-span-2">Photos (comma-separate URLs)<input name="photos" placeholder="https://.../p1.jpg, https://.../p2.jpg"></label>
            <label class="mp-span-2">Video URL<input name="video_url" placeholder="https://.../unboxing.mp4"></label>
            <label class="mp-span-2">Notes<textarea name="notes" rows="3"></textarea></label>
          </div>
        </form>
      </div>

      <div class="mp-actions">
        <button type="button" id="mp-cancel" class="mp-btn mp-btn-ghost">Cancel</button>
        <button type="submit" form="mp-form" id="mp-submit" class="mp-btn">Save Purchase</button>
      </div>
  </div>
</div>

<!-- Purchase Details Modal -->
<div id="purchase-details-modal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
      <h2>Purchase Details</h2>
      <button id="purchase-details-close" class="modal-close">&times;</button>
    </div>
    <div id="purchase-details-content" class="modal-body">
      <!-- Purchase details will be loaded here -->
    </div>
    <div class="modal-footer">
      <button id="purchase-details-close-btn" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<!-- eBay Marketplace Browser Modal -->
<div id="ebay-marketplace-modal" class="modal" style="display: none;">
  <div class="modal-content" style="max-width: 95vw; max-height: 95vh; overflow-y: auto;">
    <div class="modal-header">
      <h2>eBay Marketplace Browser</h2>
      <button id="ebay-marketplace-close" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Filters -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <input type="text" id="ebay-search" placeholder="Search items..." style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <select id="ebay-category-filter" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">All Categories</option>
        </select>
        <select id="ebay-brand-filter" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">All Brands</option>
        </select>
        <select id="ebay-condition-filter" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <option value="">All Conditions</option>
          <option value="New">New</option>
          <option value="Used - Like New">Used - Like New</option>
          <option value="Used - Good">Used - Good</option>
          <option value="Used - Fair">Used - Fair</option>
          <option value="For Parts">For Parts</option>
        </select>
        <input type="number" id="ebay-price-min" placeholder="Min Price" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
        <input type="number" id="ebay-price-max" placeholder="Max Price" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
      </div>
      
      <!-- Selection controls -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
        <button id="ebay-select-all" class="btn btn-secondary" style="padding: 6px 12px;">Select All</button>
        <button id="ebay-select-none" class="btn btn-secondary" style="padding: 6px 12px;">Select None</button>
        <span id="ebay-selection-count" style="margin-left: 10px; font-weight: bold; color: #059669;">0 items selected</span>
        <button id="ebay-import-selected" class="btn" style="background: #059669; color: white; padding: 6px 12px; margin-left: auto;">Import Selected</button>
      </div>
      
      <!-- Items grid -->
      <div id="ebay-items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 60vh; overflow-y: auto;">
        <!-- Items will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
    console.log('üõí StockPilot Purchase Management & Staging loaded');

    let currentPurchases = [];

    document.addEventListener('DOMContentLoaded', function() {
      try {
        loadPurchases();

        const addBtn = document.getElementById('btn-add-purchase');
        const refreshBtn = document.getElementById('btn-refresh');
        const ebaySyncBtn = document.getElementById('btn-ebay-sync');
        if (addBtn) addBtn.addEventListener('click', openManualPurchaseModal);
        if (refreshBtn) refreshBtn.addEventListener('click', loadPurchases);
        if (ebaySyncBtn) ebaySyncBtn.addEventListener('click', syncEbayPurchases);

        setupManualPurchaseModal();
      } catch (e) {
        console.error('Bootstrap error:', e);
        showStatus('‚ùå UI bootstrap error. Check console.', 'error');
      }
    });

    async function loadPurchases() {
      showLoading();
      try {
        const response = await fetch('/api/purchases');
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        }
        const data = await response.json();
        const purchases = data.purchases || data;
        if (!Array.isArray(purchases)) throw new Error('Invalid data format from /api/purchases');
        currentPurchases = purchases;
        displayPurchases(purchases);
        updateStatusBar(purchases);
        updatePurchaseHistoryCount(purchases);
        showStatus(`‚úÖ Successfully loaded ${purchases.length} purchases`, 'success');
      } catch (error) {
        console.error('‚ùå Error loading purchases:', error);
        showError(error);
      }
    }

    function showLoading() {
      const container = document.getElementById('purchaseHistoryContent');
      container.innerHTML = `
        <div class="loading-spinner"></div>
        <p style="text-align:center; color:#1a365d; margin-top:10px;">Loading your purchase history...</p>
      `;
    }

    function showError(error) {
      const container = document.getElementById('purchaseHistoryContent');
      container.innerHTML = `
        <div class="error-message">
          <h4>‚ùå Failed to Load Purchases</h4>
          <p><strong>Error:</strong> ${error.message}</p>
          <button class="retry-btn" id="btn-retry-load">üîÑ Try Again</button>
        </div>
      `;
      const retry = document.getElementById('btn-retry-load');
      if (retry) retry.addEventListener('click', loadPurchases);
      showStatus(`‚ùå Error loading purchases: ${error.message}`, 'error');
    }

    function displayPurchases(purchases) {
      const container = document.getElementById('purchaseHistoryContent');
      if (!purchases || purchases.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px 20px; color:#1a365d;">
            <h4>üì≠ No Purchases Found</h4>
            <button class="retry-btn" id="btn-retry-empty">üîÑ Try Again</button>
          </div>
        `;
        const btn = document.getElementById('btn-retry-empty');
        if (btn) btn.addEventListener('click', loadPurchases);
        return;
      }

      const cards = purchases.map(purchase => {
        const timeAgo = getTimeAgo(new Date(purchase.orderDate || purchase.purchase_date || purchase.createdAt));
        const platformEmoji = getPlatformEmoji(purchase.platform || 'Unknown');
        const total = (() => {
          const a = Number(purchase.totalAmount ?? NaN);
          const b = Number(purchase.total_paid ?? NaN);
          if (!isNaN(a)) return a;
          if (!isNaN(b)) return b;
          const c = (Number(purchase.price_paid||0) + Number(purchase.shipping_cost||0) + Number(purchase.fees||0));
          return c;
        })().toFixed(2);

        return `
          <div class="purchase-card" data-id="${purchase._id || purchase.id}" style="cursor: pointer;" title="Click to view details">
            <div class="purchase-icon">${platformEmoji}</div>
            <div class="purchase-text">
              <div><strong>${purchase.supplier || purchase.brand || 'Unknown'} ${purchase.items?.[0]?.productName || purchase.model || 'Item'}</strong></div>
              <div style="font-size:11px; color:#666; margin-top:2px;">
                ${purchase.platform || 'Unknown'} ‚Ä¢ ${timeAgo} ‚Ä¢ ${purchase.category || 'Uncategorized'}
              </div>
            </div>
            <div class="purchase-amount">¬£${total}</div>
            <div class="staging-controls">
              <button class="staging-btn stage" data-action="stage" data-id="${purchase._id || purchase.id}">üîç Stage</button>
              <button class="staging-btn split" data-action="split" data-id="${purchase._id || purchase.id}">‚úÇÔ∏è Split</button>
              <button class="staging-btn inventory" data-action="inventory" data-id="${purchase._id || purchase.id}">üì¶ Inventory</button>
              <button class="staging-btn delete" data-action="delete" data-id="${purchase._id || purchase.id}" style="background: #dc2626; color: white;">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = cards;

      container.onclick = (e) => {
        const btn = e.target.closest('button[data-action]');
        if (btn) {
          // Handle button clicks
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'stage') showStatus('üîç Staging‚Ä¶','info');
          if (action === 'split') showStatus('‚úÇÔ∏è Splitting‚Ä¶','info');
          if (action === 'inventory') showStatus('üì¶ Added to inventory','success');
          if (action === 'delete') confirmDeletePurchase(id);
          return;
        }
        
        // Handle purchase card clicks
        const card = e.target.closest('.purchase-card');
        if (card) {
          const id = card.getAttribute('data-id');
          showPurchaseDetails(id);
        }
      };
    }

    function updateStatusBar(purchases) {
      const totalInvestment = purchases.reduce((sum, p) => {
        if (p.totalAmount != null) return sum + Number(p.totalAmount || 0);
        if (p.total_paid != null) return sum + Number(p.total_paid || 0);
        return sum + Number(p.price_paid || 0) + Number(p.shipping_cost || 0) + Number(p.fees || 0);
      }, 0);
      const averagePurchase = purchases.length ? totalInvestment / purchases.length : 0;

      document.getElementById('status-total-investment').textContent = `¬£${totalInvestment.toFixed(2)}`;
      document.getElementById('status-purchase-count').textContent = purchases.length;
      document.getElementById('status-avg-purchase').textContent = `¬£${averagePurchase.toFixed(2)}`;
      document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();

      const manual = purchases.filter(p => (p.source === 'manual') || !p.source).length;
      const auto = purchases.length - manual;
      document.getElementById('source-breakdown').textContent = `${manual} manual, ${auto} auto`;
      document.getElementById('monthly-change').textContent = '+12%';
    }

    function updatePurchaseHistoryCount(purchases) {
      document.getElementById('purchaseHistoryCount').textContent = `${purchases.length} items`;
    }

    function getPlatformEmoji(platform){ const e={ 'eBay':'üè™','Amazon':'üì¶','Vinted':'üëï','Facebook Marketplace':'üìò','Depop':'üõçÔ∏è','Gumtree':'üå≥'}; return e[platform]||'üõí'; }
    function getTimeAgo(date){ const now=new Date(); const s=Math.floor((now-date)/1000); if(s<60) return 'just now'; if(s<3600) return `${Math.floor(s/60)}m ago`; if(s<86400) return `${Math.floor(s/3600)}h ago`; if(s<604800) return `${Math.floor(s/86400)}d ago`; return `${Math.floor(s/604800)}w ago`; }
    function showStatus(message, type){ const el=document.getElementById('statusMessage'); el.innerHTML=`<div class="status ${type}">${message}</div>`; setTimeout(()=>{ el.innerHTML=''; },5000); }

    /* ===== Modal logic (no inline handlers, no external CDNs) ===== */
    function setupManualPurchaseModal() {
      const backdrop = document.getElementById('mp-backdrop');
      const closeBtn = document.getElementById('mp-close');
      const cancelBtn = document.getElementById('mp-cancel');
      const form = document.getElementById('mp-form');
      const errorEl = document.getElementById('mp-error');
      const statusSel = form.querySelector('select[name="status"]');
      const returnWrap = document.getElementById('mp-return-wrapper');

      // --- Dropdown lists with "Add new‚Ä¶" + localStorage persistence ---
      const LISTS = {
        category: { key:'sp_categories', defaults:['Electronics','Audio','Phones','Accessories','Tools','Clothing'] },
        brand: { key:'sp_brands', defaults:['Apple','Samsung','Sony','Bose','Generic'] },
        source: { key:'sp_sources', defaults:['Other','Auction','Vinted','Regular Stock','eBay','Amazon'] },
        shipping_provider: { key:'sp_shippers', defaults:['Royal Mail','EVRi','DPD','UPS','FedEx','DHL','Yodel','Parcelforce'] }
      };

      function loadList(key, defaults){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s) : defaults.slice(); }catch(_){ return defaults.slice(); } }
      function saveList(key, arr){ try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(_){} }

      function populateSelect(sel, items, selectedValue){
        sel.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = ''; placeholder.textContent = '-- Select --';
        sel.appendChild(placeholder);
        items.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          if (selectedValue && selectedValue === v) opt.selected = true;
          sel.appendChild(opt);
        });
        const add = document.createElement('option');
        add.value = '__add_new__'; add.textContent = '‚ûï Add new‚Ä¶';
        sel.appendChild(add);
      }

      function wireAddNew(sel, listCfg){
        sel.addEventListener('change', () => {
          if (sel.value !== '__add_new__') return;
          const label = sel.getAttribute('data-label') || 'item';
          const newItem = window.prompt(`Add new ${label}:`);
          if (newItem && newItem.trim()) {
            const clean = newItem.trim();
            const arr = loadList(listCfg.key, listCfg.defaults);
            if (!arr.includes(clean)) {
              arr.push(clean);
              arr.sort((a,b)=>a.localeCompare(b));
              saveList(listCfg.key, arr);
            }
            populateSelect(sel, arr, clean);
          } else {
            populateSelect(sel, loadList(listCfg.key, listCfg.defaults), '');
          }
        });
      }

      // Initialize dropdowns
      (function initDropdowns(){
        const cfgs = [
          { name:'category', ...LISTS.category },
          { name:'brand', ...LISTS.brand },
          { name:'source', ...LISTS.source },
          { name:'shipping_provider', ...LISTS.shipping_provider }
        ];
        cfgs.forEach(cfg => {
          const sel = form.querySelector(`select[name="${cfg.name}"]`);
          if (!sel) return;
          const arr = loadList(cfg.key, cfg.defaults);
          const selected = (cfg.name==='source' && arr.includes('Other')) ? 'Other' : '';
          populateSelect(sel, arr, selected);
          wireAddNew(sel, cfg);
        });
      })();

      // default date today
      const dateInput = form.querySelector('input[name="dateOfPurchase"]');
      dateInput.value = new Date().toISOString().slice(0,10);

      statusSel.addEventListener('change', () => {
        const show = statusSel.value === 'Returned';
        returnWrap.classList.toggle('mp-hidden', !show);
      });

      function hideError(){ errorEl.classList.add('mp-hidden'); errorEl.textContent=''; }
      function showErrorMsg(msg){ errorEl.textContent = `‚ùå ${msg}`; errorEl.classList.remove('mp-hidden'); }

      // ===== Identifier auto-generation & uniqueness =====
      const idInput = form.querySelector('input[name="identifier"]');
      let idTouched = false;
      idInput.addEventListener('input', () => { idTouched = true; });

      const genFields = ['category','brand','model','generation','dateOfPurchase'];
      genFields.forEach(name => {
        const el = form.querySelector(`[name="${name}"]`);
        if (!el) return;
        el.addEventListener('input', maybeAutoFillId);
        el.addEventListener('change', maybeAutoFillId);
      });

      function maybeAutoFillId(){
        if (idTouched) return;
        const base = buildBaseIdentifier(form);
        const unique = ensureUniqueIdentifier(base);
        idInput.value = unique;
      }

      function buildBaseIdentifier(formEl){
        const cat = slug(formEl.category.value);
        const brand = slug(formEl.brand.value);
        const model = slug(formEl.model.value);
        const gen = slug(formEl.generation.value);
        const date = formEl.dateOfPurchase.value ? yyyymmdd(formEl.dateOfPurchase.value) : yyyymmdd(new Date());
        const parts = [cat, brand, model, gen].filter(Boolean);
        const head = parts.length ? parts.join('-') : 'PURCHASE';
        return `${head}-${date}`;
      }

      function yyyymmdd(val){
        const d = (val instanceof Date) ? val : new Date(val + 'T00:00:00');
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const da = String(d.getDate()).padStart(2,'0');
        return `${y}${m}${da}`;
      }

      function slug(str){
        return String(str || '')
          .trim()
          .toUpperCase()
          .replace(/[^A-Z0-9]+/g,'-')
          .replace(/^-+|-+$/g,'')
          .slice(0,24);
      }

      function ensureUniqueIdentifier(baseId){
        const base = slug(baseId).replace(/-+/g,'-');
        const existing = new Set(
          (currentPurchases || [])
            .map(p => (p.identifier || p.Identifier || '').toString().toUpperCase())
            .filter(Boolean)
        );
        if (!existing.has(base)) return base;
        // Try suffixes -001..-999
        for (let i=1;i<1000;i++){
          const cand = `${base}-${String(i).padStart(3,'0')}`;
          if (!existing.has(cand)) return cand;
        }
        // Fallback with random 4-char
        const rand = Math.random().toString(36).slice(2,6).toUpperCase();
        return `${base}-${rand}`;
      }

      // Autofill on open
      maybeAutoFillId();

      closeBtn.addEventListener('click', closeManualPurchaseModal);
      cancelBtn.addEventListener('click', closeManualPurchaseModal);
      backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeManualPurchaseModal(); });
      document.addEventListener('keydown', (e)=>{ if(!backdrop.classList.contains('mp-hidden') && e.key==='Escape') closeManualPurchaseModal(); });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const dateVal = form.dateOfPurchase.value;
        if (!dateVal) { showErrorMsg('Date of purchase is required.'); return; }
        const nn = (v) => v === '' || v === null || isNaN(Number(v)) ? 0 : Number(v);
        if (nn(form.price_paid.value) < 0) { showErrorMsg('Price paid cannot be negative.'); return; }
        if (nn(form.shipping_cost.value) < 0) { showErrorMsg('Shipping cost cannot be negative.'); return; }
        if (nn(form.fees.value) < 0) { showErrorMsg('Fees cannot be negative.'); return; }

        // Finalize identifier: use user-entered or auto base, then ensure unique
        const entered = form.identifier.value.trim();
        const finalBase = entered ? slug(entered) : buildBaseIdentifier(form);
        const finalIdentifier = ensureUniqueIdentifier(finalBase);
        if (entered && finalIdentifier !== entered.toUpperCase()) {
          showStatus(`‚ÑπÔ∏è Identifier adjusted to ${finalIdentifier} to avoid a duplicate.`, 'info');
        }

        const photosArr = (form.photos.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const payload = {
          identifier: finalIdentifier,
          category: form.category.value || undefined,
          brand: form.brand.value || undefined,
          model: form.model.value || undefined,
          generation: form.generation.value || undefined,
          source: form.source.value || 'Other',
          seller_username: form.seller_username.value || undefined,
          order_id: form.order_id.value || undefined,
          dateOfPurchase: dateVal,
          price_paid: form.price_paid.value === '' ? 0 : Number(form.price_paid.value),
          shipping_cost: form.shipping_cost.value === '' ? 0 : Number(form.shipping_cost.value),
          fees: form.fees.value === '' ? 0 : Number(form.fees.value),
          tracking_ref: form.tracking_ref.value || undefined,
          shipping_provider: form.shipping_provider.value || undefined,
          status: form.status.value,
          return_reason: form.status.value === 'Returned' ? (form.return_reason.value || '') : undefined,
          parts_total: form.parts_total.value === '' ? undefined : Number(form.parts_total.value),
          photos: photosArr,
          video_url: form.video_url.value || undefined,
          notes: form.notes.value || undefined
        };

        const submitBtn = document.getElementById('mp-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving‚Ä¶';

        try {
          console.log('üöÄ Starting purchase save...');
          console.log('üì¶ Payload:', payload);
          console.log('üåê Fetching URL:', '/api/purchases');
          console.log('üìç Current domain:', window.location.origin);
          console.log('üïê Timestamp:', new Date().toISOString());
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            console.log('‚è∞ Request timed out after 30 seconds');
            controller.abort();
          }, 30000); // 30 second timeout
          
          console.log('üì° Making fetch request...');
          const res = await fetch('/api/purchases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          console.log('‚úÖ Got response:', res.status, res.statusText);
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          showStatus('‚úÖ Purchase saved', 'success');
          closeManualPurchaseModal();
          if (window.loadPurchases) loadPurchases();
        } catch (err) {
          console.error('Purchase save error:', err);
          if (err.name === 'AbortError') {
            showErrorMsg('Request timed out after 30 seconds. Please check if the server is running.');
          } else {
            showErrorMsg(err.message);
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Purchase';
        }
      });
    }

    function openManualPurchaseModal(){
      document.getElementById('mp-backdrop').classList.remove('mp-hidden');
      document.body.classList.add('no-scroll');
    }
    function closeManualPurchaseModal(){
      document.getElementById('mp-backdrop').classList.add('mp-hidden');
      document.body.classList.remove('no-scroll');
    }

    // Delete confirmation with failsafe
    function confirmDeletePurchase(purchaseId) {
      // Create confirmation modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 12px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        ">
          <h3 style="margin: 0 0 15px 0; color: #dc2626; font-size: 18px;">üóëÔ∏è Delete Purchase</h3>
          <p style="margin: 0 0 20px 0; color: #374151; line-height: 1.5;">
            Are you sure you want to delete this purchase? This action cannot be undone.
          </p>
          <p style="margin: 0 0 15px 0; color: #dc2626; font-weight: 600; font-size: 14px;">
            Type "delete" to confirm:
          </p>
          <input type="text" id="delete-confirmation-input" placeholder="Type 'delete' here" style="
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
          ">
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancel-delete" style="
              padding: 10px 20px;
              border: 1px solid #d1d5db;
              background: white;
              color: #374151;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 500;
            ">Cancel</button>
            <button id="confirm-delete" disabled style="
              padding: 10px 20px;
              border: none;
              background: #dc2626;
              color: white;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              opacity: 0.5;
            ">Delete Purchase</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const input = modal.querySelector('#delete-confirmation-input');
      const confirmBtn = modal.querySelector('#confirm-delete');
      const cancelBtn = modal.querySelector('#cancel-delete');
      
      // Enable/disable delete button based on input
      input.addEventListener('input', (e) => {
        const isValid = e.target.value.toLowerCase() === 'delete';
        confirmBtn.disabled = !isValid;
        confirmBtn.style.opacity = isValid ? '1' : '0.5';
      });
      
      // Handle confirmation
      confirmBtn.addEventListener('click', () => {
        if (input.value.toLowerCase() === 'delete') {
          deletePurchase(purchaseId);
          document.body.removeChild(modal);
        }
      });
      
      // Handle cancel
      cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
      
      // Focus input
      input.focus();
    }

    // Delete purchase function
    async function deletePurchase(purchaseId) {
      try {
        console.log('üóëÔ∏è Deleting purchase:', purchaseId);
        showStatus('üóëÔ∏è Deleting purchase...', 'info');
        
        const response = await fetch(`/api/purchases/${purchaseId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.details || errorData.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Purchase deleted successfully:', result);
        showStatus('‚úÖ Purchase deleted successfully', 'success');
        
        // Reload purchases to update the list
        loadPurchases();
        
      } catch (error) {
        console.error('‚ùå Error deleting purchase:', error);
        showStatus(`‚ùå Failed to delete purchase: ${error.message}`, 'error');
      }
    }

    // Process eBay sync data
    async function processEbaySyncData(syncData) {
      console.log('üìä Processing eBay sync data:', syncData);
      
      // Check if we have real purchase data
      const hasRealData = syncData.success && syncData.data && 
                         (syncData.data.recentPurchases || syncData.data.summary?.totalPurchases > 0);
      
      if (hasRealData) {
        // Convert eBay data to our format
        const purchases = convertEbayDataToPurchases(syncData.data);
        
        const statusMessage = `‚úÖ Real eBay purchases loaded! Found ${purchases.length} actual purchases`;
        showStatus(statusMessage, 'success');
        
        // Display the real purchases
        displayPurchases(purchases);
        updateStatusBar(purchases);
        
        // Show marketplace browser with real data
        showEbayMarketplaceBrowser(purchases, [], [], 'real_purchases', 'Real eBay purchase data');
        
      } else {
        // Fallback to sample data
        const statusMessage = `‚ö†Ô∏è Sample data loaded! Real purchase data not available`;
        showStatus(statusMessage, 'warning');
        
        // Load sample data
        loadSampleData();
      }
    }

    // Convert eBay data to our purchase format
    function convertEbayDataToPurchases(ebayData) {
      const purchases = [];
      
      if (ebayData.recentPurchases && Array.isArray(ebayData.recentPurchases)) {
        ebayData.recentPurchases.forEach((item, index) => {
          purchases.push({
            id: `ebay_${index}_${Date.now()}`,
            purchase_date: item.date || new Date().toISOString().split('T')[0],
            platform: 'eBay',
            brand: extractBrand(item.title),
            model: extractModel(item.title),
            product_name: item.title,
            purchase_price: item.price || 0,
            total_paid: item.price || 0,
            delivery_status: 'Delivered',
            seller: item.seller || 'Unknown',
            notes: `eBay purchase: ${item.title}`,
            source: 'ebay-oauth',
            created_at: new Date().toISOString()
          });
        });
      }
      
      return purchases;
    }

    // Helper functions for data extraction
    function extractBrand(title) {
      const brands = ['Apple', 'Samsung', 'Sony', 'Bose', 'Sonos', 'LG'];
      const titleLower = title.toLowerCase();
      
      for (const brand of brands) {
        if (titleLower.includes(brand.toLowerCase())) {
          return brand;
        }
      }
      
      return 'Unknown';
    }

    function extractModel(title) {
      const words = title.split(' ');
      if (words.length > 2) {
        return words.slice(1, 4).join(' ');
      }
      return title;
    }

    // Load sample data fallback
    function loadSampleData() {
      const samplePurchases = [
        {
          id: 'sample_1',
          purchase_date: '2025-09-10',
          platform: 'eBay',
          brand: 'Apple',
          model: 'AirPods Pro',
          purchase_price: 89.99,
          total_paid: 94.98,
          delivery_status: 'Delivered',
          seller: 'tech_deals',
          notes: 'Sample purchase data'
        }
      ];
      
      displayPurchases(samplePurchases);
      updateStatusBar(samplePurchases);
    }

    // eBay purchase sync function with OAuth integration
    async function syncEbayPurchases() {
      const syncBtn = document.getElementById('btn-ebay-sync');
      const originalText = syncBtn.textContent;
      
      try {
        // Show loading state
        syncBtn.disabled = true;
        syncBtn.textContent = '‚è≥ Syncing...';
        showStatus('üõí Starting eBay purchase sync...', 'info');
        
        console.log('üîÑ Starting eBay purchase sync...');
        
        // Use OAuth API wrapper if available
        if (typeof window.oauthApiWrapper !== 'undefined') {
          console.log('üì° Using OAuth API wrapper...');
          showStatus('üì° Connecting to eBay with OAuth...', 'info');
          
          const result = await window.oauthApiWrapper.getPurchases({ limit: 100 });
          
          if (result.oauth_required) {
            // OAuth modal will be shown automatically
            showStatus('üîê eBay authentication required. OAuth modal will appear...', 'info');
            return;
          }
          
          if (result.success && result.data) {
            const syncData = result.data;
            console.log('‚úÖ eBay data loaded via OAuth:', syncData);
            
            // Process the real eBay data
            await processEbaySyncData(syncData);
            return;
          } else {
            throw new Error(result.error || 'OAuth sync failed');
          }
        }
        
        // Fallback to direct API call
        console.log('üì° Fetching eBay purchase data directly...');
        showStatus('üì° Fetching eBay purchase data...', 'info');
        
        const syncResponse = await fetch('https://stockpilot-ebay-oauth-production.up.railway.app/api/ebay/default_user/purchases?limit=100', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!syncResponse.ok) {
          const errorData = await syncResponse.json();
          
          // If authentication is required, show OAuth option
          if (errorData.oauth_required || errorData.redirect_required) {
            showStatus('üîê eBay authentication required. Click to authorize...', 'info');
            
            // Add a button to start OAuth
            const authBtn = document.createElement('button');
            authBtn.textContent = 'üîê Authorize eBay';
            authBtn.style.cssText = `
              background: #0064d2;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 600;
              margin-top: 10px;
            `;
            authBtn.onclick = () => {
              window.location.href = 'https://stockpilot-ebay-oauth-production.up.railway.app/ebay-oauth/login';
            };
            
            // Show the button in the status area
            const statusEl = document.querySelector('.status-message');
            if (statusEl) {
              statusEl.appendChild(document.createElement('br'));
              statusEl.appendChild(authBtn);
            }
            
            return;
          }
          
          throw new Error(errorData.message || errorData.error || 'Sync failed');
        }
        
        const syncData = await syncResponse.json();
        console.log('‚úÖ eBay data loaded:', syncData);
        
        // Process the eBay sync data
        await processEbaySyncData(syncData);
        
      } catch (error) {
        console.error('‚ùå eBay sync error:', error);
        showStatus(`‚ùå eBay sync failed: ${error.message}`, 'error');
      } finally {
        // Reset button state
        syncBtn.disabled = false;
        syncBtn.textContent = originalText;
      }
    }

    // Show purchase details modal
    async function showPurchaseDetails(purchaseId) {
      try {
        console.log('Loading purchase details for:', purchaseId);
        
        // Find the purchase in current data
        const purchase = currentPurchases.find(p => (p._id || p.id) === purchaseId);
        if (!purchase) {
          showStatus('‚ùå Purchase not found', 'error');
          return;
        }
        
        // Show modal
        const modal = document.getElementById('purchase-details-modal');
        const content = document.getElementById('purchase-details-content');
        
        // Generate purchase details HTML
        const detailsHtml = generatePurchaseDetailsHtml(purchase);
        content.innerHTML = detailsHtml;
        
        modal.style.display = 'flex';
        
        // Setup modal close handlers
        const closeBtn = document.getElementById('purchase-details-close');
        const closeBtn2 = document.getElementById('purchase-details-close-btn');
        
        const closeModal = () => {
          modal.style.display = 'none';
        };
        
        closeBtn.onclick = closeModal;
        closeBtn2.onclick = closeModal;
        
        // Close on backdrop click
        modal.onclick = (e) => {
          if (e.target === modal) closeModal();
        };
        
      } catch (error) {
        console.error('Error loading purchase details:', error);
        showStatus('‚ùå Failed to load purchase details', 'error');
      }
    }

    // Generate HTML for purchase details
    function generatePurchaseDetailsHtml(purchase) {
      const formatDate = (date) => {
        if (!date) return 'N/A';
        return new Date(date).toLocaleString();
      };
      
      const formatCurrency = (amount) => {
        if (amount == null) return '¬£0.00';
        return `¬£${Number(amount).toFixed(2)}`;
      };
      
      const formatItems = (items) => {
        if (!items || !Array.isArray(items)) return '<p>No items</p>';
        return items.map(item => `
          <div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin: 4px 0;">
            <strong>${item.productName || item.name || 'Unknown Item'}</strong><br>
            <small>SKU: ${item.sku || 'N/A'} | Qty: ${item.quantity || 1} | Price: ${formatCurrency(item.unitPrice)} | Total: ${formatCurrency(item.totalPrice)}</small>
          </div>
        `).join('');
      };
      
      return `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div>
            <h3 style="margin-top: 0; color: #1a365d;">Basic Information</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">ID:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.identifier || purchase._id || purchase.id || 'N/A'}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Category:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.category || 'N/A'}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Brand:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.brand || purchase.supplier || 'N/A'}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Model:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.model || 'N/A'}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Source:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.source || 'N/A'}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Status:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.status || 'N/A'}</td></tr>
            </table>
          </div>
          
          <div>
            <h3 style="margin-top: 0; color: #1a365d;">Financial Information</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Price Paid:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(purchase.price_paid)}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Shipping Cost:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(purchase.shipping_cost)}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Fees:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(purchase.fees)}</td></tr>
              <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Total Amount:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold; color: #059669;">${formatCurrency(purchase.totalAmount)}</td></tr>
            </table>
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <h3 style="color: #1a365d;">Items</h3>
          ${formatItems(purchase.items)}
        </div>
        
        <div style="margin-top: 20px;">
          <h3 style="color: #1a365d;">Additional Information</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Order ID:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.order_id || 'N/A'}</td></tr>
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Seller:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.seller_username || 'N/A'}</td></tr>
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Date of Purchase:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatDate(purchase.dateOfPurchase || purchase.orderDate)}</td></tr>
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Created:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatDate(purchase.createdAt)}</td></tr>
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Updated:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${formatDate(purchase.updatedAt)}</td></tr>
            <tr><td style="padding: 8px; border-bottom: 1px solid #e5e7eb; font-weight: bold;">Tracking Ref:</td><td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${purchase.tracking_ref || 'N/A'}</td></tr>
          </table>
        </div>
        
        ${purchase.notes ? `
        <div style="margin-top: 20px;">
          <h3 style="color: #1a365d;">Notes</h3>
          <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 4px solid #3b82f6;">
            ${purchase.notes}
          </div>
        </div>
        ` : ''}
      `;
    }

    // eBay Marketplace Browser Functions
    let currentEbayItems = [];
    let filteredEbayItems = [];

    function showEbayMarketplaceBrowser(items, categories, brands, dataType = 'unknown', note = '') {
      currentEbayItems = items;
      filteredEbayItems = [...items];
      
      const modal = document.getElementById('ebay-marketplace-modal');
      modal.style.display = 'flex';
      
      // Update modal title and add note
      const modalTitle = modal.querySelector('h2');
      modalTitle.textContent = dataType === 'real_purchases' ? 'eBay Purchase History Browser' : 'eBay Marketplace Browser';
      
      // Add data type note
      const modalBody = modal.querySelector('.modal-body');
      let noteElement = modalBody.querySelector('.data-type-note');
      if (noteElement) {
        noteElement.remove();
      }
      
      if (note) {
        noteElement = document.createElement('div');
        noteElement.className = 'data-type-note';
        noteElement.style.cssText = `
          padding: 10px; 
          margin-bottom: 15px; 
          border-radius: 6px; 
          font-size: 14px;
          ${dataType === 'real_purchases' ? 
            'background: #f0fdf4; border: 1px solid #059669; color: #059669;' : 
            'background: #fef3c7; border: 1px solid #f59e0b; color: #92400e;'
          }
        `;
        noteElement.innerHTML = `<strong>üìä Data Source:</strong> ${note}`;
        modalBody.insertBefore(noteElement, modalBody.firstChild);
      }
      
      // Populate filters
      populateEbayFilters(categories, brands);
      
      // Render items
      renderEbayItems(filteredEbayItems, dataType);
      
      // Setup event listeners
      setupEbayEventListeners();
      
      // Update selection count
      updateEbaySelectionCount();
    }

    function populateEbayFilters(categories, brands) {
      // Populate category filter
      const categoryFilter = document.getElementById('ebay-category-filter');
      categoryFilter.innerHTML = '<option value="">All Categories</option>';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
      
      // Populate brand filter
      const brandFilter = document.getElementById('ebay-brand-filter');
      brandFilter.innerHTML = '<option value="">All Brands</option>';
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
      });
    }

    function renderEbayItems(items, dataType = 'unknown') {
      const grid = document.getElementById('ebay-items-grid');
      
      if (items.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No items match your filters</p>';
        return;
      }
      
      const isRealData = dataType === 'real_purchases';
      
      const itemsHtml = items.map(item => {
        const isSelected = item.isSelected;
        const cardStyle = isSelected ? 
          'border: 2px solid #059669; background: #f0fdf4;' : 
          'border: 1px solid #e5e7eb; background: white;';
        
        const realDataBadge = isRealData ? 
          '<span style="background: #059669; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; margin-left: 4px;">REAL</span>' : 
          '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; margin-left: 4px;">SAMPLE</span>';
        
        return `
          <div class="ebay-item-card" data-id="${item.id}" style="${cardStyle} border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <input type="checkbox" class="ebay-item-checkbox" data-id="${item.id}" ${isSelected ? 'checked' : ''} style="margin-top: 4px;">
              <img src="${item.imageUrl}" alt="${item.title}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
              <div style="flex: 1; min-width: 0;">
                <h4 style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                  ${item.title} ${realDataBadge}
                </h4>
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                  <span style="background: #e5e7eb; padding: 2px 6px; border-radius: 12px; margin-right: 4px;">${item.category}</span>
                  <span style="background: #e5e7eb; padding: 2px 6px; border-radius: 12px; margin-right: 4px;">${item.brand}</span>
                  <span style="background: #e5e7eb; padding: 2px 6px; border-radius: 12px;">${item.condition}</span>
                </div>
                <div style="font-weight: bold; color: #059669; font-size: 16px;">¬£${item.price.toFixed(2)}</div>
                <div style="font-size: 11px; color: #666; margin-top: 4px;">
                  ${item.seller} (${(item.sellerRating * 100).toFixed(0)}%) ‚Ä¢ ${item.location} ‚Ä¢ ${item.timeLeft}
                </div>
                ${item.shippingCost > 0 ? `<div style="font-size: 11px; color: #666;">+ ¬£${item.shippingCost.toFixed(2)} shipping</div>` : '<div style="font-size: 11px; color: #059669;">Free shipping</div>'}
                ${isRealData ? '<div style="font-size: 10px; color: #059669; margin-top: 4px; font-weight: bold;">‚úì Real Purchase Data</div>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      grid.innerHTML = itemsHtml;
    }

    function setupEbayEventListeners() {
      const modal = document.getElementById('ebay-marketplace-modal');
      const closeBtn = document.getElementById('ebay-marketplace-close');
      const searchInput = document.getElementById('ebay-search');
      const categoryFilter = document.getElementById('ebay-category-filter');
      const brandFilter = document.getElementById('ebay-brand-filter');
      const conditionFilter = document.getElementById('ebay-condition-filter');
      const priceMinInput = document.getElementById('ebay-price-min');
      const priceMaxInput = document.getElementById('ebay-price-max');
      const selectAllBtn = document.getElementById('ebay-select-all');
      const selectNoneBtn = document.getElementById('ebay-select-none');
      const importBtn = document.getElementById('ebay-import-selected');
      
      // Close modal
      const closeModal = () => {
        modal.style.display = 'none';
        currentEbayItems = [];
        filteredEbayItems = [];
      };
      
      closeBtn.onclick = closeModal;
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      
      // Filter events
      const applyFilters = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const category = categoryFilter.value;
        const brand = brandFilter.value;
        const condition = conditionFilter.value;
        const minPrice = parseFloat(priceMinInput.value) || 0;
        const maxPrice = parseFloat(priceMaxInput.value) || Infinity;
        
        filteredEbayItems = currentEbayItems.filter(item => {
          const matchesSearch = item.title.toLowerCase().includes(searchTerm) || 
                               item.description.toLowerCase().includes(searchTerm);
          const matchesCategory = !category || item.category === category;
          const matchesBrand = !brand || item.brand === brand;
          const matchesCondition = !condition || item.condition === condition;
          const matchesPrice = item.price >= minPrice && item.price <= maxPrice;
          
          return matchesSearch && matchesCategory && matchesBrand && matchesCondition && matchesPrice;
        });
        
        renderEbayItems(filteredEbayItems);
        updateEbaySelectionCount();
      };
      
      searchInput.addEventListener('input', applyFilters);
      categoryFilter.addEventListener('change', applyFilters);
      brandFilter.addEventListener('change', applyFilters);
      conditionFilter.addEventListener('change', applyFilters);
      priceMinInput.addEventListener('input', applyFilters);
      priceMaxInput.addEventListener('input', applyFilters);
      
      // Selection events
      selectAllBtn.onclick = () => {
        filteredEbayItems.forEach(item => item.isSelected = true);
        renderEbayItems(filteredEbayItems);
        updateEbaySelectionCount();
      };
      
      selectNoneBtn.onclick = () => {
        filteredEbayItems.forEach(item => item.isSelected = false);
        renderEbayItems(filteredEbayItems);
        updateEbaySelectionCount();
      };
      
      // Item selection
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('ebay-item-checkbox')) {
          const itemId = e.target.getAttribute('data-id');
          const item = filteredEbayItems.find(i => i.id === itemId);
          if (item) {
            item.isSelected = e.target.checked;
            updateEbaySelectionCount();
          }
        }
        
        if (e.target.closest('.ebay-item-card')) {
          const card = e.target.closest('.ebay-item-card');
          const checkbox = card.querySelector('.ebay-item-checkbox');
          if (checkbox && e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            const itemId = checkbox.getAttribute('data-id');
            const item = filteredEbayItems.find(i => i.id === itemId);
            if (item) {
              item.isSelected = checkbox.checked;
              updateEbaySelectionCount();
            }
          }
        }
      });
      
      // Import selected items
      importBtn.onclick = async () => {
        const selectedItems = filteredEbayItems.filter(item => item.isSelected);
        
        if (selectedItems.length === 0) {
          showStatus('‚ùå Please select at least one item to import', 'error');
          return;
        }
        
        try {
          showStatus(`üì¶ Importing ${selectedItems.length} selected items...`, 'info');
          
          const response = await fetch('/api/ebay-import', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ selectedItems })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showStatus(`‚úÖ Import complete! ${result.data.imported} items imported successfully`, 'success');
            closeModal();
            
            // Reload purchases to show new data
            setTimeout(() => {
              loadPurchases();
            }, 1000);
          } else {
            showStatus(`‚ùå Import failed: ${result.message}`, 'error');
          }
        } catch (error) {
          console.error('Import error:', error);
          showStatus(`‚ùå Import failed: ${error.message}`, 'error');
        }
      };
    }

    function updateEbaySelectionCount() {
      const selectedCount = filteredEbayItems.filter(item => item.isSelected).length;
      const countElement = document.getElementById('ebay-selection-count');
      countElement.textContent = `${selectedCount} items selected`;
    }

    // Initialize OAuth integration
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîê Initializing OAuth integration for view-purchases...');
      
      // Create OAuth handler and API wrapper
      const EBAY_OAUTH_LOGIN_URL = 'https://stockpilot-ebay-oauth-production.up.railway.app/ebay-oauth/login';
      
      // OAuth Handler Class
      class OAuthHandler {
        constructor(oauthLoginUrl) {
          this.oauthLoginUrl = oauthLoginUrl;
          this.modalId = 'oauthRedirectModal';
          this.setupModal();
        }

        setupModal() {
          if (!document.getElementById(this.modalId)) {
            const modalHtml = `
              <div id="${this.modalId}" class="oauth-modal-backdrop" style="display:none;">
                <div class="oauth-modal-content">
                  <h2>üîê Authentication Required</h2>
                  <p>Your eBay session has expired or requires re-authentication.</p>
                  <p>Please click the button below to securely log in with eBay.</p>
                  <button id="oauthRedirectButton" class="btn btn-primary">üîë Login with eBay</button>
                </div>
              </div>
              <style>
                .oauth-modal-backdrop {
                  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                  background-color: rgba(0,0,0,0.7); display: flex;
                  justify-content: center; align-items: center; z-index: 10000;
                }
                .oauth-modal-content {
                  background: #fff; padding: 30px; border-radius: 8px;
                  text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                  max-width: 400px; width: 90%;
                }
                .oauth-modal-content h2 { color: #333; margin-bottom: 15px; }
                .oauth-modal-content p { color: #555; margin-bottom: 20px; line-height: 1.5; }
                .oauth-modal-content button {
                  background-color: #0064d2; color: white; padding: 12px 24px;
                  border: none; border-radius: 6px; cursor: pointer;
                  font-size: 1rem; font-weight: 600; transition: background-color 0.3s ease;
                }
                .oauth-modal-content button:hover { background-color: #0056b3; }
              </style>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            document.getElementById('oauthRedirectButton').addEventListener('click', () => {
              window.location.href = this.oauthLoginUrl;
            });
          }
        }

        handleOAuthRequired(response) {
          if (response && response.oauth_required && response.redirect_required) {
            const modal = document.getElementById(this.modalId);
            if (modal) {
              modal.style.display = 'flex';
            }
            return true;
          }
          return false;
        }

        hideModal() {
          const modal = document.getElementById(this.modalId);
          if (modal) {
            modal.style.display = 'none';
          }
        }
      }

      // OAuth API Wrapper Class
      class OAuthAPIWrapper {
        constructor(oauthHandler) {
          this.oauthHandler = oauthHandler;
          this.baseUrl = 'https://stockpilot-ebay-oauth-production.up.railway.app';
        }

        async getPurchases(params = {}) {
          try {
            const url = `${this.baseUrl}/api/ebay/default_user/purchases?limit=${params.limit || 100}`;
            const response = await fetch(url);
            
            if (response.status === 401) {
              const errorData = await response.json();
              if (errorData.oauth_required) {
                return { oauth_required: true, ...errorData };
              }
            }
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || errorData.error || 'API request failed');
            }
            
            const data = await response.json();
            return data;
          } catch (error) {
            console.error('OAuth API Wrapper error:', error);
            throw error;
          }
        }
      }

      // Initialize OAuth system
      window.oauthHandler = new OAuthHandler(EBAY_OAUTH_LOGIN_URL);
      window.oauthApiWrapper = new OAuthAPIWrapper(window.oauthHandler);
      
      console.log('‚úÖ OAuth integration initialized');
    });
  </script>
</body>
</html>
