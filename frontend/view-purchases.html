<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StockPilot - Purchase Management & Staging</title>
  <style>
    /* Original page styling */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:15px; background:linear-gradient(135deg,#1a365d 0%,#2c5282 100%); min-height:100vh; }
    .container { max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 20px 40px rgba(26,54,93,0.15); overflow:hidden; }
    .header { display:flex; align-items:center; margin-bottom:0; background:rgba(255,255,255,0.95); padding:30px 25px 24px 25px; position:relative; }
    .header-logo { height:80px; position:absolute; left:25px; }
    .header-text { flex:1; text-align:center; }
    .header h1 { color:#1a365d; margin:0; font-size:1.8em; }
    .header p { margin:0; font-size:0.9em; color:#1a365d; }

    .nav-tabs-container { background:rgba(255,255,255,0.95); padding:12px 25px 0; position:relative; }
    .nav-tabs-container::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background:#1a365d; z-index:1; }
    .nav-tabs { display:flex; gap:2px; background:transparent; padding:0; margin:0; list-style:none; flex-wrap:nowrap; overflow-x:auto; }
    .nav-tab { background:linear-gradient(135deg,#F5F7FA,#E2E8F0); border:none; padding:10px 8px; cursor:pointer; transition:all .3s ease; text-decoration:none; color:#2D3748; font-weight:500; font-size:11px; border-radius:12px 12px 0 0; position:relative; text-align:center; display:flex; align-items:center; justify-content:center; gap:3px; flex:1; min-width:0; white-space:nowrap; }
    .nav-tab:hover { text-decoration:none; color:white; transform:translateY(-2px); box-shadow:0 6px 15px rgba(26,54,93,.2); }
    .nav-tab.active { transform:translateY(0); box-shadow:0 0 0 3px rgba(255,255,255,.8); }
    .nav-tab.home { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; }
    .nav-tab.purchases { background:linear-gradient(135deg,#67B292,#5A9B7F); color:white; }
    .nav-tab.inventory { background:linear-gradient(135deg,#3182CE,#2C5282); color:white; }
    .nav-tab.consumables { background:linear-gradient(135deg,#38A169,#2F855A); color:white; }
    .nav-tab.log-sale { background:linear-gradient(135deg,#48BB78,#38A169); color:white; }
    .nav-tab.sales { background:linear-gradient(135deg,#805AD5,#6B46C1); color:white; }
    .nav-tab.email-import { background:linear-gradient(135deg,#3182CE,#2B6CB0); color:white; }
    .nav-tab.reports { background:linear-gradient(135deg,#667EEA,#5A67D8); color:white; }
    .nav-tab.settings { background:linear-gradient(135deg,#2D3748,#1A202C); color:white; }

    .content-area { padding:8px 25px 25px 25px; background:#F8FAFC; }

    .status-bar-enhanced { background:white; color:#1a365d; padding:16px 20px; border-radius:12px; margin:5px 0; border:2px solid #1a365d; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px; box-shadow:0 2px 8px rgba(26,54,93,.1); }
    .status-item { display:flex; align-items:center; gap:8px; font-size:13px; font-weight:500; }
    .status-badge { background:rgba(26,54,93,.1); color:#1a365d; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600; margin-left:4px; }

    .recent-activity { background:white; border-radius:12px; padding:14px; margin:5px 0; border:1px solid #e5e7eb; box-shadow:0 2px 10px rgba(26,54,93,.08); overflow:visible; }
    .purchase-card { display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #f3f4f6; transition:all .2s ease; border-radius:6px; margin:2px 0; position:relative; }
    .purchase-card:last-child { border-bottom:none; }
    .purchase-card:hover { background:rgba(26,54,93,.05); }
    .purchase-icon { width:40px; height:40px; border-radius:50%; background:rgba(26,54,93,.1); display:flex; align-items:center; justify-content:center; margin-right:15px; font-size:16px; color:#1a365d; border:2px solid #1a365d; }
    .purchase-text { flex:1; font-size:13px; color:#1a365d; font-weight:500; cursor:pointer; padding:6px 10px; border-radius:6px; transition:all .2s ease; }
    .purchase-text:hover { background:rgba(26,54,93,.1); transform:translateX(2px); }
    .purchase-amount { font-weight:700; color:#1a365d; font-size:14px; margin-right:15px; }
    .staging-controls { display:flex; gap:8px; margin-left:auto; }
    .staging-btn { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; border:none; border-radius:20px; padding:6px 12px; font-size:10px; cursor:pointer; transition:all .2s ease; font-weight:600; text-transform:uppercase; }
    .staging-btn:hover { transform:scale(1.05); box-shadow:0 2px 8px rgba(26,54,93,.3); }
    .staging-btn.stage { background:linear-gradient(135deg,#67B292,#5A9B7F); }
    .staging-btn.split { background:linear-gradient(135deg,#3182CE,#2C5282); }
    .staging-btn.inventory { background:linear-gradient(135deg,#48BB78,#38A169); }

    .status { padding:12px 16px; border-radius:8px; margin:12px 0; font-weight:500; display:flex; align-items:center; gap:8px; font-size:.9rem; animation:slideIn .3s ease-out; }
    @keyframes slideIn { from { opacity:0; transform: translateX(-20px); } to { opacity:1; transform: translateX(0); } }
    .status.success { background:rgba(26,54,93,.1); color:#1a365d; border:1px solid rgba(26,54,93,.2); }
    .status.error { background:rgba(239,68,68,.1); color:#dc2626; border:1px solid rgba(239,68,68,.2); }
    .status.info { background:rgba(59,130,246,.1); color:#2563eb; border:1px solid rgba(59,130,246,.2); }

    .loading-spinner { width:20px; height:20px; border:3px solid #f3f4f6; border-top:3px solid #1a365d; border-radius:50%; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .error-message { text-align:center; padding:40px 20px; color:#dc2626; background:rgba(239,68,68,.1); border-radius:12px; margin:20px 0; }
    .retry-btn { background:linear-gradient(135deg,#1a365d,#2c5282); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; margin-top:15px; transition:all .3s ease; }
    .retry-btn:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(26,54,93,.3); }

    @media (max-width: 768px) {
      .status-bar-enhanced { flex-direction:column; gap:10px; }
      .purchase-card { flex-wrap:wrap; gap:10px; }
      .staging-controls { width:100%; justify-content:center; }
    }

    /* ===== Modal (CSP-safe) ‚Äî responsive ===== */
    body.no-scroll { overflow: hidden; }

    .mp-hidden { display: none !important; }

    .mp-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
      padding: 16px;
    }

    .mp-modal {
      width: clamp(320px, 96vw, 980px);
      max-height: min(90vh, 1000px);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      border: 2px solid #1a365d;
      display: flex; flex-direction: column;
      overflow: hidden;
      animation: mpPop .2s ease-out;
    }

    @keyframes mpPop { from { transform: scale(.98); opacity: .6 } to { transform: scale(1); opacity: 1 } }

    .mp-header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 16px 18px 10px 18px;
      position: sticky; top: 0; z-index: 1;
      background: #fff; border-bottom: 1px solid #edf2f7;
    }
    .mp-header h3 { color:#1a365d; margin:0; }

    .mp-close { background: transparent; border: 0; font-size: 18px; cursor: pointer; color:#1a365d; }

    .mp-content {
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px 18px;
    }

    .mp-form label { display:flex; flex-direction:column; gap:6px; font-size:12px; color:#1a365d; font-weight:600; }
    .mp-form input, .mp-form select, .mp-form textarea { border:1px solid #cbd5e1; border-radius:8px; padding:8px 10px; font-size:16px; }

    .mp-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; }
    .mp-span-2 { grid-column: 1 / -1; }

    .mp-actions {
      display:flex; justify-content:flex-end; gap:10px;
      padding: 10px 18px 16px 18px;
      position: sticky; bottom: 0; z-index: 1;
      background: linear-gradient(#fff, #fff);
      border-top: 1px solid #edf2f7;
    }

    .mp-btn { background: linear-gradient(135deg,#1a365d,#2c5282); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    .mp-btn[disabled] { opacity:.65; cursor:not-allowed; }
    .mp-btn-ghost { background:#eef2f7; color:#1a365d; }

    .mp-alert { padding:10px 12px; border-radius:8px; margin-bottom:8px; font-weight:600; }
    .mp-alert-error { background: rgba(239,68,68,.08); color:#b91c1c; border:1px solid rgba(239,68,68,.3); }

    @media (max-width: 480px), (max-height: 560px) {
      .mp-backdrop { align-items: stretch; padding: 0; }
      .mp-modal { width: 100vw; max-height: 100vh; border-radius: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <img src="images/stockpilot-logo.png" alt="StockPilot Logo" class="header-logo">
      <div class="header-text">
        <h1>üõí Purchase Management & Staging</h1>
        <p>View, manage, and stage your purchases for inventory processing</p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs-container">
      <div class="nav-tabs">
        <a href="index.html" class="nav-tab home">üè† Home</a>
        <a href="view-purchases.html" class="nav-tab purchases active">üõí Purchases</a>
        <a href="view-inventory.html" class="nav-tab inventory">üì¶ Inventory</a>
        <a href="view-consumables.html" class="nav-tab consumables">üß∞ Consumables</a>
        <a href="log-sale.html" class="nav-tab log-sale">üí∞ Log Sale</a>
        <a href="view-sales.html" class="nav-tab sales">üìä View Sales</a>
        <a href="email-import.html" class="nav-tab email-import">üìß Email Import</a>
        <a href="reports.html" class="nav-tab reports">üìà Reports</a>
        <a href="settings.html" class="nav-tab settings">‚öôÔ∏è Settings</a>
      </div>
    </div>

    <div class="content-area">
      <!-- Enhanced Status Bar -->
      <div class="status-bar-enhanced" id="status-bar">
        <div class="status-item">
          <span>üí∞</span>
          <span>Total Investment: <strong id="status-total-investment">Loading...</strong></span>
          <span class="status-badge" id="monthly-change">calculating...</span>
        </div>
        <div class="status-item">
          <span>üõí</span>
          <span><strong id="status-purchase-count">0</strong> purchases</span>
          <span class="status-badge" id="source-breakdown">loading...</span>
        </div>
        <div class="status-item">
          <span>üìä</span>
          <span>Average: <strong id="status-avg-purchase">¬£0.00</strong></span>
        </div>
        <div class="status-item">
          <span>üîÑ</span>
          <span>Last sync: <span id="last-sync">now</span></span>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="statusMessage"></div>

      <!-- Purchase History Section -->
      <div class="recent-activity">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0; color:#1a365d; font-size:18px; display:flex; align-items:center; gap:8px;">
            üìä Purchase History & Staging
            <span id="purchaseHistoryCount" class="status-badge">Loading...</span>
          </h3>
          <div style="display:flex; gap:8px;">
            <button id="btn-add-purchase" class="retry-btn" style="padding:6px 12px; font-size:.8rem;">‚ûï Add Purchase</button>
            <button id="btn-refresh" class="retry-btn" style="padding:6px 12px; font-size:.8rem;">üîÑ Refresh</button>
          </div>
        </div>

        <div id="purchaseHistoryContent">
          <div class="loading-spinner"></div>
          <p style="text-align:center; color:#1a365d; margin-top:10px;">Loading your purchase history...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- CSP-safe Modal -->
  <div id="mp-backdrop" class="mp-backdrop mp-hidden" role="dialog" aria-modal="true" aria-labelledby="mp-title">
    <div class="mp-modal">
      <div class="mp-header">
        <h3 id="mp-title">‚ûï Add Purchase (Manual)</h3>
        <button id="mp-close" class="mp-close" aria-label="Close">‚úñ</button>
      </div>

      <div class="mp-content">
        <div id="mp-error" class="mp-alert mp-alert-error mp-hidden"></div>

        <form id="mp-form" class="mp-form">
          <div class="mp-grid">
            <label>Identifier<input name="identifier" placeholder="ELECTRONICS-20250911-0001"></label>

            <!-- Category select with 'Add new‚Ä¶' -->
            <label>Category
              <select name="category" data-label="category"></select>
            </label>

            <!-- Brand select with 'Add new‚Ä¶' -->
            <label>Brand
              <select name="brand" data-label="brand"></select>
            </label>

            <label>Model<input name="model"></label>
            <label>Generation<input name="generation"></label>

            <!-- Source select with 'Add new‚Ä¶' -->
            <label>Source
              <select name="source" data-label="source"></select>
            </label>

            <label>Seller Username<input name="seller_username" placeholder="(Vinted/eBay)"></label>
            <label>Order ID<input name="order_id"></label>
            <label>Date of Purchase<input type="date" name="dateOfPurchase" required></label>
            <label>Price Paid (¬£)<input type="number" step="0.01" name="price_paid"></label>
            <label>Shipping (¬£)<input type="number" step="0.01" name="shipping_cost"></label>
            <label>Fees (¬£)<input type="number" step="0.01" name="fees"></label>
            <label>Tracking Ref<input name="tracking_ref"></label>

            <!-- Shipping provider select with 'Add new‚Ä¶' -->
            <label>Shipping Provider
              <select name="shipping_provider" data-label="shipping provider"></select>
            </label>

            <label>Status
              <select name="status">
                <option>Purchased</option>
                <option>Marked as despatched</option>
                <option>Delivered</option>
                <option>Verified</option>
                <option>Feedback left</option>
                <option>Returned</option>
              </select>
            </label>

            <label id="mp-return-wrapper" class="mp-span-2 mp-hidden">Return Reason<input name="return_reason"></label>
            <label>Parts Total<input type="number" min="0" name="parts_total"></label>
            <label class="mp-span-2">Photos (comma-separate URLs)<input name="photos" placeholder="https://.../p1.jpg, https://.../p2.jpg"></label>
            <label class="mp-span-2">Video URL<input name="video_url" placeholder="https://.../unboxing.mp4"></label>
            <label class="mp-span-2">Notes<textarea name="notes" rows="3"></textarea></label>
          </div>
        </form>
      </div>

      <div class="mp-actions">
        <button type="button" id="mp-cancel" class="mp-btn mp-btn-ghost">Cancel</button>
        <button type="submit" form="mp-form" id="mp-submit" class="mp-btn">Save Purchase</button>
      </div>
    </div>
  </div>

  <script>
    console.log('üõí StockPilot Purchase Management & Staging loaded');

    let currentPurchases = [];

    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('üöÄ Initializing purchase management...');
        loadPurchases();

        const addBtn = document.getElementById('btn-add-purchase');
        const refreshBtn = document.getElementById('btn-refresh');
        if (addBtn) addBtn.addEventListener('click', openManualPurchaseModal);
        if (refreshBtn) refreshBtn.addEventListener('click', loadPurchases);

        setupManualPurchaseModal();
      } catch (e) {
        console.error('Bootstrap error:', e);
        showStatus('‚ùå UI bootstrap error. Check console.', 'error');
      }
    });

    async function loadPurchases() {
      showLoading();
      try {
        const response = await fetch('/api/purchases');
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        }
        const data = await response.json();
        const purchases = data.purchases || data;
        if (!Array.isArray(purchases)) throw new Error('Invalid data format from /api/purchases');
        currentPurchases = purchases;
        displayPurchases(purchases);
        updateStatusBar(purchases);
        updatePurchaseHistoryCount(purchases);
        showStatus(`‚úÖ Successfully loaded ${purchases.length} purchases`, 'success');
      } catch (error) {
        console.error('‚ùå Error loading purchases:', error);
        showError(error);
      }
    }

    function showLoading() {
      const container = document.getElementById('purchaseHistoryContent');
      container.innerHTML = `
        <div class="loading-spinner"></div>
        <p style="text-align:center; color:#1a365d; margin-top:10px;">Loading your purchase history...</p>
      `;
    }

    function showError(error) {
      const container = document.getElementById('purchaseHistoryContent');
      container.innerHTML = `
        <div class="error-message">
          <h4>‚ùå Failed to Load Purchases</h4>
          <p><strong>Error:</strong> ${error.message}</p>
          <button class="retry-btn" id="btn-retry-load">üîÑ Try Again</button>
        </div>
      `;
      const retry = document.getElementById('btn-retry-load');
      if (retry) retry.addEventListener('click', loadPurchases);
      showStatus(`‚ùå Error loading purchases: ${error.message}`, 'error');
    }

    function displayPurchases(purchases) {
      const container = document.getElementById('purchaseHistoryContent');
      if (!purchases || purchases.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px 20px; color:#1a365d;">
            <h4>üì≠ No Purchases Found</h4>
            <button class="retry-btn" id="btn-retry-empty">üîÑ Try Again</button>
          </div>
        `;
        const btn = document.getElementById('btn-retry-empty');
        if (btn) btn.addEventListener('click', loadPurchases);
        return;
      }

      const cards = purchases.map(purchase => {
        const timeAgo = getTimeAgo(new Date(purchase.orderDate || purchase.purchase_date || purchase.createdAt));
        const platformEmoji = getPlatformEmoji(purchase.platform || 'Unknown');
        const total = (() => {
          const a = Number(purchase.totalAmount ?? NaN);
          const b = Number(purchase.total_paid ?? NaN);
          if (!isNaN(a)) return a;
          if (!isNaN(b)) return b;
          const c = (Number(purchase.price_paid||0) + Number(purchase.shipping_cost||0) + Number(purchase.fees||0));
          return c;
        })().toFixed(2);

        return `
          <div class="purchase-card" data-id="${purchase._id || purchase.id}">
            <div class="purchase-icon">${platformEmoji}</div>
            <div class="purchase-text">
              <div><strong>${purchase.supplier || purchase.brand || 'Unknown'} ${purchase.items?.[0]?.productName || purchase.model || 'Item'}</strong></div>
              <div style="font-size:11px; color:#666; margin-top:2px;">
                ${purchase.platform || 'Unknown'} ‚Ä¢ ${timeAgo} ‚Ä¢ ${purchase.category || 'Uncategorized'}
              </div>
            </div>
            <div class="purchase-amount">¬£${total}</div>
            <div class="staging-controls">
              <button class="staging-btn stage" data-action="stage" data-id="${purchase._id || purchase.id}">üîç Stage</button>
              <button class="staging-btn split" data-action="split" data-id="${purchase._id || purchase.id}">‚úÇÔ∏è Split</button>
              <button class="staging-btn inventory" data-action="inventory" data-id="${purchase._id || purchase.id}">üì¶ Inventory</button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = cards;

      container.onclick = (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'stage') showStatus('üîç Staging‚Ä¶','info');
        if (action === 'split') showStatus('‚úÇÔ∏è Splitting‚Ä¶','info');
        if (action === 'inventory') showStatus('üì¶ Added to inventory','success');
      };
    }

    function updateStatusBar(purchases) {
      const totalInvestment = purchases.reduce((sum, p) => {
        if (p.totalAmount != null) return sum + Number(p.totalAmount || 0);
        if (p.total_paid != null) return sum + Number(p.total_paid || 0);
        return sum + Number(p.price_paid || 0) + Number(p.shipping_cost || 0) + Number(p.fees || 0);
      }, 0);
      const averagePurchase = purchases.length ? totalInvestment / purchases.length : 0;

      document.getElementById('status-total-investment').textContent = `¬£${totalInvestment.toFixed(2)}`;
      document.getElementById('status-purchase-count').textContent = purchases.length;
      document.getElementById('status-avg-purchase').textContent = `¬£${averagePurchase.toFixed(2)}`;
      document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();

      const manual = purchases.filter(p => (p.source === 'manual') || !p.source).length;
      const auto = purchases.length - manual;
      document.getElementById('source-breakdown').textContent = `${manual} manual, ${auto} auto`;
      document.getElementById('monthly-change').textContent = '+12%';
    }

    function updatePurchaseHistoryCount(purchases) {
      document.getElementById('purchaseHistoryCount').textContent = `${purchases.length} items`;
    }

    function getPlatformEmoji(platform){ const e={ 'eBay':'üè™','Amazon':'üì¶','Vinted':'üëï','Facebook Marketplace':'üìò','Depop':'üõçÔ∏è','Gumtree':'üå≥'}; return e[platform]||'üõí'; }
    function getTimeAgo(date){ const now=new Date(); const s=Math.floor((now-date)/1000); if(s<60) return 'just now'; if(s<3600) return `${Math.floor(s/60)}m ago`; if(s<86400) return `${Math.floor(s/3600)}h ago`; if(s<604800) return `${Math.floor(s/86400)}d ago`; return `${Math.floor(s/604800)}w ago`; }
    function showStatus(message, type){ const el=document.getElementById('statusMessage'); el.innerHTML=`<div class="status ${type}">${message}</div>`; setTimeout(()=>{ el.innerHTML=''; },5000); }

    /* ===== Modal logic (no inline handlers, no external CDNs) ===== */
    function setupManualPurchaseModal() {
      const backdrop = document.getElementById('mp-backdrop');
      const closeBtn = document.getElementById('mp-close');
      const cancelBtn = document.getElementById('mp-cancel');
      const form = document.getElementById('mp-form');
      const errorEl = document.getElementById('mp-error');
      const statusSel = form.querySelector('select[name="status"]');
      const returnWrap = document.getElementById('mp-return-wrapper');

      // --- Dropdown lists with "Add new‚Ä¶" + localStorage persistence ---
      const LISTS = {
        category: { key:'sp_categories', defaults:['Electronics','Audio','Phones','Accessories','Tools','Clothing'] },
        brand: { key:'sp_brands', defaults:['Apple','Samsung','Sony','Bose','Generic'] },
        source: { key:'sp_sources', defaults:['Other','Auction','Vinted','Regular Stock','eBay','Amazon'] },
        shipping_provider: { key:'sp_shippers', defaults:['Royal Mail','EVRi','DPD','UPS','FedEx','DHL','Yodel','Parcelforce'] }
      };

      function loadList(key, defaults){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s) : defaults.slice(); }catch(_){ return defaults.slice(); } }
      function saveList(key, arr){ try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(_){} }

      function populateSelect(sel, items, selectedValue){
        sel.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = ''; placeholder.textContent = '-- Select --';
        sel.appendChild(placeholder);
        items.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          if (selectedValue && selectedValue === v) opt.selected = true;
          sel.appendChild(opt);
        });
        const add = document.createElement('option');
        add.value = '__add_new__'; add.textContent = '‚ûï Add new‚Ä¶';
        sel.appendChild(add);
      }

      function wireAddNew(sel, listCfg){
        sel.addEventListener('change', () => {
          if (sel.value !== '__add_new__') return;
          const label = sel.getAttribute('data-label') || 'item';
          const newItem = window.prompt(`Add new ${label}:`);
          if (newItem && newItem.trim()) {
            const clean = newItem.trim();
            const arr = loadList(listCfg.key, listCfg.defaults);
            if (!arr.includes(clean)) {
              arr.push(clean);
              arr.sort((a,b)=>a.localeCompare(b));
              saveList(listCfg.key, arr);
            }
            populateSelect(sel, arr, clean);
          } else {
            populateSelect(sel, loadList(listCfg.key, listCfg.defaults), '');
          }
        });
      }

      // Initialize dropdowns
      (function initDropdowns(){
        const cfgs = [
          { name:'category', ...LISTS.category },
          { name:'brand', ...LISTS.brand },
          { name:'source', ...LISTS.source },
          { name:'shipping_provider', ...LISTS.shipping_provider }
        ];
        cfgs.forEach(cfg => {
          const sel = form.querySelector(`select[name="${cfg.name}"]`);
          if (!sel) return;
          const arr = loadList(cfg.key, cfg.defaults);
          const selected = (cfg.name==='source' && arr.includes('Other')) ? 'Other' : '';
          populateSelect(sel, arr, selected);
          wireAddNew(sel, cfg);
        });
      })();

      // default date today
      const dateInput = form.querySelector('input[name="dateOfPurchase"]');
      dateInput.value = new Date().toISOString().slice(0,10);

      statusSel.addEventListener('change', () => {
        const show = statusSel.value === 'Returned';
        returnWrap.classList.toggle('mp-hidden', !show);
      });

      function hideError(){ errorEl.classList.add('mp-hidden'); errorEl.textContent=''; }
      function showErrorMsg(msg){ errorEl.textContent = `‚ùå ${msg}`; errorEl.classList.remove('mp-hidden'); }

      closeBtn.addEventListener('click', closeManualPurchaseModal);
      cancelBtn.addEventListener('click', closeManualPurchaseModal);
      backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeManualPurchaseModal(); });
      document.addEventListener('keydown', (e)=>{ if(!backdrop.classList.contains('mp-hidden') && e.key==='Escape') closeManualPurchaseModal(); });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const dateVal = form.dateOfPurchase.value;
        if (!dateVal) { showErrorMsg('Date of purchase is required.'); return; }
        const nn = (v) => v === '' || v === null || isNaN(Number(v)) ? 0 : Number(v);
        if (nn(form.price_paid.value) < 0) { showErrorMsg('Price paid cannot be negative.'); return; }
        if (nn(form.shipping_cost.value) < 0) { showErrorMsg('Shipping cost cannot be negative.'); return; }
        if (nn(form.fees.value) < 0) { showErrorMsg('Fees cannot be negative.'); return; }

        const photosArr = (form.photos.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        const payload = {
          identifier: form.identifier.value || undefined,
          category: form.category.value || undefined,
          brand: form.brand.value || undefined,
          model: form.model.value || undefined,
          generation: form.generation.value || undefined,
          source: form.source.value || 'Other',
          seller_username: form.seller_username.value || undefined,
          order_id: form.order_id.value || undefined,
          dateOfPurchase: dateVal,
          price_paid: form.price_paid.value === '' ? 0 : Number(form.price_paid.value),
          shipping_cost: form.shipping_cost.value === '' ? 0 : Number(form.shipping_cost.value),
          fees: form.fees.value === '' ? 0 : Number(form.fees.value),
          tracking_ref: form.tracking_ref.value || undefined,
          shipping_provider: form.shipping_provider.value || undefined,
          status: form.status.value,
          return_reason: form.status.value === 'Returned' ? (form.return_reason.value || '') : undefined,
          parts_total: form.parts_total.value === '' ? undefined : Number(form.parts_total.value),
          photos: photosArr,
          video_url: form.video_url.value || undefined,
          notes: form.notes.value || undefined
        };

        const submitBtn = document.getElementById('mp-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving‚Ä¶';

        try {
          const res = await fetch('/api/purchases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          showStatus('‚úÖ Purchase saved', 'success');
          closeManualPurchaseModal();
          if (window.loadPurchases) loadPurchases();
        } catch (err) {
          showErrorMsg(err.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Purchase';
        }
      });
    }

    function openManualPurchaseModal(){
      document.getElementById('mp-backdrop').classList.remove('mp-hidden');
      document.body.classList.add('no-scroll');
    }
    function closeManualPurchaseModal(){
      document.getElementById('mp-backdrop').classList.add('mp-hidden');
      document.body.classList.remove('no-scroll');
    }
  </script>
</body>
</html>
