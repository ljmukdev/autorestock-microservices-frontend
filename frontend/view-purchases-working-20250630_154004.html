<!--
* File: view-purchases.html
* Location: Root directory
* Purpose: Purchase Management with Personal AI Learning & Enhanced Multi-Source Email Import
* Dependencies: Backend AI API, Personal AI Learning System, Enhanced Email Import API
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoRestock - AI-Enhanced Purchase Management</title>
    <style>
        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(26, 54, 93, 0.15);
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 18px 25px 12px 25px;
            position: relative;
        }

        .header-logo {
            height: 45px;
            position: absolute;
            left: 25px;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: #1a365d;
            margin: 0;
            font-size: 1.8em;
        }

        .header p {
            margin: 0;
            font-size: 0.9em;
            color: #1a365d;
        }

        /* Navigation */
        .nav-tabs-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 25px 0;
            position: relative;
        }

        .nav-tabs-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #67B292;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            gap: 2px;
            background: transparent;
            padding: 0;
            margin: 0;
            list-style: none;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .nav-tab {
            background: linear-gradient(135deg, #F5F7FA, #E2E8F0);
            border: none;
            padding: 10px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #2D3748;
            font-weight: 500;
            font-size: 11px;
            border-radius: 12px 12px 0 0;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }

        .nav-tab:hover {
            text-decoration: none;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 54, 93, 0.2);
        }

        .nav-tab.active {
            transform: translateY(0);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8);
        }

        /* Navigation colors */
        .nav-tab.home { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; }
        .nav-tab.purchases { background: linear-gradient(135deg, #67B292, #5A9B7F); color: white; }
        .nav-tab.inventory { background: linear-gradient(135deg, #3182CE, #2C5282); color: white; }
        .nav-tab.consumables { background: linear-gradient(135deg, #38A169, #2F855A); color: white; }
        .nav-tab.log-sale { background: linear-gradient(135deg, #48BB78, #38A169); color: white; }
        .nav-tab.sales { background: linear-gradient(135deg, #805AD5, #6B46C1); color: white; }
        .nav-tab.email-import { background: linear-gradient(135deg, #3182CE, #2B6CB0); color: white; }
        .nav-tab.reports { background: linear-gradient(135deg, #667EEA, #5A67D8); color: white; }
        .nav-tab.settings { background: linear-gradient(135deg, #2D3748, #1A202C); color: white; }

        .content-area {
            padding: 8px 25px 25px 25px;
            background: #F8FAFC;
        }

        /* AI Enhancement Notice */
        .ai-notice {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 5px 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
        }

        .ai-notice-icon {
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Status Bar */
        .status-bar-enhanced {
            background: white;
            color: #1a365d;
            padding: 16px 20px;
            border-radius: 12px;
            margin: 5px 0;
            border: 2px solid #67B292;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(103, 178, 146, 0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-badge {
            background: rgba(103, 178, 146, 0.1);
            color: #67B292;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Quick Actions */
        .quick-actions-dashboard {
            background: linear-gradient(135deg, #67B292, #5A9B7F);
            color: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(103, 178, 146, 0.2);
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .quick-action-item {
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .quick-action-item h4 {
            margin: 0 0 6px 0;
            font-size: 13px;
            font-weight: 600;
        }
        
        .quick-action-item p {
            margin: 0;
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.4;
        }

        /* Form styling */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 12px 0;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(103, 178, 146, 0.08);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section.show {
            display: block;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #67B292;
        }

        .demo-data-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #1a365d;
            font-size: 0.9rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #FFFFFF;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #67B292;
            box-shadow: 0 0 0 3px rgba(103, 178, 146, 0.1);
            transform: translateY(-1px);
        }

        .form-group input[readonly] {
            background: #f8f9fa;
            color: #67B292;
            font-weight: 600;
        }

        /* AI Smart Form Styles */
        .ai-enhanced-field {
            position: relative;
        }

        .ai-suggestion-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);
        }

        .ai-suggestion-btn:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .ai-suggestion-btn.loading {
            animation: spin 1s linear infinite;
        }

        .ai-suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #8B5CF6;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }

        .ai-suggestions-dropdown.show {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-suggestion-item:last-child {
            border-bottom: none;
        }

        .ai-suggestion-item:hover {
            background: rgba(139, 92, 246, 0.1);
            color: #7C3AED;
        }

        .ai-suggestion-text {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .ai-suggestion-badge {
            background: rgba(139, 92, 246, 0.1);
            color: #7C3AED;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Custom Platform Styles */
        .custom-platform-container {
            display: none;
            margin-top: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 2px solid #0ea5e9;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
            animation: slideDown 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .custom-platform-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #06b6d4, #0891b2);
            animation: shimmer 2s infinite;
        }

        .custom-platform-container.show {
            display: block;
        }

        .custom-platform-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .custom-platform-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.1);
        }

        .custom-platform-input:focus {
            outline: none;
            border-color: #0284c7;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), 0 4px 8px rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
        }

        .custom-platform-input::placeholder {
            color: #64748b;
            font-style: italic;
        }

        .custom-platform-hint {
            font-size: 0.85rem;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(14, 165, 233, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid #0ea5e9;
        }

        .custom-platform-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-platform-btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
        }

        .add-platform-btn:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }

        .cancel-platform-btn {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-platform-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }

        /* Custom Brand Styles */
        .custom-brand-container {
            display: none;
            margin-top: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 2px solid #0ea5e9;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
            animation: slideDown 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .custom-brand-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #06b6d4, #0891b2);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .custom-brand-container.show {
            display: block;
        }

        .custom-brand-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #0369a1;
            font-size: 0.9rem;
        }

        .custom-brand-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.1);
        }

        .custom-brand-input:focus {
            outline: none;
            border-color: #0284c7;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), 0 4px 8px rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
        }

        .custom-brand-input::placeholder {
            color: #64748b;
            font-style: italic;
        }

        .custom-brand-hint {
            font-size: 0.85rem;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(14, 165, 233, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid #0ea5e9;
        }

        .custom-brand-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .add-brand-btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.2);
        }

        .add-brand-btn:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }

        .cancel-brand-btn {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-brand-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .ai-status-indicator {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #7C3AED;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.8rem;
            display: none;
        }

        .ai-status-indicator.show {
            display: block;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #67B292, #5A9B7F);
            color: white;
            box-shadow: 0 2px 4px rgba(103, 178, 146, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(103, 178, 146, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #1a365d;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        /* Status messages */
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .status.success {
            background: rgba(103, 178, 146, 0.1);
            color: #67B292;
            border: 1px solid rgba(103, 178, 146, 0.2);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status.info {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* Purchase History Styles */
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin: 5px 0;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(26, 54, 93, 0.08);
            overflow: visible;
        }

        .purchase-card {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            border-radius: 6px;
            margin: 2px 0;
        }

        .purchase-card:last-child {
            border-bottom: none;
        }

        .purchase-card:hover {
            background: rgba(103, 178, 146, 0.05);
        }

        .purchase-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(103, 178, 146, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: #67B292;
        }

        .purchase-text {
            flex: 1;
            font-size: 12px;
            color: #1a365d;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .purchase-text:hover {
            background: rgba(103, 178, 146, 0.1);
            transform: translateX(2px);
        }

        .purchase-time {
            font-size: 10px;
            color: #67B292;
            font-weight: 600;
            margin-left: 8px;
        }

        .purchase-platform {
            font-size: 10px;
            color: #67B292;
            margin-right: 8px;
            opacity: 0.8;
        }

        .purchase-status {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-right: 8px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            min-width: 70px;
            text-align: center;
        }

        .purchase-status:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .purchase-status::after {
            content: '‚ñº';
            margin-left: 4px;
            font-size: 8px;
            opacity: 0.7;
        }

        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-in-transit { background: #dbeafe; color: #1e40af; }
        .status-dispatched { background: #fef3c7; color: #92400e; }
        .status-paid { background: #e0e7ff; color: #3730a3; }
        .status-ordered { background: #f3f4f6; color: #374151; }

        .edit-btn {
            background: linear-gradient(135deg, #67B292, #5A9B7F);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            opacity: 0.7;
        }

        .edit-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(103, 178, 146, 0.3);
        }

        /* Parts Management Styles */
        .parts-management {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .parts-management.show {
            display: block;
        }

        .parts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #64748b;
        }

        .parts-header h4 {
            margin: 0;
            color: #1e293b;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parts-toggle-btn {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .parts-toggle-btn:hover {
            background: linear-gradient(135deg, #475569, #334155);
            transform: translateY(-1px);
        }

        .parts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .parts-grid.header {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .parts-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .parts-input:focus {
            outline: none;
            border-color: #64748b;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.1);
        }

        .parts-condition-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.3s ease;
        }

        .parts-condition-select:focus {
            outline: none;
            border-color: #64748b;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.1);
        }

        .add-part-btn {
            background: linear-gradient(135deg, #67B292, #5A9B7F);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(103, 178, 146, 0.2);
        }

        .add-part-btn:hover {
            background: linear-gradient(135deg, #5A9B7F, #4A8B6F);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(103, 178, 146, 0.3);
        }

        .remove-part-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .remove-part-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: scale(1.1);
        }

        .parts-summary {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #1e40af;
        }

        .parts-empty {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }

        .part-condition-new { background: #dcfce7; color: #166534; }
        .part-condition-like-new { background: #dbeafe; color: #1e40af; }
        .part-condition-very-good { background: #e0f2fe; color: #0369a1; }
        .part-condition-good { background: #fef3c7; color: #92400e; }
        .part-condition-fair { background: #fed7aa; color: #c2410c; }
        .part-condition-poor { background: #fecaca; color: #dc2626; }
        .part-condition-broken { background: #f3f4f6; color: #374151; }

        /* Status Dropdown Styles */
        .status-dropdown {
            position: absolute;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 140px;
            display: none;
            animation: fadeInUp 0.2s ease;
        }

        .status-dropdown.show {
            display: block;
        }

        .status-dropdown.position-up {
            bottom: 100%;
            margin-bottom: 4px;
            animation: fadeInDown 0.2s ease;
        }

        .status-dropdown.position-down {
            top: 100%;
            margin-top: 4px;
            animation: fadeInUp 0.2s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:last-child {
            border-bottom: none;
        }

        .status-option:hover {
            background: #f8f9ff;
            transform: translateX(2px);
        }

        .status-option.current {
            background: rgba(103, 178, 146, 0.1);
            border-left: 3px solid #67B292;
        }

        /* Status option colors */
        .status-option.ordered { color: #374151; }
        .status-option.ordered:hover { background: #f3f4f6; }

        .status-option.paid { color: #3730a3; }
        .status-option.paid:hover { background: #e0e7ff; }

        .status-option.dispatched { color: #92400e; }
        .status-option.dispatched:hover { background: #fef3c7; }

        .status-option.in-transit { color: #1e40af; }
        .status-option.in-transit:hover { background: #dbeafe; }

        .status-option.delivered { color: #065f46; }
        .status-option.delivered:hover { background: #d1fae5; }

        /* Email Import Styles */
        .email-import-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .email-import-item:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: #8B5CF6;
        }

        .email-import-item.selected {
            background: rgba(139, 92, 246, 0.1);
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .email-import-checkbox {
            margin-right: 12px;
            transform: scale(1.1);
        }

        .email-import-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
        }

        .email-import-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .email-import-title {
            font-weight: 600;
            color: #1a365d;
            font-size: 0.9rem;
        }

        .email-import-subtitle {
            font-size: 0.8rem;
            color: #64748b;
        }

        .email-import-price {
            font-weight: 600;
            color: #059669;
            font-size: 0.9rem;
        }

        .email-import-platform {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: #8B5CF6;
            color: white;
            font-weight: 500;
        }

        .email-import-actions {
            display: flex;
            gap: 6px;
        }

        .email-import-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .email-import-btn.view {
            background: #e0f2fe;
            color: #0369a1;
        }

        .email-import-btn.view:hover {
            background: #bae6fd;
        }

        .email-import-btn.import {
            background: #dcfce7;
            color: #166534;
        }

        .email-import-btn.import:hover {
            background: #bbf7d0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .parts-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .parts-grid.header {
                display: none;
            }
            
            .parts-input, .parts-condition-select {
                margin-bottom: 8px;
            }
            
            .email-import-content {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="images/autorestock-logo.png" alt="AutoRestock Logo" class="header-logo">
            <div class="header-text">
                <h1>üõí AI-Enhanced Purchase Management</h1>
                <p>Track your purchases with intelligent AI suggestions and multi-source imports</p>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab home">üè† Home</a>
                <a href="view-purchases.html" class="nav-tab purchases active">üõí Purchases</a>
                <a href="view-inventory.html" class="nav-tab inventory">üì¶ Inventory</a>
                <a href="view-consumables.html" class="nav-tab consumables">üß∞ Consumables</a>
                <a href="log-sale.html" class="nav-tab log-sale">üí∞ Log Sale</a>
                <a href="view-sales.html" class="nav-tab sales">üìä View Sales</a>
                <a href="email-import.html" class="nav-tab email-import">üìß Email Import</a>
                <a href="reports.html" class="nav-tab reports">üìà Reports</a>
                <a href="settings.html" class="nav-tab settings">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <div class="content-area">
            <!-- AI Enhancement Notice -->
            <div class="ai-notice" id="aiNotice">
                <div class="ai-notice-icon">ü§ñ</div>
                <div>
                    <strong>AI-Powered Smart Suggestions:</strong> Click the purple AI buttons next to fields for intelligent suggestions based on context.
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar-enhanced" id="status-bar">
                <div class="status-item">
                    <span>üí∞</span>
                    <span>Investment: <strong id="status-total-investment">¬£0.00</strong></span>
                    <span class="status-badge" id="monthly-change">+0%</span>
                </div>
                <div class="status-item">
                    <span>üõí</span>
                    <span><strong id="status-purchase-count">0</strong> purchases</span>
                </div>
                <div class="status-item">
                    <span>üìä</span>
                    <span>Average: <strong id="status-avg-purchase">¬£0.00</strong></span>
                </div>
                <div class="status-item">
                    <span>üîÑ</span>
                    <span>Last sync: <span id="last-sync">checking...</span></span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-dashboard">
                <h3 style="margin: 0 0 8px 0; font-size: 16px;">‚öôÔ∏è AI-Enhanced Purchase Controls</h3>
                <div class="quick-actions-grid">
                    <div class="quick-action-item" onclick="toggleAddForm()">
                        <h4>‚ûï Add Purchase</h4>
                        <p>Record a new purchase with AI assistance</p>
                    </div>
                    <div class="quick-action-item" onclick="fillDemoData()">
                        <h4>üéØ Demo Data</h4>
                        <p>Fill form with sample data to test AI features</p>
                    </div>
                    <div class="quick-action-item" onclick="addPersonalShortcut()">
                        <h4>üß† Add Shortcut</h4>
                        <p>Teach AI your personal abbreviations</p>
                    </div>
                    <div class="quick-action-item" onclick="exportData()">
                        <h4>üì§ Export Data</h4>
                        <p>Download purchase history as CSV</p>
                    </div>
                    <div class="quick-action-item" onclick="loadPurchases()">
                        <h4>üîÑ Refresh</h4>
                        <p>Reload purchase data from backend</p>
                    </div>
                </div>
            </div>

            <!-- Add Purchase Form -->
            <div class="form-section" id="addPurchaseSection">
                <div class="form-header">
                    <h3 style="margin: 0; color: #67B292; font-size: 18px;">üìù Add New Purchase with Personal AI</h3>
                    <button type="button" class="demo-data-btn" onclick="fillDemoData()">üé≤ Fill Demo Data</button>
                </div>
                <form id="purchaseForm" onsubmit="savePurchase(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="purchaseDate">Purchase Date</label>
                            <input type="date" id="purchaseDate" name="purchase_date" required>
                        </div>
                        <div class="form-group ai-enhanced-field">
                            <label for="platform">Platform/Source</label>
                            <select id="platform" name="platform" required onchange="handlePlatformChange()">
                                <option value="">Select platform...</option>
                                <option value="eBay">eBay</option>
                                <option value="Amazon">Amazon</option>
                                <option value="Vinted">Vinted</option>
                                <option value="Facebook Marketplace">Facebook Marketplace</option>
                                <option value="Depop">Depop</option>
                                <option value="Gumtree">Gumtree</option>
                                <option value="CUSTOM_PLATFORM">+ Other (Add New Platform)</option>
                            </select>
                            <button type="button" class="ai-suggestion-btn" onclick="getEnhancedAISuggestions('platform')" title="Get AI suggestions">ü§ñ</button>
                            <div class="ai-suggestions-dropdown" id="platformSuggestions"></div>
                            <div class="ai-status-indicator" id="platformAIStatus"></div>
                            
                            <!-- Custom Platform Input Container -->
                            <div class="custom-platform-container" id="customPlatformContainer">
                                <div class="custom-platform-header">
                                    <span>üè™</span>
                                    <span>Add New Platform</span>
                                </div>
                                <input type="text" 
                                       id="customPlatformInput" 
                                       class="custom-platform-input" 
                                       placeholder="Enter platform name (e.g., Mercari, Etsy, Local Shop, Car Boot Sale)"
                                       onkeypress="handleCustomPlatformKeypress(event)">
                                <div class="custom-platform-hint">
                                    <span>‚ö°</span>
                                    <span>Press Enter or click Add to save this platform for future use</span>
                                </div>
                                <div class="custom-platform-actions">
                                    <button type="button" class="add-platform-btn" onclick="addCustomPlatform()">
                                        <span>‚ûï</span>
                                        <span>Add Platform</span>
                                    </button>
                                    <button type="button" class="cancel-platform-btn" onclick="cancelCustomPlatform()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="brand">Brand</label>
                            <select id="brand" name="brand" required onchange="handleBrandChange()">
                                <option value="">Select brand...</option>
                                <option value="Apple">Apple</option>
                                <option value="Samsung">Samsung</option>
                                <option value="Sony">Sony</option>
                                <option value="Nike">Nike</option>
                                <option value="Adidas">Adidas</option>
                                <option value="CUSTOM_BRAND">+ Other (Add New Brand)</option>
                            </select>
                            
                            <!-- Custom Brand Input Container -->
                            <div class="custom-brand-container" id="customBrandContainer">
                                <div class="custom-brand-header">
                                    <span>üè∑Ô∏è</span>
                                    <span>Add New Brand</span>
                                </div>
                                <input type="text" 
                                       id="customBrandInput" 
                                       class="custom-brand-input" 
                                       placeholder="Enter brand name (e.g., Tesla, Nintendo, Zara)"
                                       onkeypress="handleCustomBrandKeypress(event)">
                                <div class="custom-brand-hint">
                                    <span>‚ö°</span>
                                    <span>Press Enter or click Add to save this brand for future use</span>
                                </div>
                                <div class="custom-brand-actions">
                                    <button type="button" class="add-brand-btn" onclick="addCustomBrand()">
                                        <span>‚ûï</span>
                                        <span>Add Brand</span>
                                    </button>
                                    <button type="button" class="cancel-brand-btn" onclick="cancelCustomBrand()">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group ai-enhanced-field">
                            <label for="model">Model * (Try: APP1, IP15, MBP)</label>
                            <input type="text" id="model" name="model" placeholder="e.g., APP1 for AirPods Pro 1st Gen" required onchange="handleModelChange()">
                            <button type="button" class="ai-suggestion-btn" onclick="getEnhancedAISuggestions('model')" title="Get AI suggestions">ü§ñ</button>
                            <div class="ai-suggestions-dropdown" id="modelSuggestions"></div>
                            <div class="ai-status-indicator" id="modelAIStatus"></div>
                        </div>
                        <div class="form-group ai-enhanced-field">
                            <label for="category">Category</label>
                            <select id="category" name="category">
                                <option value="">Select category...</option>
                                <option value="Audio & Headphones">Audio & Headphones</option>
                                <option value="Smartphones">Smartphones</option>
                                <option value="Athletic Shoes">Athletic Shoes</option>
                                <option value="Electronics">Electronics</option>
                            </select>
                            <button type="button" class="ai-suggestion-btn" onclick="getEnhancedAISuggestions('category')" title="Get AI suggestions">ü§ñ</button>
                            <div class="ai-suggestions-dropdown" id="categorySuggestions"></div>
                            <div class="ai-status-indicator" id="categoryAIStatus"></div>
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice">Item Price (¬£)</label>
                            <input type="number" id="purchasePrice" name="purchase_price" step="0.01" min="0" placeholder="0.00" oninput="updateTotalPaid()">
                        </div>
                        <div class="form-group">
                            <label for="shippingCost">Shipping Cost (¬£)</label>
                            <input type="number" id="shippingCost" name="shipping_cost" step="0.01" min="0" value="0" placeholder="0.00" oninput="updateTotalPaid()">
                        </div>
                        <div class="form-group">
                            <label for="totalPaid">Total Paid (¬£)</label>
                            <input type="number" id="totalPaid" name="total_paid" step="0.01" min="0" readonly placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label for="deliveryStatus">Delivery Status</label>
                            <select id="deliveryStatus" name="delivery_status" required>
                                <option value="Ordered">Ordered</option>
                                <option value="Paid">Paid</option>
                                <option value="Dispatched">Dispatched</option>
                                <option value="In Transit">In Transit</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" placeholder="Additional notes about this purchase..."></textarea>
                    </div>

                    <!-- Parts Management Section -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <label style="margin: 0; flex: 1;">Item Parts Breakdown</label>
                            <button type="button" class="parts-toggle-btn" onclick="togglePartsManagement()">
                                <span id="partsToggleIcon">üì¶</span>
                                <span id="partsToggleText">Add Parts</span>
                            </button>
                        </div>
                        
                        <div class="parts-management" id="partsManagement">
                            <div class="parts-header">
                                <h4>
                                    <span>üîß</span>
                                    <span>Break Down Item into Parts</span>
                                </h4>
                                <span id="partsCount" style="background: rgba(100, 116, 139, 0.1); padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; color: #475569;">0 parts</span>
                            </div>
                            
                            <div class="parts-grid header">
                                <div>Part Name/Description</div>
                                <div>Quantity</div>
                                <div>Claimed Condition</div>
                                <div>Est. Value (¬£)</div>
                                <div>Action</div>
                            </div>
                            
                            <div id="partsContainer">
                                <div class="parts-empty">
                                    <p>üîß No parts added yet</p>
                                    <p style="font-size: 0.85rem; margin-top: 8px;">Perfect for lots, bundles, or items you plan to break down for parts</p>
                                </div>
                            </div>
                            
                            <button type="button" class="add-part-btn" onclick="addPart()">
                                <span>‚ûï</span>
                                <span>Add Part</span>
                            </button>
                            
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <button type="button" 
                                        class="btn btn-secondary" 
                                        onclick="autoCalculatePartValues()"
                                        style="padding: 8px 16px; font-size: 0.85rem;"
                                        title="Divide total cost equally among all parts">
                                    üßÆ Auto-Calculate Values
                                </button>
                            </div>
                            
                            <div class="parts-summary" id="partsSummary" style="display: none;">
                                <span>Total Parts: <strong id="totalPartsCount">0</strong></span>
                                <span>Total Items: <strong id="totalItemsCount">0</strong></span>
                                <span>Est. Parts Value: <strong>¬£<span id="totalPartsValue">0.00</span></strong></span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <span id="saveIcon">üíæ</span>
                            <span id="saveText">Save Purchase</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset</button>
                    </div>
                </form>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage"></div>

            <!-- Enhanced Multi-Source Email Import Management Section -->
            <div class="recent-activity" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; color: #1a365d; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                        üìß Multi-Source Email Import 
                        <span id="emailImportCount" class="status-badge" style="background: #8B5CF6; color: white;">0 items</span>
                    </h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="refreshEmailImports()" style="padding: 6px 12px; font-size: 0.8rem;">
                            üîÑ Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="toggleEmailImportsView()" style="padding: 6px 12px; font-size: 0.8rem;">
                            <span id="emailToggleText">üëÅÔ∏è Show Items</span>
                        </button>
                        <button class="btn btn-primary" onclick="bulkImportSelected()" style="padding: 6px 12px; font-size: 0.8rem;">
                            ‚ûï Import Selected
                        </button>
                    </div>
                </div>
                
                <div id="emailImportsContainer" style="display: none;">
                    <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #8B5CF6;">
                        <div style="display: flex; align-items: center; gap: 12px; font-size: 0.85rem;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="selectAllEmailImports" onchange="toggleSelectAllEmailImports()">
                                <strong>Select All</strong>
                            </label>
                            <span style="color: #64748b;">|</span>
                            <span>üí∞ Total: <strong>¬£<span id="selectedTotal">0.00</span></strong></span>
                        </div>
                    </div>
                    
                    <div id="emailImportsList">
                        <p style="text-align: center; color: #64748b; font-style: italic; padding: 20px;">
                            Click "üîÑ Refresh" to load your email import items from multiple sources
                        </p>
                    </div>
                </div>
            </div>

            <!-- Purchase History Section -->
            <div class="recent-activity">
                <h3 style="margin: 0 0 8px 0; color: #1a365d; font-size: 13px;">üìä Purchase History</h3>
                <div id="purchaseHistoryContent">
                    <p>Loading purchase history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üõí AI-Enhanced Purchase Management with Multi-Source Email Import page loaded');

        // Base AI Smart Form Integration
        class AISmartForm {
            constructor() {
                this.isEnabled = false;
                this.checkAIStatus();
            }

            async checkAIStatus() {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    this.isEnabled = data.aiEnabled || false;
                    console.log('ü§ñ AI Status:', this.isEnabled ? 'Enabled' : 'Disabled');
                    this.updateAINotice();
                } catch (error) {
                    console.log('ü§ñ AI Status: Unavailable');
                    this.isEnabled = false;
                    this.updateAINotice();
                }
            }

            updateAINotice() {
                const notice = document.getElementById('aiNotice');
                if (this.isEnabled) {
                    notice.style.background = 'linear-gradient(135deg, #10B981, #059669)';
                    notice.innerHTML = `
                        <div class="ai-notice-icon">ü§ñ</div>
                        <div><strong>AI-Powered Smart Suggestions:</strong> Click the purple AI buttons next to fields for intelligent suggestions based on context.</div>
                    `;
                } else {
                    notice.style.background = 'linear-gradient(135deg, #F59E0B, #D97706)';
                    notice.innerHTML = `
                        <div class="ai-notice-icon">‚ö†Ô∏è</div>
                        <div><strong>AI Offline:</strong> Using local suggestions. Configure OpenAI API key for full AI functionality.</div>
                    `;
                }
            }

            async getSuggestions(fieldType, context = {}) {
                if (!this.isEnabled) {
                    return {
                        success: true,
                        suggestions: this.getLocalSuggestions(fieldType, context),
                        source: 'local'
                    };
                }

                try {
                    const response = await fetch('/api/ai/suggest', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fieldType,
                            input: document.getElementById(fieldType)?.value || '',
                            context
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    return {
                        success: data.success,
                        suggestions: data.suggestions || [],
                        source: data.source || 'ai'
                    };

                } catch (error) {
                    console.error('AI suggestion error:', error);
                    return {
                        success: true,
                        suggestions: this.getLocalSuggestions(fieldType, context),
                        source: 'fallback'
                    };
                }
            }

            async autoDetectCategory(brand, model) {
                if (!this.isEnabled || !brand || !model) return null;

                try {
                    const response = await fetch('/api/ai/detect-category', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ brand, model })
                    });

                    const data = await response.json();
                    return data.success ? data.category : null;

                } catch (error) {
                    console.error('AI category detection error:', error);
                    return null;
                }
            }

            getLocalSuggestions(fieldType, context) {
                const suggestions = {
                    brand: ['Apple', 'Samsung', 'Sony', 'Nike', 'Adidas'],
                    model: context.brand ? this.getBrandModels(context.brand) : ['iPhone 15', 'Galaxy S24', 'AirPods Pro'],
                    category: ['Electronics', 'Smartphones', 'Audio & Headphones', 'Gaming', 'Clothing']
                };
                return suggestions[fieldType] || [];
            }

            getBrandModels(brand) {
                const brandModels = {
                    'Apple': ['iPhone 15 Pro Max', 'iPhone 15 Pro', 'MacBook Pro 16"', 'iPad Pro', 'AirPods Pro (2nd gen)'],
                    'Samsung': ['Galaxy S24 Ultra', 'Galaxy S24', 'Galaxy Buds Pro', 'Galaxy Tab S9'],
                    'Sony': ['PlayStation 5', 'WH-1000XM5', 'Alpha A7 IV', 'Bravia XR TV'],
                    'Nike': ['Air Force 1', 'Air Max 270', 'Jordan 1 Retro'],
                    'Adidas': ['Ultraboost 22', 'Stan Smith', 'Yeezy Boost 350 V2']
                };
                return brandModels[brand] || [`${brand} Product 1`, `${brand} Product 2`];
            }
        }

        // Enhanced Personal AI Smart Form with Learning
        class PersonalAISmartForm extends AISmartForm {
            constructor() {
                super();
                this.personalLearningEnabled = true;
                this.learningCache = new Map();
                this.loadUserShortcuts();
            }

            async loadUserShortcuts() {
                try {
                    const response = await fetch('/api/personal-ai/shortcuts');
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log(`üß† Loaded ${data.shortcuts.length} personal shortcuts`);
                        this.updatePersonalLearningStatus(data.shortcuts.length);
                    }
                } catch (error) {
                    console.log('Personal learning unavailable:', error);
                }
            }

            updatePersonalLearningStatus(shortcutCount) {
                const notice = document.getElementById('aiNotice');
                if (this.isEnabled && shortcutCount > 0) {
                    notice.style.background = 'linear-gradient(135deg, #7C3AED, #5B21B6)';
                    notice.innerHTML = `
                        <div class="ai-notice-icon">üß†</div>
                        <div><strong>Personal AI Learning Active:</strong> ${shortcutCount} shortcuts learned. Try "APP1", "IP15", "MBP" for instant results!</div>
                    `;
                }
            }

            async getSmartSuggestions(fieldType, context = {}) {
                const input = document.getElementById(fieldType)?.value || '';
                
                // Use personal learning AI first
                if (this.personalLearningEnabled && input.trim()) {
                    const personalResult = await this.getPersonalSuggestions(fieldType, input, context);
                    if (personalResult.success && personalResult.suggestions.length > 0) {
                        return personalResult;
                    }
                }

                // Fallback to regular AI
                return await super.getSuggestions(fieldType, context);
            }

            async getPersonalSuggestions(fieldType, input, context = {}) {
                try {
                    const response = await fetch('/api/personal-ai/smart-suggest', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fieldType,
                            input: input.trim(),
                            context
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Personal AI error: ${response.status}`);
                    }

                    return await response.json();

                } catch (error) {
                    console.error('Personal AI error:', error);
                    return { success: false, suggestions: [], source: 'error' };
                }
            }

            async confirmLearning(userInput, fieldType, selectedValue) {
                if (!this.personalLearningEnabled) return;

                try {
                    const response = await fetch('/api/personal-ai/confirm-learning', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userInput: userInput.trim(),
                            fieldType,
                            selectedValue
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showStatus(`üß† Learned: "${userInput}" = "${selectedValue}"`, 'success');
                        this.learningCache.set(`${fieldType}_${userInput.toUpperCase()}`, selectedValue);
                    }
                } catch (error) {
                    console.error('Learning confirmation error:', error);
                }
            }
        }

        // Parts Management System
        let partsData = [];
        let partIdCounter = 0;

        function togglePartsManagement() {
            const partsSection = document.getElementById('partsManagement');
            const toggleIcon = document.getElementById('partsToggleIcon');
            const toggleText = document.getElementById('partsToggleText');
            const isVisible = partsSection.classList.contains('show');
            
            if (isVisible) {
                partsSection.classList.remove('show');
                toggleIcon.textContent = 'üì¶';
                toggleText.textContent = 'Add Parts';
                showStatus('üîß Parts management closed', 'info');
            } else {
                partsSection.classList.add('show');
                toggleIcon.textContent = 'üìã';
                toggleText.textContent = 'Hide Parts';
                showStatus('üîß Parts management opened - break down your item!', 'info');
            }
        }

        function addPart() {
            const partId = ++partIdCounter;
            
            // Auto-calculate estimated value from total cost
            const totalCost = getTotalPurchaseCost();
            const currentPartsCount = partsData.length + 1; // +1 for the new part
            const autoEstimatedValue = totalCost > 0 ? (totalCost / currentPartsCount) : 0;
            
            const partData = {
                id: partId,
                name: '',
                quantity: 1,
                condition: 'Good',
                estimatedValue: parseFloat(autoEstimatedValue.toFixed(2))
            };
            
            partsData.push(partData);
            
            // Recalculate all existing parts with new division
            if (totalCost > 0) {
                partsData.forEach(part => {
                    part.estimatedValue = parseFloat((totalCost / partsData.length).toFixed(2));
                });
            }
            
            renderParts();
            
            // Focus on the new part name input
            setTimeout(() => {
                const newInput = document.querySelector(`#part-name-${partId}`);
                if (newInput) {
                    newInput.focus();
                }
            }, 100);
            
            const costMessage = totalCost > 0 ? ` (¬£${autoEstimatedValue.toFixed(2)} auto-calculated)` : '';
            showStatus(`‚ûï New part added${costMessage}`, 'success');
        }

        function getTotalPurchaseCost() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            return purchasePrice + shippingCost;
        }

        function autoCalculatePartValues() {
            const totalCost = getTotalPurchaseCost();
            if (totalCost > 0 && partsData.length > 0) {
                const valuePerPart = totalCost / partsData.length;
                partsData.forEach(part => {
                    part.estimatedValue = parseFloat(valuePerPart.toFixed(2));
                });
                renderParts();
                showStatus(`üßÆ Auto-calculated part values: ¬£${valuePerPart.toFixed(2)} each`, 'success');
            }
        }

        function removePart(partId) {
            partsData = partsData.filter(part => part.id !== partId);
            renderParts();
            updatePartsSummary();
            showStatus('üóëÔ∏è Part removed', 'info');
        }

        function updatePart(partId, field, value) {
            const part = partsData.find(p => p.id === partId);
            if (part) {
                part[field] = value;
                updatePartsSummary();
                
                // Auto-save indication
                if (field === 'name' && value.trim()) {
                    showStatus(`üíæ Part "${value}" saved`, 'success');
                }
            }
        }

        function renderParts() {
            const container = document.getElementById('partsContainer');
            
            if (partsData.length === 0) {
                container.innerHTML = `
                    <div class="parts-empty">
                        <p>üîß No parts added yet</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Perfect for lots, bundles, or items you plan to break down for parts</p>
                    </div>
                `;
            } else {
                container.innerHTML = partsData.map(part => `
                    <div class="parts-grid">
                        <input type="text" 
                               id="part-name-${part.id}"
                               class="parts-input" 
                               placeholder="e.g., Left AirPod, Screen, Battery, Charger"
                               value="${part.name}"
                               onchange="updatePart(${part.id}, 'name', this.value)"
                               onblur="updatePart(${part.id}, 'name', this.value)">
                        <input type="number" 
                               class="parts-input" 
                               min="1" 
                               value="${part.quantity}"
                               onchange="updatePart(${part.id}, 'quantity', parseInt(this.value) || 1)">
                        <select class="parts-condition-select part-condition-${part.condition.toLowerCase().replace(/\s+/g, '-')}"
                                onchange="updatePart(${part.id}, 'condition', this.value); this.className = 'parts-condition-select part-condition-' + this.value.toLowerCase().replace(/\\s+/g, '-')"
                                title="Seller's claimed condition - verify upon receipt">
                            <option value="New" ${part.condition === 'New' ? 'selected' : ''}>New</option>
                            <option value="Like New" ${part.condition === 'Like New' ? 'selected' : ''}>Like New</option>
                            <option value="Very Good" ${part.condition === 'Very Good' ? 'selected' : ''}>Very Good</option>
                            <option value="Good" ${part.condition === 'Good' ? 'selected' : ''}>Good</option>
                            <option value="Fair" ${part.condition === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option value="Poor" ${part.condition === 'Poor' ? 'selected' : ''}>Poor</option>
                            <option value="Broken" ${part.condition === 'Broken' ? 'selected' : ''}>Broken</option>
                        </select>
                        <input type="number" 
                               class="parts-input" 
                               step="0.01" 
                               min="0" 
                               placeholder="Auto-calculated"
                               value="${part.estimatedValue}"
                               onchange="updatePart(${part.id}, 'estimatedValue', parseFloat(this.value) || 0)"
                               title="Auto-calculated from total cost √∑ parts, or enter custom value">
                        <button type="button" 
                                class="remove-part-btn" 
                                onclick="removePart(${part.id})"
                                title="Remove this part">√ó</button>
                    </div>
                `).join('');
            }
            
            updatePartsSummary();
        }

        function updatePartsSummary() {
            const partsCount = document.getElementById('partsCount');
            const summary = document.getElementById('partsSummary');
            const totalPartsCount = document.getElementById('totalPartsCount');
            const totalItemsCount = document.getElementById('totalItemsCount');
            const totalPartsValue = document.getElementById('totalPartsValue');
            
            const totalParts = partsData.length;
            const totalItems = partsData.reduce((sum, part) => sum + (part.quantity || 1), 0);
            const totalValue = partsData.reduce((sum, part) => sum + ((part.estimatedValue || 0) * (part.quantity || 1)), 0);
            
            partsCount.textContent = totalParts === 1 ? '1 part' : `${totalParts} parts`;
            
            if (totalParts > 0) {
                summary.style.display = 'flex';
                totalPartsCount.textContent = totalParts;
                totalItemsCount.textContent = totalItems;
                totalPartsValue.textContent = totalValue.toFixed(2);
            } else {
                summary.style.display = 'none';
            }
        }

        function getPartsData() {
            return partsData.filter(part => part.name.trim() !== '').map(part => ({
                name: part.name.trim(),
                quantity: part.quantity || 1,
                condition: part.condition,
                estimatedValue: part.estimatedValue || 0
            }));
        }

        function fillDemoPartsData() {
            // Add some example parts for the demo
            partsData = [
                { id: ++partIdCounter, name: 'Left AirPod', quantity: 1, condition: 'Good', estimatedValue: 45.00 },
                { id: ++partIdCounter, name: 'Right AirPod', quantity: 1, condition: 'Good', estimatedValue: 45.00 },
                { id: ++partIdCounter, name: 'Charging Case', quantity: 1, condition: 'Fair', estimatedValue: 25.00 },
                { id: ++partIdCounter, name: 'Lightning Cable', quantity: 1, condition: 'New', estimatedValue: 15.00 }
            ];
            renderParts();
            
            // Show parts management if not visible
            const partsSection = document.getElementById('partsManagement');
            if (!partsSection.classList.contains('show')) {
                togglePartsManagement();
            }
        }

        // Enhanced suggestion selection with learning
        function selectPersonalSuggestion(fieldType, suggestion, originalInput) {
            const field = document.getElementById(fieldType);
            const dropdown = document.getElementById(`${fieldType}Suggestions`);

            field.value = suggestion;
            dropdown.classList.remove('show');

            // Confirm learning if this was from user input
            if (originalInput && originalInput !== suggestion) {
                AI.confirmLearning(originalInput, fieldType, suggestion);
            }

            showStatus(`‚úÖ Selected: "${suggestion}"`, 'success');

            // Trigger related AI actions
            if (fieldType === 'brand' || fieldType === 'model') {
                handleModelChange();
            }
        }

        // Enhanced display suggestions with learning feedback and create shortcut option
        function displayPersonalSuggestions(fieldType, suggestions, source, originalInput = '') {
            console.log('üîç displayPersonalSuggestions called with:', { fieldType, suggestions, source, originalInput });
            
            const dropdown = document.getElementById(`${fieldType}Suggestions`);
            dropdown.innerHTML = '';

            // Add AI suggestions first
            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'ai-suggestion-item';
                
                // Special styling for personal matches
                const isPersonal = source.includes('personal');
                const badgeText = isPersonal ? 'üß† personal' : 'ai';
                const badgeClass = isPersonal ? 'personal' : '';
                
                item.innerHTML = `
                    <span class="ai-suggestion-text">${suggestion}</span>
                    <span class="ai-suggestion-badge ${badgeClass}">${badgeText}</span>
                `;
                
                item.onclick = () => selectPersonalSuggestion(fieldType, suggestion, originalInput);
                dropdown.appendChild(item);
            });

            // Check conditions for create shortcut option
            const shouldShowCreate = originalInput && originalInput.length >= 2 && !source.includes('personal-exact');
            console.log('üîç Create shortcut check:', { 
                originalInput, 
                length: originalInput?.length, 
                source, 
                shouldShow: shouldShowCreate 
            });

            // Add "Create shortcut" option if input is unrecognized (2+ characters and not a personal match)
            if (shouldShowCreate) {
                // Add separator if there are suggestions
                if (suggestions.length > 0) {
                    const separator = document.createElement('div');
                    separator.style.cssText = 'border-top: 1px solid #e2e8f0; margin: 4px 0;';
                    dropdown.appendChild(separator);
                }

                // Add create shortcut option
                const createItem = document.createElement('div');
                createItem.className = 'ai-suggestion-item';
                createItem.style.cssText = 'background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 3px solid #3b82f6;';
                
                createItem.innerHTML = `
                    <span class="ai-suggestion-text" style="color: #1e40af; font-weight: 600;">‚ú® Create shortcut for "${originalInput}"</span>
                    <span class="ai-suggestion-badge" style="background: #3b82f6; color: white;">new</span>
                `;
                
                createItem.onclick = () => createQuickShortcut(fieldType, originalInput);
                dropdown.appendChild(createItem);
                
                console.log('‚úÖ Create shortcut option added to dropdown');
            } else {
                console.log('‚ùå Create shortcut option NOT added - conditions not met');
            }

            dropdown.classList.add('show');

            // Hide after 15 seconds
            setTimeout(() => {
                dropdown.classList.remove('show');
            }, 15000);
        }

        // Quick shortcut creation using existing prompt system
        async function createQuickShortcut(fieldType, abbreviation) {
            // Hide dropdown first
            const dropdown = document.getElementById(`${fieldType}Suggestions`);
            dropdown.classList.remove('show');
            
            // Use the existing addPersonalShortcut function but with pre-filled data
            const fullName = prompt(`Create shortcut for "${abbreviation.toUpperCase()}":\n\nEnter the full product name:`);
            
            if (fullName && fullName.trim()) {
                try {
                    const response = await fetch('/api/personal-ai/add-shortcut', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            shortcut: abbreviation.toUpperCase(),
                            fullName: fullName.trim(),
                            fieldType: fieldType
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        // Apply the shortcut immediately to the field
                        const field = document.getElementById(fieldType);
                        field.value = fullName.trim();
                        
                        // Show success message
                        showStatus(`üß† Shortcut created: "${abbreviation.toUpperCase()}" = "${fullName.trim()}"`, 'success');
                        
                        // Refresh shortcuts
                        AI.loadUserShortcuts();
                        
                        // Trigger related AI actions if needed
                        if (fieldType === 'brand' || fieldType === 'model') {
                            handleModelChange();
                        }
                    } else {
                        showStatus('‚ùå Failed to create shortcut', 'error');
                    }
                } catch (error) {
                    console.error('Create shortcut error:', error);
                    showStatus('‚ùå Error creating shortcut', 'error');
                }
            }
        }

        // Enhanced AI suggestion function with debugging and create shortcut support
        async function getEnhancedAISuggestions(fieldType) {
            console.log(`ü§ñ Getting AI suggestions for: ${fieldType}`);
            
            const button = document.querySelector(`[onclick="getEnhancedAISuggestions('${fieldType}')"]`);
            const dropdown = document.getElementById(`${fieldType}Suggestions`);
            const statusIndicator = document.getElementById(`${fieldType}AIStatus`);
            const input = document.getElementById(fieldType)?.value || '';

            if (!button) {
                console.error(`‚ùå AI button not found for field: ${fieldType}`);
                return;
            }

            if (!dropdown) {
                console.error(`‚ùå Suggestions dropdown not found for field: ${fieldType}`);
                return;
            }

            console.log(`üìù Input value: "${input}"`);

            // Show loading state
            button.classList.add('loading');

            // Get context
            const context = {
                platform: document.getElementById('platform')?.value,
                brand: document.getElementById('brand')?.value,
                model: document.getElementById('model')?.value
            };

            console.log('üîç Context:', context);

            try {
                const result = await AI.getSmartSuggestions(fieldType, context);
                console.log('ü§ñ AI Result:', result);
                console.log('üîç Input for create shortcut check:', input);
                
                // Always show dropdown, even if no AI suggestions
                // The displayPersonalSuggestions function will add "Create shortcut" option for unrecognized input
                displayPersonalSuggestions(fieldType, result.suggestions || [], result.source || 'no-suggestions', input);
                
                // Enhanced status messages
                let sourceText = 'AI-powered';
                if (result.source === 'personal-exact') {
                    sourceText = 'üß† Personal shortcut';
                } else if (result.source === 'personal-partial') {
                    sourceText = 'üß† Personal match';
                } else if (result.source === 'ai-learning') {
                    sourceText = 'ü§ñ AI learning';
                } else if (!result.suggestions || result.suggestions.length === 0) {
                    sourceText = '‚ú® Create new shortcut';
                }
                
                if (statusIndicator) {
                    statusIndicator.textContent = `${sourceText} ${result.suggestions?.length > 0 ? 'suggestions ready' : 'available'}`;
                    statusIndicator.classList.add('show');
                    
                    setTimeout(() => {
                        statusIndicator.classList.remove('show');
                    }, 4000);
                }
            } catch (error) {
                console.error('Enhanced AI error:', error);
                // Still show dropdown with create option even on error
                displayPersonalSuggestions(fieldType, [], 'error', input);
                showStatus('‚ùå Error getting suggestions, but you can still create shortcuts', 'error');
            } finally {
                button.classList.remove('loading');
            }
        }

        // Personal shortcut management
        async function addPersonalShortcut() {
            const shortcut = prompt('Enter your shortcut (e.g., "APP1"):');
            const fullName = prompt('Enter the full product name (e.g., "AirPods Pro 1st Generation"):');
            const fieldType = prompt('Enter field type (brand/model/category):', 'model');
            
            if (shortcut && fullName && fieldType) {
                try {
                    const response = await fetch('/api/personal-ai/add-shortcut', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            shortcut: shortcut.trim(),
                            fullName: fullName.trim(),
                            fieldType: fieldType.trim()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        showStatus(`üß† Shortcut added: "${shortcut}" = "${fullName}"`, 'success');
                        AI.loadUserShortcuts(); // Refresh
                    } else {
                        showStatus('‚ùå Failed to add shortcut', 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå Error adding shortcut', 'error');
                }
            }
        }

        // Custom platforms and brands storage
        let customPlatforms = [];
        let customBrands = [];

        // Platform Management Functions
        function handlePlatformChange() {
            const platformSelect = document.getElementById('platform');
            const customContainer = document.getElementById('customPlatformContainer');
            const selectedValue = platformSelect.value;
            const selectedOption = platformSelect.options[platformSelect.selectedIndex];
            
            // Check if user clicked on a custom platform with delete cross
            if (selectedOption && selectedOption.dataset.customPlatform === 'true') {
                const platformName = selectedOption.dataset.platformName;
                
                const shouldDelete = confirm(`Do you want to delete "${platformName}" or select it?\n\nClick OK to DELETE, Cancel to SELECT`);
                
                if (shouldDelete) {
                    deleteCustomPlatformWithConfirmation(platformName);
                    return;
                } else {
                    showStatus(`‚úÖ Selected platform: ${platformName}`, 'success');
                }
            }
            
            if (selectedValue === 'CUSTOM_PLATFORM') {
                customContainer.classList.add('show');
                document.getElementById('customPlatformInput').focus();
                showStatus('üè™ Add a new platform to expand your options!', 'info');
            } else {
                customContainer.classList.remove('show');
            }
        }

        function handleCustomPlatformKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCustomPlatform();
            }
        }

        function addCustomPlatform() {
            const input = document.getElementById('customPlatformInput');
            const platformName = input.value.trim();
            
            if (!platformName) {
                showStatus('‚ùå Please enter a platform name', 'error');
                return;
            }
            
            // Check if platform already exists
            const platformSelect = document.getElementById('platform');
            const existingOptions = Array.from(platformSelect.options).map(opt => opt.value.toLowerCase());
            const existsInDropdown = existingOptions.includes(platformName.toLowerCase());
            const existsInCustom = customPlatforms.some(platform => platform.toLowerCase() === platformName.toLowerCase());
            
            if (existsInDropdown || existsInCustom) {
                showStatus('‚ùå Platform already exists', 'error');
                return;
            }
            
            // Add to custom platforms array
            customPlatforms.push(platformName);
            updatePlatformDropdown();
            
            // Select the new platform
            platformSelect.value = platformName;
            
            // Hide custom input
            cancelCustomPlatform();
            
            showStatus(`‚úÖ Added "${platformName}" to platforms list`, 'success');
        }

        function cancelCustomPlatform() {
            const customContainer = document.getElementById('customPlatformContainer');
            const platformSelect = document.getElementById('platform');
            const input = document.getElementById('customPlatformInput');
            
            customContainer.classList.remove('show');
            platformSelect.value = '';
            input.value = '';
            showStatus('üè™ Custom platform input cancelled', 'info');
        }

        function updatePlatformDropdown() {
            const platformSelect = document.getElementById('platform');
            const currentValue = platformSelect.value;
            
            // Store default options
            const defaultPlatforms = [
                { value: '', text: 'Select platform...' },
                { value: 'eBay', text: 'eBay' },
                { value: 'Amazon', text: 'Amazon' },
                { value: 'Vinted', text: 'Vinted' },
                { value: 'Facebook Marketplace', text: 'Facebook Marketplace' },
                { value: 'Depop', text: 'Depop' },
                { value: 'Gumtree', text: 'Gumtree' }
            ];
            
            // Clear dropdown
            platformSelect.innerHTML = '';
            
            // Add default options
            defaultPlatforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform.value;
                option.textContent = platform.text;
                platformSelect.appendChild(option);
            });
            
            // Add custom platforms with visual indication
            customPlatforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = `${platform} √ó`;
                option.title = `Click √ó to delete "${platform}"`;
                option.dataset.customPlatform = 'true';
                option.dataset.platformName = platform;
                option.style.color = '#64748b';
                option.style.fontStyle = 'italic';
                platformSelect.appendChild(option);
            });
            
            // Add "Other" option at the end
            const otherOption = document.createElement('option');
            otherOption.value = 'CUSTOM_PLATFORM';
            otherOption.textContent = '+ Other (Add New Platform)';
            platformSelect.appendChild(otherOption);
            
            // Restore selection if it still exists
            if (currentValue && Array.from(platformSelect.options).some(opt => opt.value === currentValue)) {
                platformSelect.value = currentValue;
            }
        }

        function deleteCustomPlatformWithConfirmation(platformName) {
            const userInput = prompt(`‚ö†Ô∏è DELETE PLATFORM CONFIRMATION\n\nTo delete "${platformName}", please type the platform name exactly as shown:\n\n"${platformName}"\n\nType here:`);
            
            if (userInput === null) {
                // User cancelled
                const platformSelect = document.getElementById('platform');
                platformSelect.value = '';
                showStatus('üè™ Delete cancelled', 'info');
                return;
            }
            
            if (userInput.trim() === platformName) {
                // Correct confirmation
                const index = customPlatforms.indexOf(platformName);
                if (index > -1) {
                    customPlatforms.splice(index, 1);
                    updatePlatformDropdown();
                    
                    const platformSelect = document.getElementById('platform');
                    platformSelect.value = '';
                    
                    showStatus(`üóëÔ∏è Successfully deleted "${platformName}" from your platforms`, 'success');
                }
            } else {
                // Incorrect confirmation
                const platformSelect = document.getElementById('platform');
                platformSelect.value = '';
                showStatus(`‚ùå Incorrect confirmation. "${platformName}" was not deleted.`, 'error');
            }
        }

        // Brand Management Functions
        function handleBrandChange() {
            const brandSelect = document.getElementById('brand');
            const customContainer = document.getElementById('customBrandContainer');
            const selectedValue = brandSelect.value;
            const selectedOption = brandSelect.options[brandSelect.selectedIndex];
            
            // Check if user clicked on a custom brand with delete cross
            if (selectedOption && selectedOption.dataset.customBrand === 'true') {
                const brandName = selectedOption.dataset.brandName;
                
                const shouldDelete = confirm(`Do you want to delete "${brandName}" or select it?\n\nClick OK to DELETE, Cancel to SELECT`);
                
                if (shouldDelete) {
                    deleteCustomBrandWithConfirmation(brandName);
                    return;
                } else {
                    showStatus(`‚úÖ Selected brand: ${brandName}`, 'success');
                }
            }
            
            if (selectedValue === 'CUSTOM_BRAND') {
                customContainer.classList.add('show');
                document.getElementById('customBrandInput').focus();
                showStatus('üè∑Ô∏è Add a new brand to expand your options!', 'info');
            } else {
                customContainer.classList.remove('show');
                
                if (selectedValue) {
                    // Auto-suggest models for the selected brand
                    setTimeout(() => {
                        getEnhancedAISuggestions('model');
                    }, 500);
                }
            }
        }

        function handleCustomBrandKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCustomBrand();
            }
        }

        function addCustomBrand() {
            const input = document.getElementById('customBrandInput');
            const brandName = input.value.trim();
            
            if (!brandName) {
                showStatus('‚ùå Please enter a brand name', 'error');
                return;
            }
            
            // Check if brand already exists
            const brandSelect = document.getElementById('brand');
            const existingOptions = Array.from(brandSelect.options).map(opt => opt.value.toLowerCase());
            const existsInDropdown = existingOptions.includes(brandName.toLowerCase());
            const existsInCustom = customBrands.some(brand => brand.toLowerCase() === brandName.toLowerCase());
            
            if (existsInDropdown || existsInCustom) {
                showStatus('‚ùå Brand already exists', 'error');
                return;
            }
            
            // Add to custom brands array
            customBrands.push(brandName);
            updateBrandDropdown();
            
            // Select the new brand
            brandSelect.value = brandName;
            
            // Hide custom input
            cancelCustomBrand();
            
            showStatus(`‚úÖ Added "${brandName}" to brands list`, 'success');
            
            // Auto-suggest models for the new brand
            setTimeout(() => {
                getEnhancedAISuggestions('model');
            }, 500);
        }

        function cancelCustomBrand() {
            const customContainer = document.getElementById('customBrandContainer');
            const brandSelect = document.getElementById('brand');
            const input = document.getElementById('customBrandInput');
            
            customContainer.classList.remove('show');
            brandSelect.value = '';
            input.value = '';
            showStatus('üè∑Ô∏è Custom brand input cancelled', 'info');
        }

        function updateBrandDropdown() {
            const brandSelect = document.getElementById('brand');
            const currentValue = brandSelect.value;
            
            // Store default options
            const defaultBrands = [
                { value: '', text: 'Select brand...' },
                { value: 'Apple', text: 'Apple' },
                { value: 'Samsung', text: 'Samsung' },
                { value: 'Sony', text: 'Sony' },
                { value: 'Nike', text: 'Nike' },
                { value: 'Adidas', text: 'Adidas' }
            ];
            
            // Clear dropdown
            brandSelect.innerHTML = '';
            
            // Add default options
            defaultBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.value;
                option.textContent = brand.text;
                brandSelect.appendChild(option);
            });
            
            // Add custom brands with visual indication
            customBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = `${brand} √ó`;
                option.title = `Click √ó to delete "${brand}"`;
                option.dataset.customBrand = 'true';
                option.dataset.brandName = brand;
                option.style.color = '#64748b';
                option.style.fontStyle = 'italic';
                brandSelect.appendChild(option);
            });
            
            // Add "Other" option at the end
            const otherOption = document.createElement('option');
            otherOption.value = 'CUSTOM_BRAND';
            otherOption.textContent = '+ Other (Add New Brand)';
            brandSelect.appendChild(otherOption);
            
            // Restore selection if it still exists
            if (currentValue && Array.from(brandSelect.options).some(opt => opt.value === currentValue)) {
                brandSelect.value = currentValue;
            }
        }

        function deleteCustomBrandWithConfirmation(brandName) {
            const userInput = prompt(`‚ö†Ô∏è DELETE BRAND CONFIRMATION\n\nTo delete "${brandName}", please type the brand name exactly as shown:\n\n"${brandName}"\n\nType here:`);
            
            if (userInput === null) {
                // User cancelled
                const brandSelect = document.getElementById('brand');
                brandSelect.value = '';
                showStatus('üè∑Ô∏è Delete cancelled', 'info');
                return;
            }
            
            if (userInput.trim() === brandName) {
                // Correct confirmation
                const index = customBrands.indexOf(brandName);
                if (index > -1) {
                    customBrands.splice(index, 1);
                    updateBrandDropdown();
                    
                    const brandSelect = document.getElementById('brand');
                    brandSelect.value = '';
                    
                    showStatus(`üóëÔ∏è Successfully deleted "${brandName}" from your brands`, 'success');
                }
            } else {
                // Incorrect confirmation
                const brandSelect = document.getElementById('brand');
                brandSelect.value = '';
                showStatus(`‚ùå Incorrect confirmation. "${brandName}" was not deleted.`, 'error');
            }
        }

        async function handleModelChange() {
            const brand = document.getElementById('brand')?.value;
            const model = document.getElementById('model')?.value;
            
            if (brand && model) {
                // Auto-detect category
                const category = await AI.autoDetectCategory(brand, model);
                if (category) {
                    const categorySelect = document.getElementById('category');
                    categorySelect.value = category;
                    showStatus(`ü§ñ AI detected category: ${category}`, 'success');
                }
            }
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.ai-enhanced-field')) {
                document.querySelectorAll('.ai-suggestions-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Core Purchase Management Functions
        function toggleAddForm() {
            const section = document.getElementById('addPurchaseSection');
            const isVisible = section.classList.contains('show');
            
            if (isVisible) {
                section.classList.remove('show');
                showStatus('üìù Purchase form closed.', 'info');
            } else {
                section.classList.add('show');
                document.getElementById('purchaseDate').focus();
                showStatus('üìù Purchase form opened. Try typing "APP1" in Model field!', 'info');
            }
        }

        function updateTotalPaid() {
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            const total = purchasePrice + shippingCost;
            document.getElementById('totalPaid').value = total.toFixed(2);
            
            // Auto-update part values if parts exist and user wants auto-calculation
            if (partsData.length > 0 && total > 0) {
                autoCalculatePartValues();
            }
        }

        async function savePurchase(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveBtn');
            const saveIcon = document.getElementById('saveIcon');
            const saveText = document.getElementById('saveText');
            const form = document.getElementById('purchaseForm');
            const editId = form.dataset.editId;
            
            // Show loading state
            saveIcon.textContent = '‚è≥';
            saveText.textContent = editId ? 'Updating...' : 'Saving...';
            saveBtn.disabled = true;
            
            try {
                const formData = new FormData(form);
                const purchaseData = Object.fromEntries(formData.entries());
                
                // Add parts data if any
                const parts = getPartsData();
                if (parts.length > 0) {
                    purchaseData.parts = parts;
                    purchaseData.hasParts = true;
                    purchaseData.totalParts = parts.length;
                    purchaseData.totalItems = parts.reduce((sum, part) => sum + part.quantity, 0);
                    purchaseData.estimatedPartsValue = parts.reduce((sum, part) => sum + (part.estimatedValue * part.quantity), 0);
                } else {
                    purchaseData.hasParts = false;
                }
                
                const url = editId ? `/api/purchases/${editId}` : '/api/purchases';
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(purchaseData)
                });
                
                if (response.ok) {
                    const partsMessage = parts.length > 0 ? ` with ${parts.length} parts breakdown` : '';
                    const action = editId ? 'updated' : 'saved';
                    showStatus(`‚úÖ Purchase ${action} successfully${partsMessage}!`, 'success');
                    resetForm();
                    loadPurchases();
                } else {
                    throw new Error(`Failed to ${editId ? 'update' : 'save'} purchase: ${response.status}`);
                }
            } catch (error) {
                console.error('Save error:', error);
                showStatus(`‚ùå Error ${editId ? 'updating' : 'saving'} purchase. Please try again.`, 'error');
            } finally {
                // Reset button
                saveIcon.textContent = 'üíæ';
                saveText.textContent = 'Save Purchase';
                saveBtn.disabled = false;
            }
        }

        function resetForm() {
            const form = document.getElementById('purchaseForm');
            const formHeader = document.querySelector('.form-header h3');
            const saveText = document.getElementById('saveText');
            
            // Reset form data
            form.reset();
            document.getElementById('totalPaid').value = '';
            
            // Reset edit state
            delete form.dataset.editId;
            formHeader.textContent = 'üìù Add New Purchase with Personal AI';
            saveText.textContent = 'Save Purchase';
            
            // Reset parts data
            partsData = [];
            partIdCounter = 0;
            renderParts();
            
            // Hide parts management
            const partsSection = document.getElementById('partsManagement');
            if (partsSection.classList.contains('show')) {
                togglePartsManagement();
            }
            
            showStatus('üîÑ Form and parts reset successfully.', 'info');
        }

        function fillDemoData() {
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('platform').value = 'eBay';
            document.getElementById('brand').value = 'Apple';
            document.getElementById('model').value = 'APP1';
            document.getElementById('category').value = 'Audio & Headphones';
            document.getElementById('purchasePrice').value = '89.99';
            document.getElementById('shippingCost').value = '4.99';
            document.getElementById('deliveryStatus').value = 'Delivered';
            document.getElementById('notes').value = 'Faulty AirPods Pro bought for parts - good for breaking down and selling individually';
            updateTotalPaid();
            
            // Fill demo parts data
            fillDemoPartsData();
            
            showStatus('üéØ Demo data filled with parts breakdown example!', 'success');
        }

        // Store current purchases for editing
        let currentPurchases = [];

        async function loadPurchases() {
            try {
                const response = await fetch('/api/purchases');
                if (response.ok) {
                    const purchases = await response.json();
                    currentPurchases = purchases; // Store for editing
                    displayPurchases(purchases);
                    updateStatusBar(purchases);
                } else {
                    throw new Error(`Failed to load purchases: ${response.status}`);
                }
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('purchaseHistoryContent').innerHTML = '<p>Error loading purchase history. Please try again.</p>';
            }
        }

        function displayPurchases(purchases) {
            const container = document.getElementById('purchaseHistoryContent');
            
            if (!purchases || purchases.length === 0) {
                container.innerHTML = '<p>No purchases found. Add your first purchase above!</p>';
                return;
            }
            
            const purchaseCards = purchases.map(purchase => {
                const timeAgo = getTimeAgo(new Date(purchase.purchase_date));
                const platformEmoji = getPlatformEmoji(purchase.platform);
                
                // Parts indicator
                const partsIndicator = purchase.hasParts && purchase.totalParts > 0 
                    ? `<span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">üîß ${purchase.totalParts} parts</span>`
                    : '';
                
                return `
                    <div class="purchase-card">
                        <div class="purchase-icon">${platformEmoji}</div>
                        <div class="purchase-text" onclick="showPurchaseDetails(${purchase.id})">
                            <strong>${purchase.brand} ${purchase.model}</strong> - ¬£${purchase.total_paid}${partsIndicator}
                        </div>
                        <span class="purchase-platform">${purchase.platform}</span>
                        <div style="position: relative;">
                            <span class="purchase-status status-${purchase.delivery_status.toLowerCase().replace(' ', '-')}" 
                                  onclick="showStatusDropdown(event, ${purchase.id}, '${purchase.delivery_status}')"
                                  title="Click to change delivery status">${purchase.delivery_status}</span>
                            <div id="statusDropdown-${purchase.id}" class="status-dropdown"></div>
                        </div>
                        <span class="purchase-time">${timeAgo}</span>
                        <button class="edit-btn" onclick="editPurchase(${purchase.id})" title="Edit purchase">‚úèÔ∏è</button>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = purchaseCards;
        }

        function updateStatusBar(purchases) {
            const totalInvestment = purchases.reduce((sum, p) => sum + parseFloat(p.total_paid || 0), 0);
            const averagePurchase = purchases.length > 0 ? totalInvestment / purchases.length : 0;
            
            document.getElementById('status-total-investment').textContent = `¬£${totalInvestment.toFixed(2)}`;
            document.getElementById('status-purchase-count').textContent = purchases.length;
            document.getElementById('status-avg-purchase').textContent = `¬£${averagePurchase.toFixed(2)}`;
            document.getElementById('last-sync').textContent = 'just now';
        }

        function getPlatformEmoji(platform) {
            const emojis = {
                'eBay': 'üè™',
                'Amazon': 'üì¶',
                'Vinted': 'üëï',
                'Facebook Marketplace': 'üìò',
                'Depop': 'üõçÔ∏è',
                'Gumtree': 'üå≥'
            };
            return emojis[platform] || 'üõí';
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        function showPurchaseDetails(purchaseId) {
            const purchase = currentPurchases.find(p => p.id === purchaseId);
            if (!purchase) {
                showStatus('‚ùå Purchase not found', 'error');
                return;
            }
            
            const partsInfo = purchase.hasParts && purchase.totalParts > 0 
                ? `\n\nüîß Parts Breakdown:\n${purchase.parts.map(part => `‚Ä¢ ${part.name} (${part.quantity}x) - ${part.condition} - ¬£${part.estimatedValue}`).join('\n')}`
                : '';
            
            alert(`üìã Purchase Details:\n\n` +
                  `üìÖ Date: ${new Date(purchase.purchase_date).toLocaleDateString()}\n` +
                  `üè™ Platform: ${purchase.platform}\n` +
                  `üè∑Ô∏è Brand: ${purchase.brand}\n` +
                  `üì± Model: ${purchase.model}\n` +
                  `üìÇ Category: ${purchase.category}\n` +
                  `üí∞ Total Paid: ¬£${purchase.total_paid}\n` +
                  `üì¶ Status: ${purchase.delivery_status}\n` +
                  `üìù Notes: ${purchase.notes || 'None'}${partsInfo}`);
        }

        function editPurchase(purchaseId) {
            // Find the purchase data (you'll need to store this when loading)
            const purchase = currentPurchases.find(p => p.id === purchaseId);
            if (!purchase) {
                showStatus('‚ùå Purchase not found', 'error');
                return;
            }
            
            // Open the form and populate with existing data
            const section = document.getElementById('addPurchaseSection');
            if (!section.classList.contains('show')) {
                section.classList.add('show');
            }
            
            // Populate form fields
            document.getElementById('purchaseDate').value = purchase.purchase_date.split('T')[0];
            document.getElementById('platform').value = purchase.platform;
            document.getElementById('brand').value = purchase.brand;
            document.getElementById('model').value = purchase.model;
            document.getElementById('category').value = purchase.category;
            document.getElementById('purchasePrice').value = purchase.purchase_price;
            document.getElementById('shippingCost').value = purchase.shipping_cost || 0;
            document.getElementById('totalPaid').value = purchase.total_paid;
            document.getElementById('deliveryStatus').value = purchase.delivery_status;
            document.getElementById('notes').value = purchase.notes || '';
            
            // Update form title and button
            const formHeader = document.querySelector('.form-header h3');
            const saveBtn = document.getElementById('saveBtn');
            const saveText = document.getElementById('saveText');
            
            formHeader.textContent = `‚úèÔ∏è Edit Purchase: ${purchase.brand} ${purchase.model}`;
            saveText.textContent = 'Update Purchase';
            
            // Store the ID for updating
            document.getElementById('purchaseForm').dataset.editId = purchaseId;
            
            // Load parts if they exist
            if (purchase.parts && purchase.parts.length > 0) {
                partsData = purchase.parts.map((part, index) => ({
                    id: ++partIdCounter,
                    name: part.name,
                    quantity: part.quantity,
                    condition: part.condition,
                    estimatedValue: part.estimatedValue
                }));
                
                const partsSection = document.getElementById('partsManagement');
                if (!partsSection.classList.contains('show')) {
                    togglePartsManagement();
                }
                renderParts();
            }
            
            showStatus(`‚úèÔ∏è Editing: ${purchase.brand} ${purchase.model}`, 'info');
        }

        function showStatusDropdown(event, purchaseId, currentStatus) {
            event.stopPropagation();
            
            // Hide any existing dropdowns
            document.querySelectorAll('.status-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            const dropdown = document.getElementById(`statusDropdown-${purchaseId}`);
            const statusOptions = [
                { value: 'Ordered', label: 'Ordered', icon: 'üìã' },
                { value: 'Paid', label: 'Paid', icon: 'üí≥' },
                { value: 'Dispatched', label: 'Dispatched', icon: 'üì¶' },
                { value: 'In Transit', label: 'In Transit', icon: 'üöõ' },
                { value: 'Delivered', label: 'Delivered', icon: '‚úÖ' }
            ];
            
            dropdown.innerHTML = statusOptions.map(option => {
                const isCurrentStatus = option.value === currentStatus;
                const statusClass = option.value.toLowerCase().replace(' ', '-');
                const currentClass = isCurrentStatus ? 'current' : '';
                
                return `
                    <div class="status-option ${statusClass} ${currentClass}" 
                         onclick="updatePurchaseStatus(${purchaseId}, '${option.value}', '${currentStatus}')">
                        <span>${option.icon}</span>
                        <span>${option.label}</span>
                        ${isCurrentStatus ? '<span style="margin-left: auto; font-size: 10px;">‚úì</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Smart positioning: check if dropdown would go off-screen
            const statusBadge = event.target;
            const rect = statusBadge.getBoundingClientRect();
            const dropdownHeight = 200; // Approximate height of dropdown
            const spaceBelow = window.innerHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Reset classes
            dropdown.classList.remove('position-up', 'position-down');
            
            // Position dropdown based on available space
            if (spaceBelow < dropdownHeight && spaceAbove > dropdownHeight) {
                // Not enough space below, but enough above - position upward
                dropdown.classList.add('position-up');
            } else {
                // Default position downward
                dropdown.classList.add('position-down');
            }
            
            dropdown.classList.add('show');
            
            // Hide dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function hideDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', hideDropdown);
                    }
                });
            }, 100);
        }

        async function updatePurchaseStatus(purchaseId, newStatus, currentStatus) {
            // Hide dropdown
            document.getElementById(`statusDropdown-${purchaseId}`).classList.remove('show');
            
            if (newStatus === currentStatus) {
                showStatus('‚ÑπÔ∏è Status unchanged.', 'info');
                return;
            }
            
            try {
                const response = await fetch(`/api/purchases/${purchaseId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        delivery_status: newStatus
                    })
                });
                
                if (response.ok) {
                    showStatus(`‚úÖ Status updated: ${currentStatus} ‚Üí ${newStatus}`, 'success');
                    
                    // Update the current purchases array
                    const purchase = currentPurchases.find(p => p.id === purchaseId);
                    if (purchase) {
                        purchase.delivery_status = newStatus;
                    }
                    
                    // Refresh the display
                    displayPurchases(currentPurchases);
                } else {
                    throw new Error(`Failed to update status: ${response.status}`);
                }
            } catch (error) {
                console.error('Status update error:', error);
                showStatus('‚ùå Error updating status. Please try again.', 'error');
            }
        }

        // Enhanced Multi-Source Email Import Management
        let emailImportItems = [];
        let selectedEmailItems = new Set();

        // Enhanced function to display email import items with source indicators
        function displayEmailImportItems(items) {
            const container = document.getElementById('emailImportsList');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No approved imports found from any source</p>';
                return;
            }
            
            // Group items by source for summary
            const sourceGroups = {
                'vinted': items.filter(item => item.source === 'vinted'),
                'ebay': items.filter(item => item.source === 'ebay'),
                'manual': items.filter(item => item.source === 'manual')
            };
            
            // Create enhanced source summary with visual indicators
            const summaryHtml = `
                <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin: 0 0 8px 0; color: #1e40af; font-size: 0.9rem;">üìä Import Sources Summary</h4>
                    <div style="display: flex; gap: 24px; font-size: 0.85rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #8B5CF6; border-radius: 50%; display: inline-block;"></span>
                            <span><strong>${sourceGroups['vinted'].length}</strong> Vinted emails üìß</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #059669; border-radius: 50%; display: inline-block;"></span>
                            <span><strong>${sourceGroups['ebay'].length}</strong> eBay purchases üîó</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; display: inline-block;"></span>
                            <span><strong>${sourceGroups['manual'].length}</strong> Manual entries ‚úã</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; margin-left: auto;">
                            <span style="color: #64748b;">Total: <strong>${items.length}</strong> items</span>
                        </div>
                    </div>
                </div>
            `;
            
            const itemsHtml = items.map(item => {
                // Determine platform styling and source indicator
                const platformStyle = getPlatformStyling(item.platform, item.source);
                const sourceIcon = getSourceIcon(item.source);
                const confidenceColor = getConfidenceColor(item.confidence);
                
                return `
                    <div class="email-import-item" data-id="${item.id}" onclick="toggleEmailItemSelection('${item.id}')" 
                         style="border-left: 4px solid ${platformStyle.borderColor};">
                        <input type="checkbox" 
                               class="email-import-checkbox" 
                               ${selectedEmailItems.has(item.id) ? 'checked' : ''}
                               onchange="handleEmailItemCheckbox('${item.id}', this.checked)"
                               onclick="event.stopPropagation()">
                        
                        <div class="email-import-content">
                            <div class="email-import-details">
                                <div class="email-import-title">
                                    ${sourceIcon} ${item.brand || 'Unknown'} ${item.model || item.title || 'Unknown Model'}
                                </div>
                                <div class="email-import-subtitle">
                                    üìÖ ${formatDate(item.date || item.purchaseDate)} ‚Ä¢ 
                                    <span style="color: ${confidenceColor};">üéØ ${item.confidence || 95}% confidence</span> ‚Ä¢
                                    <span style="color: #64748b; font-size: 0.75rem;">${getSourceLabel(item.source)}</span>
                                    ${item.orderId ? `‚Ä¢ üî¢ Order: ${item.orderId}` : ''}
                                </div>
                            </div>
                            
                            <div class="email-import-price" style="color: ${platformStyle.priceColor};">
                                ${formatPrice(item.price || item.total)}
                            </div>
                            
                            <div class="email-import-platform" style="background: ${platformStyle.bgColor}; color: ${platformStyle.textColor};">
                                ${item.platform}
                            </div>
                            
                            <div class="email-import-actions">
                                <button class="email-import-btn view" onclick="viewEmailItem('${item.id}'); event.stopPropagation();">
                                    üëÅÔ∏è View
                                </button>
                                <button class="email-import-btn import" onclick="importSingleEmailItem('${item.id}'); event.stopPropagation();">
                                    ‚ûï Import
                                </button>
                                ${item.source === 'ebay' ? `
                                    <button class="email-import-btn" onclick="viewEbayDetails('${item.id}'); event.stopPropagation();"
                                            style="background: #0369a1; color: white; font-size: 0.7rem; padding: 3px 6px;">
                                        üè™ eBay Details
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = summaryHtml + itemsHtml;
            updateSelectionSummary();
        }

        // Helper functions for enhanced display
        function getPlatformStyling(platform, source) {
            const styles = {
                'Vinted': {
                    bgColor: '#8B5CF6',
                    textColor: 'white',
                    borderColor: '#8B5CF6',
                    priceColor: '#059669'
                },
                'eBay': {
                    bgColor: '#059669',
                    textColor: 'white', 
                    borderColor: '#059669',
                    priceColor: '#0369a1'
                },
                'Amazon': {
                    bgColor: '#f59e0b',
                    textColor: 'white',
                    borderColor: '#f59e0b',
                    priceColor: '#d97706'
                },
                'Depop': {
                    bgColor: '#ec4899',
                    textColor: 'white',
                    borderColor: '#ec4899',
                    priceColor: '#be185d'
                }
            };
            
            return styles[platform] || {
                bgColor: '#64748b',
                textColor: 'white',
                borderColor: '#64748b',
                priceColor: '#059669'
            };
        }

        // Get source-specific icon with enhanced variety
        function getSourceIcon(source) {
            const icons = {
                'vinted': 'üìß',
                'ebay': 'üîó',
                'manual': '‚úã',
                'amazon': 'üì¶',
                'depop': 'üõçÔ∏è',
                'facebook': 'üìò'
            };
            
            return icons[source] || 'üìÑ';
        }

        // Get human-readable source label
        function getSourceLabel(source) {
            const labels = {
                'vinted': 'Gmail Email',
                'ebay': 'eBay API',
                'manual': 'Manual Entry',
                'amazon': 'Amazon API',
                'depop': 'Depop Email'
            };
            
            return labels[source] || 'Unknown Source';
        }

        // Enhanced confidence color coding
        function getConfidenceColor(confidence) {
            const conf = parseInt(confidence) || 0;
            if (conf >= 95) return '#059669'; // High confidence - green
            if (conf >= 85) return '#0369a1'; // Good confidence - blue
            if (conf >= 75) return '#d97706'; // Medium confidence - orange
            return '#dc2626'; // Low confidence - red
        }

        // Enhanced price formatting
        function formatPrice(price) {
            if (!price) return '¬£0.00';
            const numPrice = typeof price === 'string' ? parseFloat(price.replace(/[¬£$‚Ç¨]/g, '')) : price;
            return `¬£${numPrice.toFixed(2)}`;
        }

        // Enhanced date formatting
        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        // Enhanced refresh function with multi-source testing and better error handling
        async function refreshEmailImports() {
            const listContainer = document.getElementById('emailImportsList');
            const countBadge = document.getElementById('emailImportCount');
            
            try {
                // Show enhanced loading with source info
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        <div style="font-size: 1.2rem; margin-bottom: 12px;">üîÑ Loading multi-source imports...</div>
                        <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 4px; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="loading-spinner" style="width: 12px; height: 12px; border: 2px solid #e5e7eb; border-top: 2px solid #8B5CF6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span>üìß Checking Vinted emails via Gmail...</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="loading-spinner" style="width: 12px; height: 12px; border: 2px solid #e5e7eb; border-top: 2px solid #059669; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span>üè™ Fetching eBay purchases via API...</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.8rem; opacity: 0.7;">
                                Combining data sources and removing duplicates...
                            </div>
                        </div>
                    </div>
                `;
                
                // Fetch from enhanced multi-source endpoint
                const response = await fetch('/api/email-imports/approved');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Multi-source data received:', data);
                    
                    // Handle both old and new response formats
                    if (data.combined) {
                        // New enhanced format with source breakdown
                        emailImportItems = data.combined || [];
                        
                        // Update count badge with detailed breakdown
                        const vintedCount = data.sources?.vinted?.count || 0;
                        const ebayCount = data.sources?.ebay?.count || 0;
                        const duplicatesRemoved = data.summary?.duplicatesRemoved || 0;
                        
                        let badgeText = `${emailImportItems.length} items`;
                        if (vintedCount > 0 || ebayCount > 0) {
                            badgeText += ` <span style="font-size: 0.7rem; opacity: 0.8;">(${vintedCount}üìß + ${ebayCount}üîó`;
                            if (duplicatesRemoved > 0) {
                                badgeText += `, -${duplicatesRemoved} dupes`;
                            }
                            badgeText += ')</span>';
                        }
                        countBadge.innerHTML = badgeText;
                        
                        // Show success message with enhanced breakdown
                        let statusMessage = `‚úÖ Loaded ${emailImportItems.length} items`;
                        if (vintedCount > 0 || ebayCount > 0) {
                            statusMessage += `: ${vintedCount} from Vinted emails, ${ebayCount} from eBay API`;
                            if (duplicatesRemoved > 0) {
                                statusMessage += ` (${duplicatesRemoved} duplicates removed)`;
                            }
                        }
                        showStatus(statusMessage, 'success');
                        
                    } else {
                        // Fallback to simple format
                        emailImportItems = data.items || data || [];
                        countBadge.innerHTML = `${emailImportItems.length} approved`;
                        showStatus(`‚úÖ Loaded ${emailImportItems.length} email import items`, 'success');
                    }
                    
                    // Display items with enhanced styling
                    displayEmailImportItems(emailImportItems);
                    
                } else {
                    throw new Error(`API Error ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Multi-source import load error:', error);
                
                // Enhanced error display with debugging options
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #dc2626; padding: 20px;">
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">‚ùå Failed to load multi-source imports</div>
                        <div style="font-size: 0.85rem; margin-bottom: 12px; color: #64748b;">${error.message}</div>
                        <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="testIndividualSources()" 
                                    style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                üîß Test Individual Sources
                            </button>
                            <button onclick="loadDemoData()" 
                                    style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                üéØ Load Demo Data
                            </button>
                            <button onclick="refreshEmailImports()" 
                                    style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                üîÑ Retry
                            </button>
                        </div>
                    </div>
                `;
                showStatus('‚ùå Failed to load multi-source imports - check console for details', 'error');
            }
        }

        // Enhanced individual source testing for debugging
        async function testIndividualSources() {
            console.log('üîß Testing individual sources...');
            const listContainer = document.getElementById('emailImportsList');
            
            let testResults = '<div style="padding: 20px;"><h4 style="color: #1e40af; margin-bottom: 16px;">üîß Source Testing Results:</h4>';
            
            // Test Vinted source
            try {
                testResults += '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;"><div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top: 2px solid #8B5CF6; border-radius: 50%; animation: spin 1s linear infinite;"></div>Testing Vinted emails...</div>';
                listContainer.innerHTML = testResults + '</div>';
                
                const vintedResponse = await fetch('/api/email-imports/vinted');
                const vintedData = await vintedResponse.json();
                
                if (vintedData.success !== false) {
                    const count = vintedData.items?.length || vintedData.count || 0;
                    testResults = testResults.replace('Testing Vinted emails...', `‚úÖ Vinted: ${count} emails found`);
                } else {
                    testResults = testResults.replace('Testing Vinted emails...', `‚ùå Vinted: ${vintedData.error || 'Unknown error'}`);
                }
            } catch (error) {
                testResults = testResults.replace('Testing Vinted emails...', `‚ùå Vinted: ${error.message}`);
            }
            
            // Test eBay source
            try {
                testResults += '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;"><div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top: 2px solid #059669; border-radius: 50%; animation: spin 1s linear infinite;"></div>Testing eBay API...</div>';
                listContainer.innerHTML = testResults + '</div>';
                
                const ebayResponse = await fetch('/api/email-imports/ebay');
                const ebayData = await ebayResponse.json();
                
                if (ebayData.success !== false) {
                    const count = ebayData.items?.length || ebayData.count || 0;
                    testResults = testResults.replace('Testing eBay API...', `‚úÖ eBay: ${count} purchases found`);
                } else {
                    testResults = testResults.replace('Testing eBay API...', `‚ùå eBay: ${ebayData.error || 'Unknown error'}`);
                }
            } catch (error) {
                testResults = testResults.replace('Testing eBay API...', `‚ùå eBay: ${error.message}`);
            }
            
            // Test general service health
            try {
                testResults += '<div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;"><div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top: 2px solid #64748b; border-radius: 50%; animation: spin 1s linear infinite;"></div>Testing service health...</div>';
                listContainer.innerHTML = testResults + '</div>';
                
                const healthResponse = await fetch('/api/email-imports/test');
                if (healthResponse.ok) {
                    testResults = testResults.replace('Testing service health...', '‚úÖ Service: Backend responding normally');
                } else {
                    testResults = testResults.replace('Testing service health...', `‚ùå Service: HTTP ${healthResponse.status}`);
                }
            } catch (error) {
                testResults = testResults.replace('Testing service health...', `‚ùå Service: ${error.message}`);
            }
            
            testResults += `
                <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                    <button onclick="refreshEmailImports()" 
                            style="margin-right: 8px; padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        üîÑ Try Full Refresh Again
                    </button>
                    <button onclick="loadDemoData()" 
                            style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        üéØ Load Demo Data Instead
                    </button>
                </div>
            </div>`;
            
            listContainer.innerHTML = testResults;
        }

        // Load demo data when backend is unavailable
        function loadDemoData() {
            console.log('üéØ Loading demo multi-source data...');
            
            // Generate realistic demo data with multiple sources
            const demoItems = [
                // Vinted email examples
                { id: 'v1', source: 'vinted', platform: 'Vinted', brand: 'Nike', model: 'Air Force 1', price: 45.99, date: '2025-06-28', confidence: 87, seller: 'vintage_sneaker_lover' },
                { id: 'v2', source: 'vinted', platform: 'Vinted', brand: 'Adidas', model: 'Ultraboost 22', price: 78.50, date: '2025-06-27', confidence: 92, seller: 'sports_gear_uk' },
                { id: 'v3', source: 'vinted', platform: 'Vinted', brand: 'Apple', model: 'AirPods Pro', price: 89.99, date: '2025-06-26', confidence: 95, seller: 'tech_deals_london' },
                
                // eBay API examples
                { id: 'e1', source: 'ebay', platform: 'eBay', brand: 'Samsung', model: 'Galaxy Buds Pro', price: 67.89, date: '2025-06-29', confidence: 95, orderId: 'EB12345678', seller: 'electronics_direct_uk' },
                { id: 'e2', source: 'ebay', platform: 'eBay', brand: 'Sony', model: 'WH-1000XM4', price: 156.00, date: '2025-06-25', confidence: 98, orderId: 'EB87654321', seller: 'audio_specialists' },
                { id: 'e3', source: 'ebay', platform: 'eBay', brand: 'Apple', model: 'iPhone 15 Pro', price: 567.99, date: '2025-06-24', confidence: 99, orderId: 'EB11223344', seller: 'mobile_phones_certified' },
                
                // Manual entry examples
                { id: 'm1', source: 'manual', platform: 'Depop', brand: 'Zara', model: 'Leather Jacket', price: 34.50, date: '2025-06-23', confidence: 85, seller: 'vintage_fashion_finder' }
            ];
            
            emailImportItems = demoItems;
            
            // Update UI with demo data
            displayEmailImportItems(emailImportItems);
            document.getElementById('emailImportCount').innerHTML = `${emailImportItems.length} items <span style="font-size: 0.7rem; opacity: 0.8;">(Demo Data)</span>`;
            
            showStatus('üéØ Demo multi-source data loaded successfully!', 'success');
        }

        function toggleEmailImportsView() {
            const container = document.getElementById('emailImportsContainer');
            const toggleText = document.getElementById('emailToggleText');
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                container.style.display = 'none';
                toggleText.textContent = 'üëÅÔ∏è Show Items';
            } else {
                container.style.display = 'block';
                toggleText.textContent = 'üôà Hide Items';
                
                // Load items if not already loaded
                if (emailImportItems.length === 0) {
                    refreshEmailImports();
                }
            }
        }

        function toggleEmailItemSelection(itemId) {
            const checkbox = document.querySelector(`[data-id="${itemId}"] .email-import-checkbox`);
            checkbox.checked = !checkbox.checked;
            handleEmailItemCheckbox(itemId, checkbox.checked);
        }

        function handleEmailItemCheckbox(itemId, isChecked) {
            const itemElement = document.querySelector(`[data-id="${itemId}"]`);
            
            if (isChecked) {
                selectedEmailItems.add(itemId);
                itemElement.classList.add('selected');
            } else {
                selectedEmailItems.delete(itemId);
                itemElement.classList.remove('selected');
            }
            
            updateSelectionSummary();
        }

        function toggleSelectAllEmailImports() {
            const selectAllCheckbox = document.getElementById('selectAllEmailImports');
            const isSelectingAll = selectAllCheckbox.checked;
            
            if (isSelectingAll) {
                // Select all items
                emailImportItems.forEach(item => selectedEmailItems.add(item.id));
            } else {
                // Deselect all items
                selectedEmailItems.clear();
            }
            
            // Update all checkboxes
            document.querySelectorAll('.email-import-checkbox').forEach(checkbox => {
                checkbox.checked = isSelectingAll;
            });
            
            // Update visual selection
            document.querySelectorAll('.email-import-item').forEach(item => {
                if (isSelectingAll) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const selectedCountEl = document.getElementById('selectedCount');
            const selectedTotalEl = document.getElementById('selectedTotal');
            const selectAllCheckbox = document.getElementById('selectAllEmailImports');
            
            const selectedCount = selectedEmailItems.size;
            const selectedItems = emailImportItems.filter(item => selectedEmailItems.has(item.id));
            const selectedTotal = selectedItems.reduce((sum, item) => {
                const price = parseFloat((item.price || item.total || 0).toString().replace(/[¬£$‚Ç¨]/g, ''));
                return sum + price;
            }, 0);
            
            selectedCountEl.textContent = selectedCount;
            selectedTotalEl.textContent = selectedTotal.toFixed(2);
            
            // Update select all checkbox state
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === emailImportItems.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // Enhanced view function with source-specific details
        function viewEmailItem(itemId) {
            const item = emailImportItems.find(i => i.id === itemId);
            if (!item) return;
            
            const price = formatPrice(item.price || item.total);
            const sourceInfo = getSourceLabel(item.source);
            
            let details = `üìß Import Item Details:\n\n` +
                         `üè∑Ô∏è Brand: ${item.brand || 'Unknown'}\n` +
                         `üì± Model: ${item.model || item.title || 'Unknown Model'}\n` +
                         `üè™ Platform: ${item.platform}\n` +
                         `üí∞ Price: ${price}\n` +
                         `üìÖ Date: ${formatDate(item.date || item.purchaseDate)}\n` +
                         `üéØ Confidence: ${item.confidence || 95}%\n` +
                         `üîó Source: ${sourceInfo}`;
            
            if (item.seller) {
                details += `\nüë§ Seller: ${item.seller}`;
            }
            
            // Add source-specific details
            if (item.source === 'ebay') {
                details += `\n\nüè™ eBay Details:`;
                if (item.orderId) details += `\n   Order ID: ${item.orderId}`;
                if (item.transactionId) details += `\n   Transaction: ${item.transactionId}`;
                if (item.itemId) details += `\n   Item ID: ${item.itemId}`;
            } else if (item.source === 'vinted') {
                details += `\n\nüìß Email Details:`;
                if (item.originalEmailId) details += `\n   Email ID: ${item.originalEmailId}`;
                if (item.importedAt) details += `\n   Imported: ${formatDate(item.importedAt)}`;
            }
            
            alert(details);
        }

        // New function for eBay-specific details
        function viewEbayDetails(itemId) {
            const item = emailImportItems.find(i => i.id === itemId);
            if (!item || item.source !== 'ebay') return;
            
            const ebayDetails = `üè™ eBay Purchase Details:\n\n` +
                               `üì¶ Item: ${item.model || item.title}\n` +
                               `üí∞ Total: ${formatPrice(item.price || item.total)}\n` +
                               `üìÖ Date: ${formatDate(item.date || item.purchaseDate)}\n` +
                               `üë§ Seller: ${item.seller || 'Unknown'}\n\n` +
                               `üî¢ eBay IDs:\n` +
                               `   Order: ${item.orderId || 'N/A'}\n` +
                               `   Transaction: ${item.transactionId || 'N/A'}\n` +
                               `   Item: ${item.itemId || 'N/A'}\n\n` +
                               `üîó Data source: eBay API\n` +
                               `üéØ Confidence: ${item.confidence || 95}%`;
            
            alert(ebayDetails);
        }

        // Enhanced import function with better error handling
        async function importSingleEmailItem(itemId) {
            const item = emailImportItems.find(i => i.id === itemId);
            if (!item) {
                showStatus('‚ùå Item not found', 'error');
                return;
            }
            
            try {
                const numPrice = typeof item.price === 'string' ? 
                    parseFloat(item.price.replace(/[¬£$‚Ç¨]/g, '')) : 
                    (item.price || item.total || 0);
                
                // Enhanced purchase data with source tracking
                const purchaseData = {
                    purchase_date: item.date || item.purchaseDate || new Date().toISOString().split('T')[0],
                    platform: item.platform || 'Unknown',
                    brand: item.brand || 'Unknown',
                    model: item.model || item.title || 'Unknown Model',
                    purchase_price: numPrice,
                    total_paid: numPrice,
                    delivery_status: 'Ordered',
                    notes: generateImportNotes(item),
                    source: `email-import-${item.source}`,
                    originalSource: item.source,
                    confidence: item.confidence || 95
                };
                
                // Add source-specific data
                if (item.source === 'ebay' && item.orderId) {
                    purchaseData.externalOrderId = item.orderId;
                }
                if (item.seller) {
                    purchaseData.seller = item.seller;
                }
                
                const response = await fetch('/api/purchases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchaseData)
                });
                
                if (response.ok) {
                    const sourceLabel = getSourceLabel(item.source);
                    showStatus(`‚úÖ Imported: ${item.brand || 'Item'} ${item.model || ''} from ${sourceLabel} (${formatPrice(numPrice)})`, 'success');
                    
                    // Remove from email imports
                    emailImportItems = emailImportItems.filter(i => i.id !== itemId);
                    selectedEmailItems.delete(itemId);
                    
                    // Refresh displays
                    displayEmailImportItems(emailImportItems);
                    if (typeof loadPurchases === 'function') {
                        loadPurchases();
                    }
                    
                    // Update count
                    document.getElementById('emailImportCount').innerHTML = `${emailImportItems.length} approved`;
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Import error:', error);
                showStatus(`‚ùå Failed to import item: ${error.message}`, 'error');
            }
        }

        // Generate appropriate import notes based on source
        function generateImportNotes(item) {
            const sourceLabel = getSourceLabel(item.source);
            const confidence = item.confidence || 95;
            
            let notes = `Imported from ${sourceLabel} (${confidence}% confidence)`;
            
            if (item.source === 'ebay' && item.orderId) {
                notes += ` - eBay Order: ${item.orderId}`;
            }
            
            if (item.seller) {
                notes += ` - Seller: ${item.seller}`;
            }
            
            return notes;
        }

        async function bulkImportSelected() {
            if (selectedEmailItems.size === 0) {
                showStatus('‚ùå No items selected for import', 'error');
                return;
            }
            
            const selectedItems = emailImportItems.filter(item => selectedEmailItems.has(item.id));
            const totalValue = selectedItems.reduce((sum, item) => {
                const price = parseFloat((item.price || item.total || 0).toString().replace(/[¬£$‚Ç¨]/g, ''));
                return sum + price;
            }, 0);
            
            const confirmMessage = `Import ${selectedItems.length} selected items to your purchases?\n\nTotal value: ¬£${totalValue.toFixed(2)}`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                let successCount = 0;
                let failCount = 0;
                
                for (const item of selectedItems) {
                    try {
                        const numPrice = typeof item.price === 'string' ? 
                            parseFloat(item.price.replace(/[¬£$‚Ç¨]/g, '')) : 
                            (item.price || item.total || 0);
                        
                        const purchaseData = {
                            purchase_date: item.date || item.purchaseDate || new Date().toISOString().split('T')[0],
                            platform: item.platform || 'Unknown',
                            brand: item.brand || 'Unknown',
                            model: item.model || item.title || 'Unknown Model',
                            purchase_price: numPrice,
                            total_paid: numPrice,
                            delivery_status: 'Ordered',
                            notes: generateImportNotes(item),
                            source: `email-import-${item.source}`,
                            originalSource: item.source,
                            confidence: item.confidence || 95
                        };
                        
                        // Add source-specific data
                        if (item.source === 'ebay' && item.orderId) {
                            purchaseData.externalOrderId = item.orderId;
                        }
                        if (item.seller) {
                            purchaseData.seller = item.seller;
                        }
                        
                        const response = await fetch('/api/purchases', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(purchaseData)
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }
                
                // Remove successfully imported items
                const importedIds = selectedItems.slice(0, successCount).map(item => item.id);
                emailImportItems = emailImportItems.filter(item => !importedIds.includes(item.id));
                selectedEmailItems.clear();
                
                // Refresh displays
                displayEmailImportItems(emailImportItems);
                loadPurchases();
                
                // Update count and show results
                document.getElementById('emailImportCount').innerHTML = `${emailImportItems.length} approved`;
                
                if (successCount > 0) {
                    showStatus(`‚úÖ Successfully imported ${successCount} items${failCount > 0 ? `, ${failCount} failed` : ''}`, 'success');
                } else {
                    showStatus(`‚ùå Failed to import any items`, 'error');
                }
                
            } catch (error) {
                console.error('Bulk import error:', error);
                showStatus('‚ùå Bulk import failed', 'error');
            }
        }

        // Export functionality
        function exportData() {
            // Simple CSV export of purchase data
            if (currentPurchases.length === 0) {
                showStatus('‚ùå No purchase data to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Platform', 'Brand', 'Model', 'Category', 'Price', 'Shipping', 'Total', 'Status', 'Notes'];
            const csvData = [
                headers.join(','),
                ...currentPurchases.map(p => [
                    p.purchase_date,
                    p.platform,
                    p.brand,
                    p.model,
                    p.category || '',
                    p.purchase_price || 0,
                    p.shipping_cost || 0,
                    p.total_paid,
                    p.delivery_status,
                    `"${(p.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stockpilot-purchases-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('üì§ Purchase data exported successfully!', 'success');
        }

        // Initialize Personal AI
        const AI = new PersonalAISmartForm();

        // Add console logging for debugging
        console.log('üîß Enhanced Multi-source email import system loaded');
        console.log('üìß Supported sources: Vinted emails, eBay API, Manual entries');
        console.log('üéØ Features: Source indicators, duplicate detection, enhanced error handling');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            
            // Load purchase history
            loadPurchases();
            
            // Debug AI button functionality
            const modelAIButton = document.querySelector('.ai-suggestion-btn[onclick*="model"]');
            if (modelAIButton) {
                console.log('‚úÖ Model AI button found');
                modelAIButton.addEventListener('click', function() {
                    console.log('ü§ñ AI button clicked for model field');
                });
            } else {
                console.error('‚ùå Model AI button not found');
            }
            
            console.log('‚úÖ Personal AI-Enhanced Purchase Management with Multi-Source Email Import initialized');
        });
    </script>
</body>
</html> #64748b;">|</span>
                            <span>üìä <strong id="selectedCount">0</strong> selected</span>
                            <span style="color: