<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPilot - Sales History</title>
    <style>
        /* Updated View Sales Page - Research-Based Soft Purple Theme */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #8B7EC8 0%, #7B6CB8 100%);
            min-height: 100vh;
        }

        /* Main Container with Integrated Navigation */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(139, 126, 200, 0.15);
            overflow: hidden;
        }

        /* Navigation Tabs - Integrated into container */
        .nav-tabs-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px 0;
            position: relative;
        }

        .nav-tabs-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #8B7EC8;
            z-index: 1;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 2px;
            background: transparent;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .nav-tab {
            background: linear-gradient(135deg, #F5F7FA, #E2E8F0);
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #2D3748;
            font-weight: 500;
            font-size: 13px;
            border-radius: 12px 12px 0 0;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .nav-tab:hover {
            text-decoration: none;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(139, 126, 200, 0.2);
        }

        .nav-tab.active {
            transform: translateY(0);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8);
        }

        .nav-tab.home {
            background: linear-gradient(135deg, #8E9AAE, #718096);
            color: white;
        }

        .nav-tab.purchases {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .nav-tab.inventory {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
        }

        .nav-tab.consumables {
            background: linear-gradient(135deg, #A67C5A, #8B6F3F);
            color: white;
        }

        .nav-tab.log-sale {
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
        }

        .nav-tab.sales {
            background: linear-gradient(135deg, #8B7EC8, #7B6CB8);
            color: white;
        }

        .nav-tab.email-import {
            background: linear-gradient(135deg, #5D6AAF, #4A5A9E);
            color: white;
        }

        .nav-tab.settings {
            background: linear-gradient(135deg, #2D3748, #1A202C);
            color: white;
        }

        /* Content Area */
        .content-area {
            padding: 30px;
            background: #F8FAFC;
        }

        .header {
            text-align: center;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px 10px 30px;
        }

        .header h1 {
            color: #2D3748;
            margin-bottom: 5px;
            font-size: 1.8em;
        }

        .header p {
            margin: 0;
            font-size: 0.9em;
            color: #8E9AAE;
        }

        /* Connection Status */
        .connection-status {
            background: #E3F2FD;
            color: #1565C0;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #BBDEFB;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .connection-status.online {
            background: #E8F5E8;
            color: #2E7D32;
            border-color: #C8E6C9;
        }

        .connection-status.offline {
            background: #FFF3E0;
            color: #EF6C00;
            border-color: #FFCC80;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8B7EC8 0%, #9B8ED1 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(139, 126, 200, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 126, 200, 0.4);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card p {
            margin: 0;
            opacity: 0.9;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        /* Form Sections */
        .form-section {
            background: #FFFFFF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(139, 126, 200, 0.08);
            margin-bottom: 20px;
        }

        .form-section-header {
            background: #2D3748;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .form-section-content {
            padding: 20px;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            background: #FFFFFF;
            color: #2D3748;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #F5F7FA;
            border-color: #8B7EC8;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #8B7EC8 0%, #7B6CB8 100%);
            color: white;
            border-color: #8B7EC8;
        }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: end;
        }

        .search-group {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .search-group .search-box {
            flex: 1;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #4A90E2;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            background: #FFFFFF;
        }

        .search-box:focus {
            outline: none;
            border-color: #8B7EC8;
            box-shadow: 0 0 0 3px rgba(139, 126, 200, 0.1);
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            background: #FFFFFF;
            color: #2D3748;
            font-size: 0.95rem;
            min-width: 150px;
            transition: border-color 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #8B7EC8;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B7EC8 0%, #7B6CB8 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7B6CB8 0%, #6B5CA8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 126, 200, 0.3);
        }

        .btn-success {
            background: #48BB78;
            color: white;
        }

        .btn-success:hover {
            background: #38A169;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        /* Table Styling */
        .table-container {
            background: #FFFFFF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(139, 126, 200, 0.08);
        }

        .table-header {
            background: #2D3748;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
        }

        .table th {
            background: #2D3748;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #E2E8F0;
            color: #2D3748;
        }

        .table tr:hover {
            background: #F5F7FA;
        }

        /* Platform Badges */
        .platform-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .platform-ebay { background: rgba(255, 193, 7, 0.3); color: #B7791F; }
        .platform-facebook { background: rgba(74, 144, 226, 0.3); color: #4A90E2; }
        .platform-vinted { background: rgba(72, 187, 120, 0.3); color: #48BB78; }
        .platform-amazon { background: rgba(237, 137, 54, 0.3); color: #ED8936; }
        .platform-local { background: rgba(142, 154, 174, 0.3); color: #8E9AAE; }
        .platform-gumtree { background: rgba(139, 126, 200, 0.3); color: #8B7EC8; }

        /* Profit Styling */
        .profit-positive {
            color: #48BB78;
            font-weight: 600;
        }

        .profit-negative {
            color: #E53E3E;
            font-weight: 600;
        }

        .profit-neutral {
            color: #8E9AAE;
        }

        .currency {
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .date-cell {
            white-space: nowrap;
            font-size: 0.85rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            background: #FFFFFF;
            color: #2D3748;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .pagination button:hover:not(:disabled) {
            background: #F5F7FA;
            border-color: #8B7EC8;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: #2D3748;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-muted { color: #8E9AAE; }
        .text-danger { color: #E53E3E; }
        .text-primary { color: #4A90E2; }
        .text-warning { color: #ED8936; }
        .text-info { color: #17a2b8; }
        .p-4 { padding: 20px; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8E9AAE;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .nav-tabs-container {
                padding: 10px 15px 0;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-group {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tab {
                font-size: 11px;
                padding: 10px 12px;
                min-width: 70px;
            }

            .quick-filters {
                justify-content: center;
            }
        }
    </style>
    <script src="js/stockpilot-api.js"></script>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="header">
            <h1>&#128200; StockPilot Sales History</h1>
            <p>Track your sales performance and profits</p>
        </div>

        <!-- Navigation Tabs - REORDERED TO MATCH OTHER PAGES -->
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <a href="/" class="nav-tab home">
                    &#127968; Home
                </a>
                <a href="view-purchases.html" class="nav-tab purchases">
                    &#128722; Purchases
                </a>
                <a href="view-inventory.html" class="nav-tab inventory">
                    &#128230; Inventory
                </a>
                <a href="view-consumables.html" class="nav-tab consumables">
                    &#129520; Consumables
                </a>
                <a href="log-sale.html" class="nav-tab log-sale">
                    &#128176; Log Sale
                </a>
                <a href="view-sales.html" class="nav-tab sales active">
                    &#128200; View Sales
                </a>
                <a href="email-import.html" class="nav-tab email-import">
                    &#128231; Email Import
                </a>
                <a href="reports.html" class="nav-link">?? Reports</a>
                    <a href="settings.html" class="nav-tab settings">
                    &#128295; Settings
                </a>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Connection Status -->
            <div id="connectionStatus" class="connection-status">
                <span>??</span> Checking connection...
            </div>

            <!-- Statistics Dashboard -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3 id="totalRevenue">-</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalProfit">-</h3>
                    <p>Total Profit</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSales">-</h3>
                    <p>Total Sales</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgProfit">-</h3>
                    <p>Avg Profit</p>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="form-section">
                <div class="form-section-header">
                    &#128269; Filter & Search
                </div>
                <div class="form-section-content">
                    <!-- Quick Filters -->
                    <div class="quick-filters">
                        <div class="filter-btn active" data-filter="all">All Sales</div>
                        <div class="filter-btn" data-filter="this-month">This Month</div>
                        <div class="filter-btn" data-filter="last-month">Last Month</div>
                        <div class="filter-btn" data-filter="this-year">This Year</div>
                        <div class="filter-btn" data-filter="profitable">Profitable Only</div>
                    </div>
                    
                    <!-- Search and Action Controls -->
                    <div class="controls-grid">
                        <div class="search-group">
                            <input type="text" class="search-box" id="searchInput" placeholder="&#128269; Search by item, platform, or description...">
<select id="platformFilter" class="form-control">
    <option value="">Loading...</option>
</select>
<script>
// Dynamic loading for platform dropdown: platformFilter
document.addEventListener('DOMContentLoaded', async function() {
    const selectElement = document.getElementById('platformFilter');
    if (selectElement) {
        try {
            console.log('Loading platform options for #platformFilter...');
            
            selectElement.innerHTML = '<option value="">Loading...</option>';
            selectElement.disabled = true;
            
            const options = await stockpilotAPI.getPlatformOptions();
            
            selectElement.innerHTML = '<option value="">Select platform...</option>';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.key;
                optionElement.textContent = option.displayName;
                selectElement.appendChild(optionElement);
            });
            
            selectElement.disabled = false;
            console.log('Loaded platform options:', options.length);
            
        } catch (error) {
            console.error('Failed to load platform options:', error);
            selectElement.innerHTML = '<option value="">Error loading options</option>';
            selectElement.disabled = false;
        }
    }
});
</script>
                        </div>
                        <button class="btn btn-primary" onclick="exportToCSV()">&#128229; Export CSV</button>
                        <button class="btn btn-success" onclick="refreshData()">&#128260; Refresh</button>
                    </div>
                </div>
            </div>

            <!-- Sales Table -->
            <div class="table-container">
                <div class="table-header">
                    &#128200; Sales Data
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Platform</th>
                                <th>Item</th>
                                <th>Sale Price</th>
                                <th>Fees</th>
                                <th>Postage</th>
                                <th>Net Profit</th>
                                <th>Margin</th>
                                <th>Inventory</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted p-4 loading">&#128260; Loading sales data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prevBtn" onclick="changePage(-1)">&#8592; Previous</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button id="nextBtn" onclick="changePage(1)">Next &#8594;</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let salesData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentFilter = 'all';
        let salesAPIAvailable = false;

        const API_CONFIG = {
            sales: '/api/sales'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('?? StockPilot Sales History initialized');
            checkAPIs();
            loadSalesData();
            setupEventListeners();
        });

        async function checkAPIs() {
            try {
                const response = await fetch('/api/sales/test/ping');
                if (response.ok) {
                    salesAPIAvailable = true;
                    updateConnectionStatus(true);
                    console.log('? Sales API available');
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                salesAPIAvailable = false;
                updateConnectionStatus(false);
                console.log('?? Sales API not available:', error.message);
            }
        }

        function updateConnectionStatus(online) {
            const statusEl = document.getElementById('connectionStatus');
            if (online) {
                statusEl.className = 'connection-status online';
                statusEl.innerHTML = '<span>?</span> Connected to API - Real-time data available';
            } else {
                statusEl.className = 'connection-status offline';
                statusEl.innerHTML = '<span>??</span> Offline mode - Using local storage data';
            }
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterAndDisplayData);
            document.getElementById('platformFilter').addEventListener('change', filterAndDisplayData);

            // Quick filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterAndDisplayData();
                });
            });
        }

        async function loadSalesData() {
            try {
                console.log('?? Loading sales data...');
                showLoading(true);

                // Try API first if available
                if (salesAPIAvailable) {
                    try {
                        const response = await fetch(API_CONFIG.sales);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('? Loaded from API:', data.length, 'sales');
                            salesData = data;
                            // Save to localStorage as backup
                            localStorage.setItem('stockpilot_sales', JSON.stringify(data));
                            updateStatistics();
                            filterAndDisplayData();
                            return;
                        }
                    } catch (apiError) {
                        console.log('API failed, falling back to localStorage');
                    }
                }

                // Fallback to localStorage
                const stored = localStorage.getItem('stockpilot_sales');
                if (stored) {
                    salesData = JSON.parse(stored);
                    console.log('? Loaded from localStorage:', salesData.length, 'sales');
                    updateStatistics();
                    filterAndDisplayData();
                } else {
                    salesData = [];
                    updateStatistics();
                    filterAndDisplayData();
                }
            } catch (error) {
                console.error('Error loading sales:', error);
                document.getElementById('salesTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger p-4">&#10060; Error loading sales data</td></tr>';
            }
        }

        function showLoading(show) {
            if (show) {
                document.getElementById('salesTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-muted p-4 loading">&#128260; Loading sales data...</td></tr>';
            }
        }

        function updateStatistics() {
            const totalRevenue = salesData.reduce((sum, sale) => sum + (parseFloat(sale.sale_price) || 0), 0);
            const totalProfit = salesData.reduce((sum, sale) => sum + (parseFloat(sale.net_profit) || 0), 0);
            const totalSales = salesData.length;
            const avgProfit = totalSales > 0 ? totalProfit / totalSales : 0;

            document.getElementById('totalRevenue').textContent = `£${totalRevenue.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `£${totalProfit.toFixed(2)}`;
            document.getElementById('totalSales').textContent = totalSales.toString();
            document.getElementById('avgProfit').textContent = `£${avgProfit.toFixed(2)}`;
        }

        function filterAndDisplayData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const platformFilter = document.getElementById('platformFilter').value;

            filteredData = salesData.filter(sale => {
                // Search filter
                const matchesSearch = 
                    (sale.item_description && sale.item_description.toLowerCase().includes(searchTerm)) ||
                    (sale.platform && sale.platform.toLowerCase().includes(searchTerm)) ||
                    (sale.id && sale.id.toString().includes(searchTerm));

                // Platform filter
                const matchesPlatform = !platformFilter || sale.platform === platformFilter;

                // Date/profit filters
                const matchesTimeFilter = applyTimeFilter(sale, currentFilter);

                return matchesSearch && matchesPlatform && matchesTimeFilter;
            });

            currentPage = 1;
            displayCurrentPage();
        }

        function applyTimeFilter(sale, filter) {
            if (!sale.sale_date) return true;
            
            const saleDate = new Date(sale.sale_date);
            const now = new Date();
            
            switch (filter) {
                case 'this-month':
                    return saleDate.getMonth() === now.getMonth() && 
                           saleDate.getFullYear() === now.getFullYear();
                case 'last-month':
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    return saleDate.getMonth() === lastMonth.getMonth() && 
                           saleDate.getFullYear() === lastMonth.getFullYear();
                case 'this-year':
                    return saleDate.getFullYear() === now.getFullYear();
                case 'profitable':
                    return (parseFloat(sale.net_profit) || 0) > 0;
                default:
                    return true;
            }
        }

        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('salesTableBody');
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted p-4">&#128237; No sales found</td></tr>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            tbody.innerHTML = pageData.map(sale => {
                const saleDate = sale.sale_date ? new Date(sale.sale_date).toLocaleDateString('en-GB') : 'N/A';
                const platform = sale.platform || 'Unknown';
                const platformClass = `platform-${platform.toLowerCase().replace(/\s+/g, '')}`;
                
                const salePrice = parseFloat(sale.sale_price) || 0;
                const netProfit = parseFloat(sale.net_profit) || 0;
                const profitMargin = salePrice > 0 ? (netProfit / salePrice) * 100 : 0;
                
                const profitClass = netProfit > 0 ? 'profit-positive' : 
                                   netProfit < 0 ? 'profit-negative' : 'profit-neutral';

                const postageProfit = (parseFloat(sale.postage_charged) || 0) - (parseFloat(sale.postage_cost) || 0);

                return `
                    <tr>
                        <td class="date-cell">${saleDate}</td>
                        <td><span class="platform-badge ${platformClass}">${platform}</span></td>
                        <td>${sale.item_description || 'N/A'}</td>
                        <td class="currency text-primary">£${salePrice.toFixed(2)}</td>
                        <td class="currency text-warning">£${(parseFloat(sale.fees) || 0).toFixed(2)}</td>
                        <td class="currency text-info">£${postageProfit.toFixed(2)}</td>
                        <td class="currency ${profitClass}">£${netProfit.toFixed(2)}</td>
                        <td class="${profitClass}">${profitMargin.toFixed(1)}%</td>
                        <td class="text-muted">${sale.inventory_item_id ? `#${sale.inventory_item_id}` : '-'}</td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCurrentPage();
            }
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Platform', 'Item Description', 'Sale Price', 'Fees', 'Postage Charged', 'Postage Cost', 'Net Profit', 'Margin %', 'Inventory Item ID'];
            
            const csvContent = [
                headers.join(','),
                ...filteredData.map(sale => [
                    sale.sale_date ? new Date(sale.sale_date).toLocaleDateString('en-GB') : '',
                    `"${sale.platform || ''}"`,
                    `"${(sale.item_description || '').replace(/"/g, '""')}"`,
                    parseFloat(sale.sale_price) || 0,
                    parseFloat(sale.fees) || 0,
                    parseFloat(sale.postage_charged) || 0,
                    parseFloat(sale.postage_cost) || 0,
                    parseFloat(sale.net_profit) || 0,
                    sale.sale_price > 0 ? (((parseFloat(sale.net_profit) || 0) / parseFloat(sale.sale_price)) * 100).toFixed(1) : 0,
                    sale.inventory_item_id || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stockpilot-sales-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function refreshData() {
            loadSalesData();
        }
    </script>

<script>
// Dynamic data initialization - Added by Phase 3 optimization
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Initializing dynamic data loading...');
    
    try {
        // Initialize performance monitoring
        const startTime = performance.now();
        
        // Load dynamic data if static arrays were replaced
        
        // Performance metrics
        const loadTime = performance.now() - startTime;
        console.log(✅ Dynamic data initialization completed in ms);
        
        // Trigger custom event for other scripts
        document.dispatchEvent(new CustomEvent('stockpilotDataLoaded', {
            detail: { loadTime: loadTime }
        }));
        
    } catch (error) {
        console.error('❌ Dynamic data initialization failed:', error);
    }
});

// Helper function to refresh all dynamic data
async function refreshDynamicData() {
    console.log('🔄 Refreshing dynamic data...');
    
    // Clear API cache
    if (window.stockpilotAPI) {
        window.stockpilotAPI.clearCache();
    }
    
    // Reload page to refresh everything
    location.reload();
}

// Add refresh button for development (remove in production)
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    document.addEventListener('DOMContentLoaded', function() {
        const refreshBtn = document.createElement('button');
        refreshBtn.textContent = '🔄 Refresh Data';
        refreshBtn.style.position = 'fixed';
        refreshBtn.style.top = '10px';
        refreshBtn.style.right = '10px';
        refreshBtn.style.zIndex = '9999';
        refreshBtn.style.background = '#007bff';
        refreshBtn.style.color = 'white';
        refreshBtn.style.border = 'none';
        refreshBtn.style.padding = '5px 10px';
        refreshBtn.style.borderRadius = '3px';
        refreshBtn.style.fontSize = '12px';
        refreshBtn.title = 'Refresh dynamic data (dev mode)';
        refreshBtn.onclick = refreshDynamicData;
        document.body.appendChild(refreshBtn);
    });
}
</script>
</body>
</html>



