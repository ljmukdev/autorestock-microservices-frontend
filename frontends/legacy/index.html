<!--
FILE: index.html
LOCATION: /frontend/index.html
DESCRIPTION: AutoRestock Dashboard Homepage - Fixed status bar border from green to blue
CHANGES: 
- Line ~44 - Changed .nav-tabs-container::after background from #67B292 (green) to #1a365d (blue)
- Line ~181 - Changed .status-bar-enhanced border from #67B292 (green) to #1a365d (blue)
- Line ~188 - Changed box-shadow color from rgba(103, 178, 146, 0.1) to rgba(26, 54, 93, 0.1)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoRestock - Dashboard</title>
    <style>
        /* Updated color scheme to match the new logo */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            min-height: 100vh;
        }

        /* Main Container with updated shadow */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(26, 54, 93, 0.15);
            overflow: hidden;
        }

        /* Navigation Tabs - FIXED: Changed from green (#67B292) to blue (#1a365d) */
        .nav-tabs-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #1a365d;
            z-index: 1;
        }

        .nav-tab.home {
            background: linear-gradient(135deg, #1a365d, #2c5282);
            color: white;
        }

        .nav-tab.purchases {
            background: linear-gradient(135deg, #67B292, #5A9B7F);
            color: white;
        }

        .nav-tab.inventory {
            background: linear-gradient(135deg, #3182CE, #2C5282);
            color: white;
        }

        .nav-tab.consumables {
            background: linear-gradient(135deg, #38A169, #2F855A);
            color: white;
        }

        .nav-tab.log-sale {
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
        }

        .nav-tab.sales {
            background: linear-gradient(135deg, #805AD5, #6B46C1);
            color: white;
        }

        .nav-tab.email-import {
            background: linear-gradient(135deg, #3182CE, #2B6CB0);
            color: white;
        }

        .nav-tab.reports {
            background: linear-gradient(135deg, #667EEA, #5A67D8);
            color: white;
        }

        .nav-tab.settings {
            background: linear-gradient(135deg, #2D3748, #1A202C);
            color: white;
        }

        /* Navigation Tabs - updated to match logo colors */
        .nav-tabs-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 25px 0;
            position: relative;
        }

        .nav-tabs {
            display: flex;
            gap: 2px;
            background: transparent;
            padding: 0;
            margin: 0;
            list-style: none;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .nav-tab {
            background: linear-gradient(135deg, #F5F7FA, #E2E8F0);
            border: none;
            padding: 10px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #2D3748;
            font-weight: 500;
            font-size: 11px;
            border-radius: 12px 12px 0 0;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
        }

        .nav-tab:hover {
            text-decoration: none;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 54, 93, 0.2);
        }

        .nav-tab.active {
            transform: translateY(0);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8);
        }

        /* Content Area */
        .content-area {
            padding: 8px 25px 25px 25px;
            background: #F8FAFC;
        }

        /* Header styling for logo left, title centered */
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 25px 24px 25px;
            position: relative;
        }

        .header-logo {
            height: 80px;
            position: absolute;
            left: 25px;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: #1a365d;
            margin: 0;
            font-size: 1.8em;
        }

        .header p {
            margin: 0;
            font-size: 0.9em;
            color: #1a365d;
        }

        /* Dashboard specific styles - FIXED: Changed border and shadow colors from green to blue */
        .status-bar-enhanced {
            background: white;
            color: #1a365d;
            padding: 16px 20px;
            border-radius: 12px;
            margin: 5px 0;
            border: 2px solid #1a365d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(26, 54, 93, 0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .quick-actions-dashboard {
            background: linear-gradient(135deg, #2c5282, #1a365d);
            color: white;
            padding: 16px;
            margin: 12px 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.2);
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .quick-action-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .quick-action-item h4 {
            margin: 0 0 4px 0;
            font-size: 12px;
            font-weight: 600;
        }
        
        .quick-action-item p {
            margin: 0;
            font-size: 10px;
            opacity: 0.9;
            line-height: 1.3;
        }

        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin: 5px 0;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(26, 54, 93, 0.08);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #E6FFFA;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: #1a365d;
        }
        
        .activity-text {
            flex: 1;
            font-size: 12px;
            color: #1a365d;
        }
        
        .activity-time {
            font-size: 10px;
            color: #67B292;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: " (Loading...)";
            font-style: italic;
            opacity: 0.7;
        }

        /* Offline indicator */
        .offline {
            background: #ff6b6b !important;
            color: white !important;
        }

        .offline .status-item {
            color: white;
        }

        @media (max-width: 1200px) {
            .nav-tab {
                font-size: 10px;
                padding: 14px 8px;
                gap: 3px;
            }
            
            .content-area {
                padding: 15px 30px 30px 30px;
            }
            
            .header {
                padding: 20px 30px 15px 30px;
            }
            
            .nav-tabs-container {
                padding: 15px 30px 0;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .nav-tabs-container {
                padding: 15px 20px 0;
            }
            
            .content-area {
                padding: 25px;
            }
            
            .header {
                padding: 20px 25px 15px 25px;
            }
            
            .nav-tab {
                font-size: 9px;
                padding: 12px 6px;
                gap: 2px;
                min-width: 60px;
            }
            
            .quick-actions-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .status-bar-enhanced {
                padding: 16px 20px;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .nav-tab {
                font-size: 8px;
                padding: 10px 4px;
                flex-direction: column;
                gap: 1px;
                min-width: 45px;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .header {
                padding: 15px 20px 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header - logo on left with icon and text -->
        <div class="header">
            <img src="images/autorestock-logo.png" alt="AutoRestock Logo" class="header-logo">
            <div class="header-text">
				<h1>🏠 Inventory Dashboard</h1>
					<p>Your complete business overview and control center</p>
			</div>
        </div>

        <!-- Navigation Tabs - exactly like view-inventory.html -->
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab home active">
                    🏠 Home
                </a>
                <a href="view-purchases.html" class="nav-tab purchases">
                    🛒 Purchases
                </a>
                <a href="view-inventory.html" class="nav-tab inventory">
                    📦 Inventory
                </a>
                <a href="view-consumables.html" class="nav-tab consumables">
                    🧰 Consumables
                </a>
                <a href="log-sale.html" class="nav-tab log-sale">
                    💰 Log Sale
                </a>
                <a href="view-sales.html" class="nav-tab sales">
                    📊 View Sales
                </a>
                <a href="email-import.html" class="nav-tab email-import">
                    📧 Email Import
                </a>
                <a href="reports.html" class="nav-tab reports">
                    📈 Reports
                </a>
                <a href="settings.html" class="nav-tab settings">
                    ⚙️ Settings
                </a>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Enhanced Status Bar with all metrics -->
            <div class="status-bar-enhanced" id="status-bar">
                <div class="status-item">
                    <span>✅</span>
                    <span>Server online</span>
                </div>
                <div class="status-item">
                    <span>🔄</span>
                    <span>Last sync: <span id="last-sync">checking...</span></span>
                </div>
                <div class="status-item">
                    <span>💰</span>
                    <span>Investment: <span id="status-total-investment">£0.00</span></span>
                </div>
                <div class="status-item">
                    <span>📦</span>
                    <span><span id="status-item-count">0</span> items tracked</span>
                </div>
                <div class="status-item">
                    <span>📈</span>
                    <span><span id="status-sales-today">0</span> sales today</span>
                </div>
                <div class="status-item">
                    <span>📊</span>
                    <span><span id="status-profit-margin">+0%</span> margin</span>
                </div>
            </div>

            <!-- Quick Actions Dashboard -->
            <div class="quick-actions-dashboard">
                <h3 style="margin: 0 0 8px 0; font-size: 14px;">📊 Today's Priority Actions</h3>
                <div class="quick-actions-grid">
                    <div class="quick-action-item" onclick="navigateToEmailImport()">
                        <h4>📧 Pending Imports</h4>
                        <p><span id="pending-imports">1</span> Vinted email ready for processing</p>
                    </div>
                    <div class="quick-action-item" onclick="navigateToSales()">
                        <h4>📈 Today's Sales</h4>
                        <p><span id="quick-sales">0</span> sales completed • £<span id="quick-revenue">0.00</span> revenue</p>
                    </div>
                    <div class="quick-action-item" onclick="navigateToInventory()">
                        <h4>⚠️ Low Stock</h4>
                        <p><span id="low-stock">No</span> items below threshold</p>
                    </div>
                    <div class="quick-action-item" onclick="navigateToLogSale()">
                        <h4>🎯 Quick Actions</h4>
                        <p>Ready to add purchase or log sale</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h3 style="margin: 0 0 8px 0; color: #1a365d; font-size: 13px;">📋 Recent Activity</h3>
                <div id="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon">🔄</div>
                        <div class="activity-text">Loading recent activity...</div>
                        <div class="activity-time">now</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functions
        function navigateToEmailImport() {
            window.location.href = 'email-import.html';
        }

        function navigateToSales() {
            window.location.href = 'view-sales.html';
        }

        function navigateToInventory() {
            window.location.href = 'view-inventory.html';
        }

        function navigateToLogSale() {
            window.location.href = 'log-sale.html';
        }

        // Enhanced server status check
        function checkServerStatus() {
            fetch('/test')
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Server connection successful');
                    updateLastSync();
                    loadDashboardData();
                })
                .catch(error => {
                    console.log('❌ Server connection failed');
                    const statusBar = document.getElementById('status-bar');
                    if (statusBar) {
                        statusBar.classList.add('offline');
                        statusBar.innerHTML = `
                            <div class="status-item">
                                <span>❌</span>
                                <span>Server offline - using cached data</span>
                            </div>
                        `;
                    }
                });
        }

        // FIXED: Enhanced dashboard data loading with correct field mapping
        function loadDashboardData() {
            console.log('📊 Loading dashboard data...');
            
            fetch('/api/dashboard/summary')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Dashboard data loaded:', data);
                    updateDashboardMetrics(data);
                })
                .catch(error => {
                    console.log('⚠️ Using default dashboard values - backend error:', error.message);
                    // Keep the current placeholder values
                });
        }

        // FIXED: Correct field mapping for API response
        function updateDashboardMetrics(data) {
            console.log('🔄 Updating dashboard with data:', data);
            
            // Update financial metrics - convert strings to numbers and format correctly
            if (data.totalInvestment !== undefined) {
                const investment = parseFloat(data.totalInvestment);
                document.getElementById('status-total-investment').textContent = `£${investment.toFixed(2)}`;
                console.log('💰 Updated investment:', `£${investment.toFixed(2)}`);
            }
            
            // Update inventory metrics
            if (data.inventoryCount !== undefined) {
                document.getElementById('status-item-count').textContent = data.inventoryCount;
                console.log('📦 Updated inventory count:', data.inventoryCount);
            }
            
            // Update sales metrics - use correct field names from API
            if (data.salesToday !== undefined) {
                document.getElementById('status-sales-today').textContent = data.salesToday;
                document.getElementById('quick-sales').textContent = data.salesToday;
                console.log('📈 Updated sales today:', data.salesToday);
            }
            
            if (data.dailyRevenue !== undefined) {
                const dailyRev = parseFloat(data.dailyRevenue);
                document.getElementById('quick-revenue').textContent = dailyRev.toFixed(2);
                console.log('💷 Updated daily revenue:', dailyRev.toFixed(2));
            }
            
            // Update profit margin - convert string to number
            if (data.profitMargin !== undefined) {
                const margin = parseFloat(data.profitMargin);
                const marginText = `${margin > 0 ? '+' : ''}${margin.toFixed(1)}%`;
                document.getElementById('status-profit-margin').textContent = marginText;
                console.log('📊 Updated profit margin:', marginText);
            }
            
            // Update pending imports
            if (data.pendingImports !== undefined) {
                document.getElementById('pending-imports').textContent = data.pendingImports;
                const importText = data.pendingImports === 1 ? 'email' : 'emails';
                const pendingImportCard = document.querySelector('.quick-action-item:first-child p');
                if (pendingImportCard) {
                    pendingImportCard.innerHTML = `<span id="pending-imports">${data.pendingImports}</span> Vinted ${importText} ready for processing`;
                }
                console.log('📧 Updated pending imports:', data.pendingImports);
            }
            
            // Update low stock
            if (data.lowStockCount !== undefined) {
                const lowStockEl = document.getElementById('low-stock');
                if (lowStockEl) {
                    if (data.lowStockCount > 0) {
                        lowStockEl.textContent = `${data.lowStockCount}`;
                        const lowStockCard = lowStockEl.closest('.quick-action-item').querySelector('p');
                        if (lowStockCard) {
                            lowStockCard.innerHTML = `<span id="low-stock">${data.lowStockCount}</span> item${data.lowStockCount !== 1 ? 's' : ''} below threshold`;
                        }
                    } else {
                        lowStockEl.textContent = 'No';
                    }
                    console.log('⚠️ Updated low stock:', data.lowStockCount);
                }
            }
            
            console.log('✅ All dashboard metrics updated successfully');
        }

        function updateLastSync() {
            const now = new Date();
            const syncEl = document.getElementById('last-sync');
            if (syncEl) {
                syncEl.textContent = 'just now';
                
                // Update sync time every minute
                const updateInterval = setInterval(() => {
                    const elapsed = Math.floor((new Date() - now) / 60000);
                    if (elapsed === 0) {
                        syncEl.textContent = 'just now';
                    } else if (elapsed === 1) {
                        syncEl.textContent = '1 min ago';
                    } else if (elapsed < 60) {
                        syncEl.textContent = `${elapsed} min ago`;
                    } else {
                        syncEl.textContent = `${Math.floor(elapsed / 60)} hr ago`;
                    }
                }, 60000);
            }
        }

        // FIXED: Get real-time recent activity directly from purchases API
        function updateRecentActivity() {
            console.log('📋 Loading real-time recent activity...');
            
            // Get fresh data directly from purchases API
            fetch('/api/purchases')
                .then(response => {
                    if (!response.ok) throw new Error(`Purchases API error: ${response.status}`);
                    return response.json();
                })
                .then(purchases => {
                    console.log('📋 Fresh purchases data received:', purchases.length, 'purchases');
                    
                    if (purchases && purchases.length > 0) {
                        // Sort by purchase_date descending (newest first) and take top 5
                        const recentPurchases = purchases
                            .sort((a, b) => new Date(b.purchase_date || b.created_at) - new Date(a.purchase_date || a.created_at))
                            .slice(0, 5);
                        
                        const activityList = document.getElementById('activity-list');
                        if (activityList) {
                            const activityHTML = recentPurchases.map(purchase => {
                                const date = new Date(purchase.purchase_date || purchase.created_at);
                                const timeAgo = getTimeAgo(date);
                                const description = `${purchase.brand || 'Unknown'} ${purchase.model || 'Item'} - £${(purchase.total_paid || 0).toFixed(2)}`;
                                
                                return `
                                    <div class="activity-item">
                                        <div class="activity-icon">🛒</div>
                                        <div class="activity-text">Purchase recorded: ${description}</div>
                                        <div class="activity-time">${timeAgo}</div>
                                    </div>
                                `;
                            }).join('');
                            
                            activityList.innerHTML = activityHTML;
                            console.log(`✅ Updated activity with ${recentPurchases.length} recent purchases`);
                        }
                    } else {
                        console.log('⚠️ No purchases found');
                        const activityList = document.getElementById('activity-list');
                        if (activityList) {
                            activityList.innerHTML = `
                                <div class="activity-item">
                                    <div class="activity-icon">📭</div>
                                    <div class="activity-text">No recent purchases</div>
                                    <div class="activity-time">-</div>
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading recent activity:', error);
                    
                    // Fallback to dashboard summary as backup
                    console.log('📋 Falling back to dashboard summary data...');
                    fetch('/api/dashboard/summary')
                        .then(response => response.json())
                        .then(dashData => {
                            if (dashData.recentPurchases && dashData.recentPurchases.length > 0) {
                                const activityList = document.getElementById('activity-list');
                                if (activityList) {
                                    const activityHTML = dashData.recentPurchases.map(item => {
                                        const date = new Date(item.date);
                                        const timeAgo = getTimeAgo(date);
                                        const icon = item.type === 'purchase' ? '🛒' : '💰';
                                        return `
                                            <div class="activity-item">
                                                <div class="activity-icon">${icon}</div>
                                                <div class="activity-text">${item.description}</div>
                                                <div class="activity-time">${timeAgo}</div>
                                            </div>
                                        `;
                                    }).join('');
                                    
                                    activityList.innerHTML = activityHTML;
                                    console.log(`✅ Fallback: Updated activity from dashboard data with ${dashData.recentPurchases.length} items`);
                                }
                            }
                        })
                        .catch(err => {
                            console.error('❌ All activity loading failed:', err);
                            const activityList = document.getElementById('activity-list');
                            if (activityList) {
                                activityList.innerHTML = `
                                    <div class="activity-item">
                                        <div class="activity-icon">❌</div>
                                        <div class="activity-text">Error loading activity data</div>
                                        <div class="activity-time">-</div>
                                    </div>
                                `;
                            }
                        });
                });
        }

        // Helper function to format time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'today';
            if (diffDays === 1) return '1 day ago';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            // Refresh dashboard data every 5 minutes
            setInterval(loadDashboardData, 5 * 60 * 1000);
            
            // Refresh activity every 2 minutes
            setInterval(updateRecentActivity, 2 * 60 * 1000);
            
            // Check server status every 30 seconds
            setInterval(checkServerStatus, 30 * 1000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard initializing...');
            
            // Add click effects to action cards
            const navCards = document.querySelectorAll('.quick-action-item');
            navCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    this.style.opacity = '0.7';
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.opacity = '';
                        this.style.transform = '';
                    }, 150);
                });
            });

            // Initial load
            checkServerStatus();
            updateRecentActivity();
            
            // Start auto-refresh
            startAutoRefresh();
            
            console.log('✅ Dashboard initialized successfully');
        });
    </script>
</body>
</html>